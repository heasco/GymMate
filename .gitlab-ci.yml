image: alpine:latest

stages:
  - deploy

pages:
  stage: deploy
  variables:
    CACHE_BUSTER: $(date +%s)  # Cache invalidation variable
  cache:
    paths:
      - public
    policy: push  # Only upload cache, don't download
  before_script:
    - echo "Preparing deployment..."
    - mkdir -p public
    - echo "Current directory structure:"
    - ls -la
  script:
    # Copy HTML files
    - echo "Copying HTML files..."
    - find . -maxdepth 1 -name '*.html' -exec cp -v {} public/ \;
    
    # Copy CSS files
    - echo "Copying CSS files..."
    - find . -maxdepth 1 -name '*.css' -exec cp -v {} public/ \;
    
    # Copy JS files
    - echo "Copying JavaScript files..."
    - find . -maxdepth 1 -name '*.js' -exec cp -v {} public/ \;
    
    # Copy images directory if it exists
    - echo "Copying images..."
    - if [ -d images ]; then
        cp -rv images public/;
      else
        echo "No images directory found";
      fi

    # Create CNAME file for cache invalidation
    - echo "${CI_PAGES_URL}" > public/CNAME

    # Verify copied files
    - echo "Final public directory contents:"
    - ls -la public/
    - echo "https://${CI_PROJECT_NAMESPACE}.gitlab.io/${CI_PROJECT_NAME}" > public/CNAME
  artifacts:
    paths:
      - public
    expire_in: 1 week
  only:
    - master  # Change to your default branch name if different