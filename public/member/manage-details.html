<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manage Members - GOALS Gym</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding: 20px; background:#f7f7f7; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
    .topbar h1 { margin:0; font-size:20px; }
    .btn { padding:8px 12px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; }
    .btn.primary { background:#2f80ed; color:#fff; border-color:#2f80ed; }
    .btn.danger { background:#fff; border-color:#e57373; color:#c62828; }
    table { width:100%; border-collapse:collapse; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
    th, td { padding:10px 12px; text-align:left; border-bottom:1px solid #eee; }
    th { background:#fafafa; font-weight:600; }
    .actions button { margin-right:6px; }
    .muted { color:#666; font-size:13px; }
    #status { margin-bottom:12px; color:#333; }
    .center { text-align:center; padding:24px; color:#666; }
    .search { margin-bottom:12px; display:flex; gap:8px; }
    input[type="search"] { padding:8px 10px; border-radius:6px; border:1px solid #ccc; flex:1; }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>Manage Members</h1>
    <div>
      <button class="btn" id="backBtn">← Back</button>
      <button class="btn primary" id="refreshBtn">Refresh</button>
    </div>
  </div>

  <div id="status" class="muted">Loading members…</div>

  <div class="search">
    <input id="searchInput" type="search" placeholder="Search by name or membership type..." />
    <button class="btn" id="clearSearch">Clear</button>
  </div>

  <div id="tableContainer">
    <!-- Table inserted here -->
  </div>

  <script>
    // Update this if your API base is different. Matches pattern used in other files.
    const API_URL = 'https://flex-it-goalsgym-it-project-2.onrender.com';

    document.getElementById('backBtn').addEventListener('click', () => {
      window.location.href = './admin-mainpage.html';
    });
    document.getElementById('refreshBtn').addEventListener('click', loadMembers);
    document.getElementById('clearSearch').addEventListener('click', () => {
      document.getElementById('searchInput').value = '';
      renderMembers(currentMembers);
    });
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const q = e.target.value.trim().toLowerCase();
      if (!q) return renderMembers(currentMembers);
      const filtered = currentMembers.filter(m => {
        const name = (m.name || m.fullname || (m.firstName && m.lastName && (m.firstName + ' ' + m.lastName)) || '').toString().toLowerCase();
        const membership = (m.membership_type || m.membership || m.type || '').toString().toLowerCase();
        return name.includes(q) || membership.includes(q);
      });
      renderMembers(filtered);
    });

    let currentMembers = [];

    async function loadMembers() {
      const status = document.getElementById('status');
      status.textContent = 'Loading members…';
      try {
        // Primary attempt: /api/members (common REST pattern)
        let res = await fetch(`${API_URL}/api/members`);
        let json;
        if (res.ok) {
          json = await res.json();
        } else {
          // Try direct /members as fallback
          res = await fetch(`${API_URL}/members`);
          json = res.ok ? await res.json() : null;
        }

        // Accept a couple of shapes: { success: true, data: [...] } or [...] directly
        const arr = (json && json.data) ? json.data : (Array.isArray(json) ? json : null);

        if (arr && arr.length >= 0) {
          currentMembers = arr;
          renderMembers(currentMembers);
          status.textContent = `Loaded ${arr.length} member(s).`;
        } else {
          // If API didn't return expected data, show info and a mock example
          status.textContent = 'No members found from the server. Showing sample data for UI testing.';
          currentMembers = sampleData();
          renderMembers(currentMembers);
        }
      } catch (err) {
        console.error('Member load error', err);
        document.getElementById('status').textContent = 'Cannot reach server — showing sample data.';
        currentMembers = sampleData();
        renderMembers(currentMembers);
      }
    }

    function sampleData() {
      return [
        { id: 'm001', name: 'Juan Dela Cruz', date_enrolled: '2025-06-12', membership_type: 'Monthly' },
        { id: 'm002', name: 'Anna Santos', date_enrolled: '2025-07-01', membership_type: 'Yearly' },
        { id: 'm003', name: 'Mark Reyes', date_enrolled: '2025-08-20', membership_type: 'Trial (7 days)' }
      ];
    }

    function formatDate(dateVal) {
      if (!dateVal) return '-';
      const d = new Date(dateVal);
      if (isNaN(d)) return dateVal; // if already formatted string
      return d.toLocaleDateString();
    }

    function renderMembers(list) {
      const container = document.getElementById('tableContainer');
      if (!list || list.length === 0) {
        container.innerHTML = '<div class="center">No members to show.</div>';
        return;
      }

      let html = '<table><thead><tr><th>Name</th><th>Date Enrolled</th><th>Membership</th><th>Actions</th></tr></thead><tbody>';
      list.forEach(m => {
        const name = m.name || m.fullname || ((m.firstName && m.lastName) ? m.firstName + ' ' + m.lastName : 'Unknown');
        const date = m.date_enrolled || m.enrolled_at || m.date || '';
        const membership = m.membership_type || m.membership || m.type || '-';
        html += `<tr>
                  <td>${escapeHtml(name)}</td>
                  <td>${escapeHtml(formatDate(date))}</td>
                  <td>${escapeHtml(membership)}</td>
                  <td class="actions">
                    <button class="btn" data-id="${escapeHtml(m.id || m._id || '')}" onclick="onUpdate(this)">Update</button>
                    <button class="btn danger" data-id="${escapeHtml(m.id || m._id || '')}" onclick="onArchive(this)">Archive</button>
                  </td>
                </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // Buttons are UI-only for now (no backend calls)
    function onUpdate(btn) {
      const id = btn.getAttribute('data-id');
      alert('Update clicked for member id: ' + id + '\n(Implement update modal/form later)');
    }

    function onArchive(btn) {
      const id = btn.getAttribute('data-id');
      const ok = confirm('Archive this member? (UI only; no server call yet)');
      if (ok) {
        alert('Member ' + id + ' would be archived (implement server call later).');
      }
    }

    // small helper to avoid naive injection in innerHTML
    function escapeHtml(s) {
      if (s === null || s === undefined) return '';
      return s.toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // load once page is ready
    document.addEventListener('DOMContentLoaded', loadMembers);
  </script>
</body>
</html>
