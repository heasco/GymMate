<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Classes - GOALS Gym</title>
    <link rel="stylesheet" href="./admin-css/admin-mainpage.css">
    <link rel="stylesheet" href="./admin-css/view-classes-and-feedback.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>GOALS Gym Admin</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="./add-classes.html"><span>Add Classes</span></a>
                <a href="./add-member.html"><span>Add Member</span></a>
                <a href="./manage-members.html"><span>Manage Member</span></a>
                <a href="./add-trainer.html"><span>Add Trainer</span></a>
                <a href="./manage-class-enrollment.html"><span>Manage Enrollment</span></a>
                <a href="./add-transaction.html"><span>Add Transaction</span></a>
                <a href="./view-classes-and-feedback.html"><span>View Classes</span></a>
                <a href="./trainer-schedule-management.html"><span>Trainer Schedule Management</span></a>
            </nav>
        </aside>

        <!-- Header -->
        <header class="header">
            <button class="menu-toggle" id="menuToggle">☰</button>
            <h1>View Classes</h1>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <h1>View Classes</h1>
                <div id="serverStatus" class="server-status">Checking server connection...</div>
                <div id="errorMessage" class="error hidden"></div>

                <div class="card section">
                    <h2>Classes List</h2>

                    <div class="form-group">
                        <label for="classSearch">Search Classes:</label>
                        <input type="text" id="classSearch" placeholder="Search by name, schedule, or trainer...">
                    </div>

                    <div id="classesLoading" class="loading">Loading classes...</div>
                    <div id="classesList"></div>
                </div>
            </div>
        </main>
    </div>

<script>
const SERVER_URL = 'https://flex-it-goalsgym-it-project-2.onrender.com';
let trainersMap = new Map();
let classesData = [];
let searchTimeout = null;

document.addEventListener('DOMContentLoaded', async function() {
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.querySelector('.sidebar');
    const logoutBtn = document.getElementById('logoutBtn');

    // Auth guard
    const authUser = JSON.parse(localStorage.getItem('authUser'));
    if (!authUser || (Date.now() - authUser.timestamp > 3600000)) {
        localStorage.removeItem('authUser');
        window.location.href = '../admin-login.html';
        return;
    }

    menuToggle.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
    logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('authUser');
        window.location.href = '../admin-login.html';
    });

    // Close sidebar on outside click (mobile)
    document.addEventListener('click', (e) => {
        if (window.innerWidth <= 768 && !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
            sidebar.classList.remove('collapsed');
        }
    });
    sidebar.addEventListener('transitionend', () => {
        document.body.style.overflow = (window.innerWidth <= 768 && sidebar.classList.contains('collapsed')) ? 'hidden' : 'auto';
    });

    await checkServerConnection();
    await loadTrainers();
    await loadClasses();
    setupEventListeners();
});

function setupEventListeners() {
    document.getElementById('classSearch').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim().toLowerCase();
        searchTimeout = setTimeout(() => {
            filterClasses(query);
        }, 300);
    });
}

async function checkServerConnection() {
    const statusElement = document.getElementById('serverStatus');
    try {
        const response = await fetch(`${SERVER_URL}/health`);
        if (response.ok) {
            statusElement.textContent = 'Connected to server successfully';
            statusElement.className = 'server-status server-connected';
        } else {
            throw new Error('Server response not OK');
        }
    } catch (error) {
        statusElement.textContent = 'Cannot connect to server. Please try again later.';
        statusElement.className = 'server-status server-disconnected';
    }
}

async function loadTrainers() {
    try {
        const response = await fetch(`${SERVER_URL}/api/trainers`);
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
                result.data.forEach(trainer => {
                    trainersMap.set(trainer.trainer_id, {
                        name: trainer.name,
                        specialization: trainer.specialization
                    });
                });
            }
        }
    } catch (error) {
        console.error('Error loading trainers:', error);
        showError('Failed to load trainers');
    }
}

async function loadClasses() {
    const classesList = document.getElementById('classesList');
    const loading = document.getElementById('classesLoading');
    try {
        const response = await fetch(`${SERVER_URL}/api/classes`);
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.data && result.data.length > 0) {
                classesData = result.data;
                renderClasses(classesData);
            } else {
                classesList.innerHTML = '<p>No classes available</p>';
            }
        } else {
            throw new Error('Failed to load classes');
        }
    } catch (error) {
        console.error('Error loading classes:', error);
        classesList.innerHTML = '<p>Error loading classes</p>';
        showError('Failed to load classes');
    } finally {
        loading.classList.add('hidden');
    }
}

function renderClasses(classes) {
    const classesList = document.getElementById('classesList');
    classesList.innerHTML = '';

    if (classes.length === 0) {
        classesList.innerHTML = '<p>No classes found</p>';
        return;
    }

    classes.forEach(cls => {
        const trainer = trainersMap.get(cls.trainer_id) || { name: 'Unknown', specialization: 'N/A' };
        const details = document.createElement('details');

        // Prefer class_id if available, fallback to _id
        const classIdentifier = cls.class_id || cls._id;

        details.innerHTML = `
            <summary>
                ${cls.class_name} - Schedule: ${cls.schedule} - Trainer: ${trainer.name} - Enrollment: ${cls.current_enrollment}/${cls.capacity}
            </summary>
            <div class="class-details">
                <div class="trainer-info">
                    <h3>Trainer Details</h3>
                    <p><strong>Name:</strong> ${trainer.name}</p>
                    <p><strong>Specialization:</strong> ${trainer.specialization}</p>
                </div>

                <h3>Enrolled Members</h3>

                <div class="enrollment-filters">
                    <label for="date-${classIdentifier}" style="margin-right:8px;">Filter by date:</label>
                    <input type="date" id="date-${classIdentifier}" />
                    <button id="btn-date-${classIdentifier}" class="btn-filter" style="margin-left:8px;">Show</button>
                    <button id="btn-next3-${classIdentifier}" class="btn-next3" style="margin-left:12px;">Show Next 3 Sessions</button>
                </div>

                <div id="members-${classIdentifier}" class="loading">Select a date or show next 3 sessions...</div>

                <div id="feedback-${cls._id}" class="feedback-section"></div>
            </div>
        `;

        details.addEventListener('toggle', () => {
            if (details.open) {
                // Default view when opening: next 3 sessions
                loadNextThreeSessions(classIdentifier);
                loadClassFeedback(cls._id, details.querySelector(`#feedback-${cls._id}`));
            }
        });

        // Delegate button events inside this details block
        details.addEventListener('click', async (e) => {
            if (e.target && e.target.id === `btn-date-${classIdentifier}`) {
                const dateInput = details.querySelector(`#date-${classIdentifier}`);
                const value = dateInput?.value;
                if (!value) {
                    renderMembersEmpty(`members-${classIdentifier}`, 'Please select a date.');
                    return;
                }
                await loadEnrolledMembersByDate(classIdentifier, value);
            }

            if (e.target && e.target.id === `btn-next3-${classIdentifier}`) {
                await loadNextThreeSessions(classIdentifier);
            }
        });

        classesList.appendChild(details);
    });
}

function filterClasses(query) {
    const filtered = classesData.filter(cls => {
        const trainer = trainersMap.get(cls.trainer_id) || { name: '' };
        return (
            cls.class_name.toLowerCase().includes(query) ||
            String(cls.schedule || '').toLowerCase().includes(query) ||
            trainer.name.toLowerCase().includes(query)
        );
    });
    renderClasses(filtered);
}

// -----------------------------
// Enrollment rendering helpers
// -----------------------------

function renderMembersEmpty(targetId, message) {
    const membersDiv = document.getElementById(targetId);
    if (!membersDiv) return;
    membersDiv.innerHTML = `<p class="no-members">${message}</p>`;
}

function groupEnrollmentsByDate(enrollments) {
    const map = new Map();
    enrollments.forEach(e => {
        const key = new Date(e.session_date).toDateString();
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(e);
    });
    // Sort members per date by name
    map.forEach(list => list.sort((a, b) => (a.member_name || '').localeCompare(b.member_name || '')));
    return map;
}

function renderEnrollments(targetId, enrollments, heading = null) {
    const membersDiv = document.getElementById(targetId);
    if (!membersDiv) return;

    if (!enrollments || enrollments.length === 0) {
        membersDiv.innerHTML = '<p class="no-members">No enrolled members found</p>';
        return;
    }

    const grouped = groupEnrollmentsByDate(enrollments);
    let html = '';
    if (heading) {
        html += `<h4 style="margin:10px 0;">${heading}</h4>`;
    }

    grouped.forEach((list, dateKey) => {
        html += `<div class="session-group">
                    <div class="session-date"><strong>${dateKey}</strong></div>
                    <ul class="members-list">`;
        list.forEach(en => {
            html += `<li>
                        ${en.member_name || 'Unknown'} (${en.member_id})
                        — <em>${en.session_time || ''}</em>
                        — <span class="badge ${en.attendance_status}">${(en.attendance_status || 'scheduled').toUpperCase()}</span>
                    </li>`;
        });
        html += `   </ul>
                </div>`;
    });

    membersDiv.innerHTML = html;
}

async function fetchClassEnrollments(classIdentifier) {
    // classIdentifier is class_id (preferred) or _id fallback
    const url = `${SERVER_URL}/api/enrollments/class/${encodeURIComponent(classIdentifier)}`;
    const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
    };
    const resp = await fetch(url, { headers });
    if (!resp.ok) {
        let msg = `Server error (${resp.status})`;
        try {
            const r = await resp.json();
            msg = r.error || msg;
        } catch {}
        throw new Error(msg);
    }
    const result = await resp.json();
    if (!result.success) throw new Error(result.error || 'Unknown error');
    return result.data || [];
}

async function loadEnrolledMembersByDate(classIdentifier, yyyyMMdd) {
    const targetId = `members-${classIdentifier}`;
    const membersDiv = document.getElementById(targetId);
    membersDiv.innerHTML = '<div class="loading">Loading...</div>';

    try {
        const all = await fetchClassEnrollments(classIdentifier);
        // Match exact date ignoring time
        const target = new Date(yyyyMMdd);
        const filtered = all.filter(e => {
            const d = new Date(e.session_date);
            return d.getFullYear() === target.getFullYear() &&
                   d.getMonth() === target.getMonth() &&
                   d.getDate() === target.getDate();
        });
        renderEnrollments(targetId, filtered, `Enrolled on ${new Date(yyyyMMdd).toLocaleDateString()}`);
    } catch (err) {
        membersDiv.innerHTML = `<p class="error">Error: ${err.message}</p>`;
    }
}

function getNextNDistinctSessionDates(enrollments, n = 3) {
    const today = new Date();
    const future = enrollments
        .filter(e => new Date(e.session_date) >= new Date(today.toDateString())) // >= today
        .sort((a, b) => new Date(a.session_date) - new Date(b.session_date));

    const dates = [];
    const seen = new Set();
    for (const e of future) {
        const key = new Date(e.session_date).toDateString();
        if (!seen.has(key)) {
            seen.add(key);
            dates.push(key);
        }
        if (dates.length === n) break;
    }
    return dates;
}

async function loadNextThreeSessions(classIdentifier) {
    const targetId = `members-${classIdentifier}`;
    const membersDiv = document.getElementById(targetId);
    membersDiv.innerHTML = '<div class="loading">Loading next sessions...</div>';

    try {
        const all = await fetchClassEnrollments(classIdentifier);
        const nextDates = getNextNDistinctSessionDates(all, 3);

        if (nextDates.length === 0) {
            renderMembersEmpty(targetId, 'No upcoming sessions found.');
            return;
        }

        const dateSet = new Set(nextDates);
        const filtered = all.filter(e => dateSet.has(new Date(e.session_date).toDateString()));
        renderEnrollments(targetId, filtered, `Next ${nextDates.length} session day(s)`);
    } catch (err) {
        membersDiv.innerHTML = `<p class="error">Error: ${err.message}</p>`;
    }
}

// -----------------------------
// Feedback (unchanged)
// -----------------------------
async function loadClassFeedback(class_Id, feedbackDiv) {
    feedbackDiv.innerHTML = '<div class="loading">Loading feedback...</div>';
    const response = await fetch(`${SERVER_URL}/api/classes/${class_Id}/feedback`);
    if (!response.ok) {
        feedbackDiv.innerHTML = `<p>Error loading feedback (${response.status})</p>`;
        return;
    }
    const result = await response.json();
    const feedbacks = result.data || [];
    if (feedbacks.length === 0) {
        feedbackDiv.innerHTML = '<p>No feedback yet</p>';
        return;
    }
    const avgRating = (feedbacks.reduce((sum, fb) => sum + fb.rating, 0) / feedbacks.length).toFixed(2);
    let html = `<h4>Average Rating: ${avgRating} / 5 (${feedbacks.length} reviews)</h4><ul class="feedback-list">`;
    feedbacks.forEach(fb => {
        html += `<li>
            <div><strong>Rating:</strong> ${fb.rating} | <strong>Comment:</strong> ${fb.comment || "(No comment)"}</div>
            <div><strong>Member:</strong> ${fb.member_id} <span style="font-size:0.9em;color:gray;">${new Date(fb.date_submitted).toLocaleString()}</span></div>
            <button class="delete-feedback-btn" data-id="${fb.feedback_id}">Delete</button>
        </li>`;
    });
    html += "</ul>";
    feedbackDiv.innerHTML = html;
    feedbackDiv.querySelectorAll('.delete-feedback-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const id = btn.getAttribute('data-id');
            if (!confirm('Delete this feedback?')) return;
            const delResp = await fetch(`${SERVER_URL}/api/feedbacks/${id}`, { method: 'DELETE' });
            const delResult = await delResp.json();
            if (delResult.success) btn.closest('li').remove();
            else alert(delResult.error || 'Delete failed');
        });
    });
}

function showError(message) {
    const element = document.getElementById('errorMessage');
    element.textContent = message;
    element.classList.remove('hidden');
    setTimeout(() => { element.classList.add('hidden'); }, 5000);
}
</script>
</body>
</html>
