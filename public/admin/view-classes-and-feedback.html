<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Classes - GOALS Gym</title>
    <link rel="stylesheet" href="./admin-css/admin-mainpage.css">
    <link rel="stylesheet" href="./admin-css/view-classes-and-feedback.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>GOALS Gym Admin</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="./add-classes.html"><span>Add Classes</span></a>
                <a href="./add-member.html"><span>Add Member</span></a>
                <a href="./manage-members.html"><span>Manage Member</span></a>
                <a href="./add-trainer.html"><span>Add Trainer</span></a>
                <a href="./manage-class-enrollment.html"><span>Manage Enrollment</span></a>
                <a href="./add-transaction.html"><span>Add Transaction</span></a>
                <a href="./view-classes-and-feedback.html"><span>View Classes</span></a>
                <a href="./trainer-schedule.html"><span>Trainer Schedule</span></a>
            </nav>
        </aside>
        <!-- Header -->
        <header class="header">
            <button class="menu-toggle" id="menuToggle">â˜°</button>
            <h1>View Classes</h1>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </header>
        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <h1>View Classes</h1>
                <div id="serverStatus" class="server-status">Checking server connection...</div>
                <div id="errorMessage" class="error hidden"></div>
                <div class="card section">
                    <h2>Classes List</h2>
                    <div class="form-group">
                        <label for="classSearch">Search Classes:</label>
                        <input type="text" id="classSearch" placeholder="Search by name, schedule, or trainer...">
                    </div>
                    <div id="classesLoading" class="loading">Loading classes...</div>
                    <div id="classesList"></div>
                </div>
            </div>
        </main>
    </div>
<script>
const SERVER_URL = 'https://flex-it-goalsgym-it-project-2.onrender.com';
let trainersMap = new Map();
let classesData = [];
let searchTimeout = null;

document.addEventListener('DOMContentLoaded', async function() {
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.querySelector('.sidebar');
    const logoutBtn = document.getElementById('logoutBtn');
    const authUser = JSON.parse(localStorage.getItem('authUser'));
    if (!authUser || (Date.now() - authUser.timestamp > 3600000)) {
        localStorage.removeItem('authUser');
        window.location.href = '../admin-login.html';
        return;
    }
    menuToggle.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
    logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('authUser');
        window.location.href = '../admin-login.html';
    });
    document.addEventListener('click', (e) => {
        if (window.innerWidth <= 768 && !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
            sidebar.classList.remove('collapsed');
        }
    });
    sidebar.addEventListener('transitionend', () => {
        document.body.style.overflow = (window.innerWidth <= 768 && sidebar.classList.contains('collapsed')) ? 'hidden' : 'auto';
    });

    await checkServerConnection();
    await loadTrainers();
    await loadClasses();
    setupEventListeners();
});

function setupEventListeners() {
    document.getElementById('classSearch').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim().toLowerCase();
        searchTimeout = setTimeout(() => {
            filterClasses(query);
        }, 300);
    });
}

async function checkServerConnection() {
    const statusElement = document.getElementById('serverStatus');
    try {
        const response = await fetch(`${SERVER_URL}/health`);
        if (response.ok) {
            statusElement.textContent = 'Connected to server successfully';
            statusElement.className = 'server-status server-connected';
        } else {
            throw new Error('Server response not OK');
        }
    } catch (error) {
        statusElement.textContent = 'Cannot connect to server. Please try again later.';
        statusElement.className = 'server-status server-disconnected';
    }
}

async function loadTrainers() {
    try {
        const response = await fetch(`${SERVER_URL}/api/trainers`);
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
                result.data.forEach(trainer => {
                    trainersMap.set(trainer.trainer_id, {
                        name: trainer.name,
                        specialization: trainer.specialization
                    });
                });
            }
        }
    } catch (error) {
        console.error('Error loading trainers:', error);
        showError('Failed to load trainers');
    }
}

async function loadClasses() {
    const classesList = document.getElementById('classesList');
    const loading = document.getElementById('classesLoading');
    try {
        const response = await fetch(`${SERVER_URL}/api/classes`);
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.data && result.data.length > 0) {
                classesData = result.data;
                renderClasses(classesData);
            } else {
                classesList.innerHTML = '<p>No classes available</p>';
            }
        } else {
            throw new Error('Failed to load classes');
        }
    } catch (error) {
        console.error('Error loading classes:', error);
        classesList.innerHTML = '<p>Error loading classes</p>';
        showError('Failed to load classes');
    } finally {
        loading.classList.add('hidden');
    }
}

function renderClasses(classes) {
    const classesList = document.getElementById('classesList');
    classesList.innerHTML = '';
    if (classes.length === 0) {
        classesList.innerHTML = '<p>No classes found</p>';
        return;
    }
    classes.forEach(cls => {
        const trainer = trainersMap.get(cls.trainer_id) || { name: 'Unknown', specialization: 'N/A' };
        const details = document.createElement('details');
        details.innerHTML = `
            <summary>
                ${cls.class_name} - Schedule: ${cls.schedule} - Trainer: ${trainer.name} - Enrollment: ${cls.current_enrollment}/${cls.capacity}
            </summary>
            <div class="class-details">
                <div class="trainer-info">
                    <h3>Trainer Details</h3>
                    <p><strong>Name:</strong> ${trainer.name}</p>
                    <p><strong>Specialization:</strong> ${trainer.specialization}</p>
                </div>
                <h3>Enrolled Members</h3>
                <div id="members-${cls._id}" class="loading">Loading members...</div>
                <div id="feedback-${cls._id}" class="feedback-section"></div>
            </div>
        `;
        details.addEventListener('toggle', () => {
            if (details.open) {
                console.log("[DEBUG] Loading feedback for _id:", cls._id);
                loadEnrolledMembers(cls._id);
                loadClassFeedback(cls._id, details.querySelector(`#feedback-${cls._id}`));
            }
        });
        classesList.appendChild(details);
    });
}

function filterClasses(query) {
    const filtered = classesData.filter(cls => {
        const trainer = trainersMap.get(cls.trainer_id) || { name: '' };
        return (
            cls.class_name.toLowerCase().includes(query) ||
            cls.schedule.toLowerCase().includes(query) ||
            trainer.name.toLowerCase().includes(query)
        );
    });
    renderClasses(filtered);
}

async function loadEnrolledMembers(classId) {
    const membersDiv = document.getElementById(`members-${classId}`);
    try {
        const response = await fetch(`${SERVER_URL}/api/classes/${classId}/enrolled-members`);
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                if (result.data && result.data.length > 0) {
                    const ul = document.createElement('ul');
                    ul.className = 'members-list';
                    result.data.forEach(member => {
                        const li = document.createElement('li');
                        li.textContent = `${member.member_name || 'Unknown'} (${member.member_id}) - Enrolled on: ${new Date(member.enrollment_date).toLocaleDateString()}`;
                        ul.appendChild(li);
                    });
                    membersDiv.innerHTML = '';
                    membersDiv.appendChild(ul);
                } else {
                    membersDiv.innerHTML = '<p class="no-members">No members enrolled</p>';
                }
            } else {
                membersDiv.innerHTML = `<p>Error: ${result.error || 'Unknown error'}</p>`;
            }
        } else {
            const errorResult = await response.json();
            membersDiv.innerHTML = `<p>Error: ${errorResult.error || 'Server error'} (Status: ${response.status})</p>`;
        }
    } catch (error) {
        console.error('Error loading enrolled members:', error);
        membersDiv.innerHTML = `<p>Network error: ${error.message}</p>`;
    }
}

async function loadClassFeedback(class_Id, feedbackDiv) {
    console.log("[DEBUG] Fetching:", `${SERVER_URL}/api/classes/${class_Id}/feedback`);
    feedbackDiv.innerHTML = '<div class="loading">Loading feedback...</div>';
    const response = await fetch(`${SERVER_URL}/api/classes/${class_Id}/feedback`);
    if (!response.ok) {
        feedbackDiv.innerHTML = `<p>Error loading feedback (${response.status})</p>`;
        return;
    }
    const result = await response.json();
    const feedbacks = result.data || [];
    console.log('[DEBUG] Feedbacks returned from API:', feedbacks);
    if (feedbacks.length === 0) {
        feedbackDiv.innerHTML = '<p>No feedback yet</p>';
        return;
    }
    const avgRating = (feedbacks.reduce((sum, fb) => sum + fb.rating, 0) / feedbacks.length).toFixed(2);
    let html = `<h4>Average Rating: ${avgRating} / 5 (${feedbacks.length} reviews)</h4><ul class="feedback-list">`;
    feedbacks.forEach(fb => {
        html += `<li>
            <div><strong>Rating:</strong> ${fb.rating} | <strong>Comment:</strong> ${fb.comment || "(No comment)"}</div>
            <div><strong>Member:</strong> ${fb.member_id} <span style="font-size:0.9em;color:gray;">${new Date(fb.date_submitted).toLocaleString()}</span></div>
            <button class="delete-feedback-btn" data-id="${fb.feedback_id}">Delete</button>
        </li>`;
    });
    html += "</ul>";
    feedbackDiv.innerHTML = html;
    feedbackDiv.querySelectorAll('.delete-feedback-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const id = btn.getAttribute('data-id');
            if (!confirm('Delete this feedback?')) return;
            const delResp = await fetch(`${SERVER_URL}/api/feedbacks/${id}`, { method: 'DELETE' });
            const delResult = await delResp.json();
            if (delResult.success) btn.closest('li').remove();
            else alert(delResult.error || 'Delete failed');
        });
    });
}

function showError(message) {
    const element = document.getElementById('errorMessage');
    element.textContent = message;
    element.classList.remove('hidden');
    setTimeout(() => { element.classList.add('hidden'); }, 5000);
}
</script>
</body>
</html>
