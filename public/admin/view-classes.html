<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Classes - Goals Gym</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7f9;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1, h2, h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section {
            margin-bottom: 25px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 10px;
            color: #7f8c8d;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .server-status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .server-connected {
            background-color: #d4edda;
            color: #155724;
        }
        
        .server-disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        details {
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        
        summary {
            padding: 10px;
            background-color: #f8f9fa;
            cursor: pointer;
            font-weight: 600;
        }
        
        summary:hover {
            background-color: #e9ecef;
        }
        
        .class-details {
            padding: 15px;
        }
        
        .trainer-info {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .members-list {
            list-style: none;
        }
        
        .members-list li {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .members-list li:last-child {
            border-bottom: none;
        }
        
        .no-members {
            color: #7f8c8d;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>View Classes</h1>
        
        <div id="serverStatus" class="server-status">Checking server connection...</div>
        
        <div id="errorMessage" class="error hidden"></div>
        
        <div class="card section">
            <h2>Classes List</h2>
            <div class="form-group">
                <label for="classSearch">Search Classes:</label>
                <input type="text" id="classSearch" placeholder="Search by name, schedule, or trainer...">
            </div>
            <div id="classesLoading" class="loading">Loading classes...</div>
            <div id="classesList"></div>
        </div>
    </div>

    <script>
        const SERVER_URL = 'https://flex-it-goalsgym-it-project-2.onrender.com';
        let trainersMap = new Map();
        let classesData = [];
        let searchTimeout = null;

        document.addEventListener('DOMContentLoaded', async function() {
            await checkServerConnection();
            await loadTrainers();
            await loadClasses();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('classSearch').addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim().toLowerCase();
                
                searchTimeout = setTimeout(() => {
                    filterClasses(query);
                }, 300);
            });
        }

        async function checkServerConnection() {
            const statusElement = document.getElementById('serverStatus');
            try {
                const response = await fetch(`${SERVER_URL}/health`);
                if (response.ok) {
                    statusElement.textContent = 'Connected to server successfully';
                    statusElement.className = 'server-status server-connected';
                } else {
                    throw new Error('Server response not OK');
                }
            } catch (error) {
                statusElement.textContent = 'Cannot connect to server. Please try again later.';
                statusElement.className = 'server-status server-disconnected';
            }
        }

        async function loadTrainers() {
            try {
                const response = await fetch(`${SERVER_URL}/api/trainers`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        result.data.forEach(trainer => {
                            trainersMap.set(trainer.trainer_id, {
                                name: trainer.name,
                                specialization: trainer.specialization
                            });
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading trainers:', error);
                showError('Failed to load trainers');
            }
        }

        async function loadClasses() {
            const classesList = document.getElementById('classesList');
            const loading = document.getElementById('classesLoading');
            
            try {
                const response = await fetch(`${SERVER_URL}/api/classes`);
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success && result.data && result.data.length > 0) {
                        classesData = result.data;
                        renderClasses(classesData);
                    } else {
                        classesList.innerHTML = '<p>No classes available</p>';
                    }
                } else {
                    throw new Error('Failed to load classes');
                }
            } catch (error) {
                console.error('Error loading classes:', error);
                classesList.innerHTML = '<p>Error loading classes</p>';
                showError('Failed to load classes');
            } finally {
                loading.classList.add('hidden');
            }
        }

        function renderClasses(classes) {
            const classesList = document.getElementById('classesList');
            classesList.innerHTML = '';
            
            if (classes.length === 0) {
                classesList.innerHTML = '<p>No classes found</p>';
                return;
            }
            
            classes.forEach(cls => {
                const trainer = trainersMap.get(cls.trainer_id) || { name: 'Unknown', specialization: 'N/A' };
                
                const details = document.createElement('details');
                details.innerHTML = `
                    <summary>
                        ${cls.class_name} - Schedule: ${cls.schedule} - Trainer: ${trainer.name} - Enrollment: ${cls.current_enrollment}/${cls.capacity}
                    </summary>
                    <div class="class-details">
                        <div class="trainer-info">
                            <h3>Trainer Details</h3>
                            <p><strong>Name:</strong> ${trainer.name}</p>
                            <p><strong>Specialization:</strong> ${trainer.specialization}</p>
                        </div>
                        <h3>Enrolled Members</h3>
                        <div id="members-${cls.class_id}" class="loading">Loading members...</div>
                    </div>
                `;
                
                details.addEventListener('toggle', () => {
                    if (details.open) {
                        loadEnrolledMembers(cls.class_id);
                    }
                });
                
                classesList.appendChild(details);
            });
        }

        function filterClasses(query) {
            const filtered = classesData.filter(cls => {
                const trainer = trainersMap.get(cls.trainer_id) || { name: '' };
                return (
                    cls.class_name.toLowerCase().includes(query) ||
                    cls.schedule.toLowerCase().includes(query) ||
                    trainer.name.toLowerCase().includes(query)
                );
            });
            renderClasses(filtered);
        }

        async function loadEnrolledMembers(classId) {
            const membersDiv = document.getElementById(`members-${classId}`);
            
            try {
                const response = await fetch(`${SERVER_URL}/api/classes/${classId}/enrolled-members`);
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success) {
                        if (result.data && result.data.length > 0) {
                            const ul = document.createElement('ul');
                            ul.className = 'members-list';
                            result.data.forEach(member => {
                                const li = document.createElement('li');
                                li.textContent = `${member.member_name || 'Unknown'} (${member.member_id}) - Enrolled on: ${new Date(member.enrollment_date).toLocaleDateString()}`;
                                ul.appendChild(li);
                            });
                            membersDiv.innerHTML = '';
                            membersDiv.appendChild(ul);
                        } else {
                            membersDiv.innerHTML = '<p class="no-members">No members enrolled</p>';
                        }
                    } else {
                        membersDiv.innerHTML = `<p>Error: ${result.error || 'Unknown error'}</p>`;
                    }
                } else {
                    const errorResult = await response.json();
                    membersDiv.innerHTML = `<p>Error: ${errorResult.error || 'Server error'} (Status: ${response.status})</p>`;
                }
            } catch (error) {
                console.error('Error loading enrolled members:', error);
                membersDiv.innerHTML = `<p>Network error: ${error.message}</p>`;
            }
        }

        function showError(message) {
            const element = document.getElementById('errorMessage');
            element.textContent = message;
            element.classList.remove('hidden');
            setTimeout(() => { element.classList.add('hidden'); }, 5000);
        }
    </script>
</body>
</html>