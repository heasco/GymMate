<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Class Enrollment - GOALS Gym</title>
    <!-- Reference the admin dashboard CSS and your new enrollment CSS -->
    <link rel="stylesheet" href="./admin-css/admin-mainpage.css">
    <link rel="stylesheet" href="./admin-css/manage-class-enrollment.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>GOALS Gym Admin</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="./add-classes.html"><span>Add Classes</span></a>
                <a href="./add-member.html"><span>Add Member</span></a>
                <a href="./manage-members.html"><span>Manage Member</span></a>
                <a href="./add-trainer.html"><span>Add Trainer</span></a>
                <a href="./manage-class-enrollment.html"><span>Manage Enrollment</span></a>
                <a href="./add-transaction.html"><span>Add Transaction</span></a>
                <a href="./view-classes-and-feedback.html"><span>View Classes</span></a>
                <a href="./trainer-schedule.html"><span>Trainer Schedule</span></a>
            </nav>
        </aside>

        <!-- Header -->
        <header class="header">
            <button class="menu-toggle" id="menuToggle">â˜°</button>
            <h1>Manage Class Enrollment</h1>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <div id="serverStatus" class="server-status">Checking server connection...</div>
                <div id="successMessage" class="success-message"></div>
                <div id="errorMessage" class="error-message"></div>

                <div id="enrollmentSection" class="section active">
                    <h2>Manage Class Enrollment</h2>
                    <div class="form-group">
                        <label for="class_id">Select Class:</label>
                        <select id="class_id" name="class_id" required>
                            <option value="">Loading classes...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Search Combative Members:</label>
                        <div class="search-group">
                            <input type="text" id="member_search" placeholder="Enter name or member ID">
                            <div id="autocompleteSuggestions" class="autocomplete-suggestions"></div>
                        </div>
                    </div>

                    <div id="searchResults" class="member-list">
                        <h3>Available Combative Members</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Member ID</th>
                                    <th>Name</th>
                                    <th>Membership Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="searchResultsBody"></tbody>
                        </table>
                    </div>

                    <div id="enrolledMembers" class="member-list">
                        <h3>Enrolled Members</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Member ID</th>
                                    <th>Name</th>
                                    <th>Enrollment Date</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="enrolledMembersBody"></tbody>
                        </table>
                    </div>

                    <div class="nav-buttons">
                        <button type="button" onclick="window.location.href='add-classes.html'">Back to Add Class</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const SERVER_URL = 'https://flex-it-goalsgym-it-project-2.onrender.com';
        let debounceTimeout;

        document.addEventListener('DOMContentLoaded', async function() {
            // Ensure authentication like the other dashboard pages
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.querySelector('.sidebar');
            const logoutBtn = document.getElementById('logoutBtn');
            const authUser = JSON.parse(localStorage.getItem('authUser'));

            if (!authUser || (Date.now() - authUser.timestamp > 3600000)) {
                localStorage.removeItem('authUser');
                window.location.href = '../admin-login.html';
                return;
            }

            menuToggle.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('authUser');
                window.location.href = '../admin-login.html';
            });
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                    sidebar.classList.remove('collapsed');
                }
            });
            sidebar.addEventListener('transitionend', () => {
                document.body.style.overflow = (window.innerWidth <= 768 && sidebar.classList.contains('collapsed')) ? 'hidden' : 'auto';
            });

            // Your original initialization
            await checkServerConnection();
            await fetchClasses();
            setupSearchListener();
        });

        async function checkServerConnection() {
            const statusElement = document.getElementById('serverStatus');
            try {
                const response = await fetch(`${SERVER_URL}/health`);
                if (response.ok) {
                    statusElement.textContent = 'Connected to server successfully';
                    statusElement.className = 'server-status server-connected';
                } else {
                    throw new Error('Server response not OK');
                }
            } catch (error) {
                statusElement.textContent = 'Cannot connect to server. Please try again later.';
                statusElement.className = 'server-status server-disconnected';
                console.error('Server connection error:', error);
            }
        }

        async function fetchClasses() {
            const classSelect = document.getElementById('class_id');
            try {
                const response = await fetch(`${SERVER_URL}/api/classes`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                    }
                });
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data && result.data.length > 0) {
                        classSelect.innerHTML = '<option value="">Select a class</option>';
                        result.data.forEach(cls => {
                            const option = document.createElement('option');
                            option.value = cls.class_id;
                            option.textContent = `${cls.class_name} (${cls.schedule})`;
                            classSelect.appendChild(option);
                        });
                    } else {
                        classSelect.innerHTML = '<option value="">No classes available</option>';
                    }
                } else {
                    classSelect.innerHTML = '<option value="">Error loading classes</option>';
                }
                classSelect.addEventListener('change', loadEnrolledMembers);
            } catch (error) {
                console.error('Error fetching classes:', error);
                classSelect.innerHTML = '<option value="">Error loading classes</option>';
            }
        }

        function setupSearchListener() {
            const searchInput = document.getElementById('member_search');
            searchInput.addEventListener('input', debounce(searchMembers, 300));
        }

        function debounce(func, wait) {
            return function(...args) {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        async function searchMembers() {
            const query = document.getElementById('member_search').value.trim();
            const resultsBody = document.getElementById('searchResultsBody');
            const suggestions = document.getElementById('autocompleteSuggestions');
            const errorMessage = document.getElementById('errorMessage');

            suggestions.innerHTML = '';
            suggestions.style.display = 'none';
            resultsBody.innerHTML = '';

            if (query.length < 2) {
                return;
            }

            try {
                const response = await fetch(`${SERVER_URL}/api/members/search?query=${encodeURIComponent(query)}&type=combative`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                    }
                });
                const result = await response.json();

                if (result.success && result.data && result.data.length > 0) {
                    suggestions.style.display = 'block';
                    result.data.forEach(member => {
                        const suggestion = document.createElement('div');
                        suggestion.className = 'autocomplete-suggestion';
                        suggestion.textContent = `${member.name} (${member.memberId})`;
                        suggestion.onclick = () => selectMember(member.memberId, member.name);
                        suggestions.appendChild(suggestion);

                        const row = document.createElement('tr');
                        const membershipStatus = member.memberships.find(m => m.type === 'combative' && m.status === 'active') ? 'Active' : 'Inactive';
                        row.innerHTML = `
                            <td>${member.memberId}</td>
                            <td>${member.name}</td>
                            <td>${membershipStatus}</td>
                            <td><button onclick="enrollMember('${member.memberId}')">Enroll</button></td>
                        `;
                        resultsBody.appendChild(row);
                    });
                } else {
                    resultsBody.innerHTML = '<tr><td colspan="4">No combative members found</td></tr>';
                }
            } catch (error) {
                console.error('Error searching members:', error);
                resultsBody.innerHTML = '<tr><td colspan="4">Error loading members</td></tr>';
                errorMessage.textContent = 'Network error: ' + error.message;
                errorMessage.style.display = 'block';
                setTimeout(() => errorMessage.style.display = 'none', 5000);
            }
        }

        function selectMember(memberId, memberName) {
            document.getElementById('member_search').value = memberName;
            document.getElementById('autocompleteSuggestions').style.display = 'none';
            enrollMember(memberId);
        }

        async function enrollMember(memberId) {
            const classId = document.getElementById('class_id').value;
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');

            if (!classId) {
                errorMessage.textContent = 'Please select a class first';
                errorMessage.style.display = 'block';
                setTimeout(() => errorMessage.style.display = 'none', 5000);
                return;
            }

            try {
                const response = await fetch(`${SERVER_URL}/api/classes/${classId}/enroll`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                    },
                    body: JSON.stringify({ member_id: memberId })
                });
                const result = await response.json();

                if (response.ok) {
                    successMessage.textContent = result.message;
                    successMessage.style.display = 'block';
                    setTimeout(() => successMessage.style.display = 'none', 5000);
                    loadEnrolledMembers();
                    document.getElementById('member_search').value = '';
                    document.getElementById('autocompleteSuggestions').style.display = 'none';
                } else {
                    errorMessage.textContent = result.error || 'Failed to enroll member';
                    errorMessage.style.display = 'block';
                    setTimeout(() => errorMessage.style.display = 'none', 5000);
                }
            } catch (error) {
                console.error('Error enrolling member:', error);
                errorMessage.textContent = 'Network error: ' + error.message;
                errorMessage.style.display = 'block';
                setTimeout(() => errorMessage.style.display = 'none', 5000);
            }
        }

        async function removeMember(memberId) {
            const classId = document.getElementById('class_id').value;
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');

            if (!classId) {
                errorMessage.textContent = 'Please select a class first';
                errorMessage.style.display = 'block';
                setTimeout(() => errorMessage.style.display = 'none', 5000);
                return;
            }

            try {
                const response = await fetch(`${SERVER_URL}/api/classes/${classId}/enrollments/${memberId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                    }
                });
                const result = await response.json();

                if (response.ok) {
                    successMessage.textContent = result.message;
                    successMessage.style.display = 'block';
                    setTimeout(() => successMessage.style.display = 'none', 5000);
                    loadEnrolledMembers();
                } else {
                    errorMessage.textContent = result.error || 'Failed to remove member';
                    errorMessage.style.display = 'block';
                    setTimeout(() => errorMessage.style.display = 'none', 5000);
                }
            } catch (error) {
                console.error('Error removing member:', error);
                errorMessage.textContent = 'Network error: ' + error.message;
                errorMessage.style.display = 'block';
                setTimeout(() => errorMessage.style.display = 'none', 5000);
            }
        }

        async function loadEnrolledMembers() {
            const classId = document.getElementById('class_id').value;
            const enrolledMembersBody = document.getElementById('enrolledMembersBody');

            if (!classId) {
                enrolledMembersBody.innerHTML = '<tr><td colspan="4">Please select a class</td></tr>';
                return;
            }

            try {
                const response = await fetch(`${SERVER_URL}/api/classes/${classId}/enrolled-members`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                    }
                });
                const result = await response.json();

                enrolledMembersBody.innerHTML = '';

                if (result.success && result.data && result.data.length > 0) {
                    result.data.forEach(member => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${member.member_id}</td>
                            <td>${member.member_name}</td>
                            <td>${new Date(member.enrollment_date).toLocaleDateString()}</td>
                            <td><button class="remove-button" onclick="removeMember('${member.member_id}')">Remove</button></td>
                        `;
                        enrolledMembersBody.appendChild(row);
                    });
                } else {
                    enrolledMembersBody.innerHTML = '<tr><td colspan="4">No members enrolled</td></tr>';
                }
            } catch (error) {
                console.error('Error loading enrolled members:', error);
                enrolledMembersBody.innerHTML = '<tr><td colspan="4">Error loading enrolled members</td></tr>';
            }
        }
    </script>
</body>
</html>
