<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Member - GOALS Gym</title>
    <link rel="stylesheet" href="./admin-css/add-member.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>GOALS Gym Admin</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="./admin-mainpage.html"><span>Dashboard</span></a>
                <a href="./add-classes.html"><span>Add Classes</span></a>
                <a href="./add-member.html" class="active"><span>Add Member</span></a>
                <a href="./add-trainer.html"><span>Add Trainer</span></a>
                <a href="./manage-enrollment.html"><span>Manage Enrollment</span></a>
                <a href="./add-transaction.html"><span>Add Transaction</span></a>
                <a href="./view-classes.html"><span>View Classes</span></a>
                <a href="./trainer-schedule.html"><span>Trainer Schedule</span></a>
            </nav>
        </aside>

        <!-- Header -->
        <header class="header">
            <button class="menu-toggle" id="menuToggle">☰</button>
            <h1>Add Member</h1>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <h2>Add New Member</h2>
            <form id="memberForm" class="member-form">
                <div class="form-group">
                    <label for="memberName">Full Name *</label>
                    <input type="text" id="memberName" name="memberName" required>
                </div>
                
                <div class="form-group">
                    <label>Membership Type(s) *</label>
                    <div class="membership-option">
                        <div class="checkbox-group">
                            <input type="checkbox" id="monthlyCheckbox" name="membershipTypes" value="monthly">
                            <label for="monthlyCheckbox">Monthly Gym Membership</label>
                        </div>
                        <div id="monthlyDetails" class="membership-details hidden">
                            <label for="monthlyDuration">Duration (months):</label>
                            <input type="number" id="monthlyDuration" name="monthlyDuration" min="1" value="1">
                            <div class="duration-info">Number of months for gym membership</div>
                        </div>
                    </div>
                    <div class="membership-option">
                        <div class="checkbox-group">
                            <input type="checkbox" id="combativeCheckbox" name="membershipTypes" value="combative">
                            <label for="combativeCheckbox">Combative Sports Membership</label>
                        </div>
                        <div id="combativeDetails" class="membership-details hidden">
                            <label for="combativeSessions">Number of Sessions:</label>
                            <input type="number" id="combativeSessions" name="combativeSessions" min="1" value="12">
                            <div class="duration-info">Number of combative sessions (default: 12)</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="joinDate">Join Date *</label>
                    <input type="date" id="joinDate" name="joinDate" required>
                </div>
                
                <div class="form-group">
                    <label for="phone">Phone Number:</label>
                    <input type="tel" id="phone" name="phone">
                </div>
                
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email">
                </div>
                
                <button type="submit" class="add-member-button">Add Member</button>
            </form>
            <div id="message" class="message"></div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.querySelector('.sidebar');
            const logoutBtn = document.getElementById('logoutBtn');
            const memberForm = document.getElementById('memberForm');
            const message = document.getElementById('message');
            const authUser = JSON.parse(localStorage.getItem('authUser'));

            // Toggle sidebar on smaller screens
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
            });

            // Check valid session (1 hour expiration)
            if (!authUser || (Date.now() - authUser.timestamp > 3600000)) {
                localStorage.removeItem('authUser');
                window.location.href = '../admin-login.html';
                return;
            }

            // Logout handler
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('authUser');
                window.location.href = '../admin-login.html';
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                    sidebar.classList.remove('collapsed');
                }
            });

            // Prevent body scroll when sidebar is open on mobile
            sidebar.addEventListener('transitionend', () => {
                if (window.innerWidth <= 768 && sidebar.classList.contains('collapsed')) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = 'auto';
                }
            });

            // Toggle membership details visibility
            document.getElementById('monthlyCheckbox').addEventListener('change', function() {
                document.getElementById('monthlyDetails').classList.toggle('hidden', !this.checked);
            });
            
            document.getElementById('combativeCheckbox').addEventListener('change', function() {
                document.getElementById('combativeDetails').classList.toggle('hidden', !this.checked);
            });

            // Set join date to today
            document.getElementById('joinDate').valueAsDate = new Date();

            // Form submission
            memberForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const submitBtn = e.target.querySelector('.add-member-button');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Adding...';

                const membershipCheckboxes = document.querySelectorAll('input[name="membershipTypes"]:checked');
                if (membershipCheckboxes.length === 0) {
                    message.textContent = 'Please select at least one membership type';
                    message.className = 'message error';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Add Member';
                    setTimeout(() => {
                        message.textContent = '';
                        message.className = 'message';
                    }, 5000);
                    return;
                }

                const rawPhone = document.getElementById('phone').value.trim();
                let formattedPhone = undefined;
                
                if (rawPhone) {
                    const digitsOnly = rawPhone.replace(/\D/g, '');
                    
                    if (digitsOnly.length === 11 && digitsOnly.startsWith('09')) {
                        formattedPhone = `+63${digitsOnly.substring(1)}`;
                    } else if (digitsOnly.length === 12 && digitsOnly.startsWith('639')) {
                        formattedPhone = `+${digitsOnly}`;
                    } else {
                        message.textContent = 'Please enter a valid Philippine mobile number:\n\n• 09171234567 (11 digits starting with 09)\n• +639171234567 (12 digits with country code)';
                        message.className = 'message error';
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Add Member';
                        setTimeout(() => {
                            message.textContent = '';
                            message.className = 'message';
                        }, 5000);
                        return;
                    }
                }

                const memberships = [];
                
                if (document.getElementById('monthlyCheckbox').checked) {
                    const monthlyDuration = parseInt(document.getElementById('monthlyDuration').value);
                    if (isNaN(monthlyDuration) || monthlyDuration < 1) {
                        message.textContent = 'Please enter a valid duration for monthly membership (at least 1 month)';
                        message.className = 'message error';
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Add Member';
                        setTimeout(() => {
                            message.textContent = '';
                            message.className = 'message';
                        }, 5000);
                        return;
                    }
                    memberships.push({
                        type: 'monthly',
                        duration: monthlyDuration
                    });
                }
                
                if (document.getElementById('combativeCheckbox').checked) {
                    const combativeSessions = parseInt(document.getElementById('combativeSessions').value);
                    if (isNaN(combativeSessions) || combativeSessions < 1) {
                        message.textContent = 'Please enter a valid number of combative sessions (at least 1)';
                        message.className = 'message error';
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Add Member';
                        setTimeout(() => {
                            message.textContent = '';
                            message.className = 'message';
                        }, 5000);
                        return;
                    }
                    memberships.push({
                        type: 'combative',
                        duration: combativeSessions
                    });
                }

                const memberData = {
                    name: document.getElementById('memberName').value.trim(),
                    memberships: memberships,
                    joinDate: document.getElementById('joinDate').value || new Date().toISOString().split('T')[0],
                    phone: formattedPhone,
                    email: document.getElementById('email').value.trim().toLowerCase() || undefined
                };

                console.log('Submitting:', JSON.stringify(memberData, null, 2));

                try {
                    const response = await fetch('https://flex-it-goalsgym-it-project-2.onrender.com/api/members', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                        },
                        body: JSON.stringify(memberData)
                    });

                    const responseData = await response.json();
                    
                    if (!response.ok) {
                        console.error('Backend validation error:', responseData);
                        let errorMsg = 'Submission failed';
                        if (responseData.details) {
                            errorMsg += ':\n' + Object.entries(responseData.details)
                                .map(([field, error]) => `• ${field}: ${error}`)
                                .join('\n');
                        }
                        throw new Error(errorMsg);
                    }

                    alert(`Member successfully added!\nUsername: ${responseData.data.username}\nTemporary Password: ${responseData.data.tempPassword}\n\nMember should change password upon first login.`);
                    memberForm.reset();
                    document.getElementById('monthlyCheckbox').checked = false;
                    document.getElementById('combativeCheckbox').checked = false;
                    document.getElementById('monthlyDetails').classList.add('hidden');
                    document.getElementById('combativeDetails').classList.add('hidden');
                    document.getElementById('joinDate').valueAsDate = new Date();
                } catch (error) {
                    console.error('Error:', error);
                    message.textContent = error.message;
                    message.className = 'message error';
                    setTimeout(() => {
                        message.textContent = '';
                        message.className = 'message';
                    }, 5000);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Add Member';
                }
            });
        });
    </script>
</body>
</html>