<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Transaction - Goals Gym</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7f9;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1, h2, h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section {
            margin-bottom: 25px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        textarea {
            min-height: 100px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .search-results {
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 5px;
        }
        
        .member-result {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .member-result:hover {
            background-color: #f8f9fa;
        }
        
        .member-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
        
        .member-info p {
            margin-bottom: 8px;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 10px;
            color: #7f8c8d;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .server-status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .server-connected {
            background-color: #d4edda;
            color: #155724;
        }
        
        .server-disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .step {
            text-align: center;
            flex: 1;
            padding: 10px;
            position: relative;
        }
        
        .step:not(:last-child):after {
            content: '';
            position: absolute;
            top: 50%;
            right: 0;
            width: 100%;
            height: 2px;
            background-color: #ddd;
            z-index: 1;
        }
        
        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background-color: #ddd;
            color: white;
            border-radius: 50%;
            line-height: 30px;
            margin-bottom: 5px;
            position: relative;
            z-index: 2;
        }
        
        .step.active .step-number {
            background-color: #3498db;
        }
        
        .step-title {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .step.active .step-title {
            color: #3498db;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Add Transaction</h1>
        
        <div id="serverStatus" class="server-status">Checking server connection...</div>
        
        <div id="successMessage" class="success hidden"></div>
        <div id="errorMessage" class="error hidden"></div>
        
        <div class="step-indicator">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-title">Select Member</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-title">Enter Details</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-title">Confirm</div>
            </div>
        </div>
        
        <!-- Member Selection Section -->
        <div class="card section">
            <h2>Step 1: Select Member</h2>
            <div class="form-group">
                <label for="memberSearch">Search for Member:</label>
                <input type="text" id="memberSearch" placeholder="Type member name or ID...">
                <div id="searchResults" class="search-results hidden"></div>
                <div id="searchLoading" class="loading hidden">Searching...</div>
            </div>
            
            <div id="selectedMember" class="member-info hidden">
                <h3>Selected Member</h3>
                <p><strong>Name:</strong> <span id="memberName"></span></p>
                <p><strong>ID:</strong> <span id="memberId"></span></p>
                <p><strong>Email:</strong> <span id="memberEmail"></span></p>
                <p><strong>Membership:</strong> <span id="memberType"></span></p>
                <button onclick="clearMemberSelection()">Change Member</button>
            </div>
        </div>
        
        <!-- Transaction Details Section -->
        <div class="card section">
            <h2>Step 2: Enter Transaction Details</h2>
            <form id="transactionForm" class="hidden">
                <div class="form-group">
                    <label for="amount">Amount Paid:</label>
                    <input type="number" id="amount" min="0" step="0.01" placeholder="Enter amount">
                </div>
                <div class="form-group">
                    <label for="paymentMethod">Payment Method:</label>
                    <select id="paymentMethod">
                        <option value="">Select method</option>
                        <option value="cash">Cash</option>
                        <option value="e-wallet">E-Wallet</option>
                        <option value="bank">Bank Transfer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="description">Description/Notes:</label>
                    <textarea id="description" placeholder="Optional notes about the transaction"></textarea>
                </div>
            </form>
        </div>
        
        <!-- Confirmation Section -->
        <div class="card section">
            <h2>Step 3: Confirm Transaction</h2>
            <div id="confirmationAction">
                <p>Please select a member and enter details first.</p>
                <button id="addTransactionButton" disabled onclick="addTransaction()">Add Transaction</button>
            </div>
            
            <div id="transactionResult" class="hidden">
                <h3>Transaction Result</h3>
                <div id="resultMessage"></div>
                <button onclick="resetForm()">Add Another Transaction</button>
            </div>
        </div>
    </div>

    <script>
        const SERVER_URL = 'https://flex-it-goalsgym-it-project-2.onrender.com';
        let selectedMember = null;
        let searchTimeout = null;

        document.addEventListener('DOMContentLoaded', async function() {
            await checkServerConnection();
            setupEventListeners();
        });

        async function checkServerConnection() {
            const statusElement = document.getElementById('serverStatus');
            try {
                const response = await fetch(`${SERVER_URL}/health`);
                if (response.ok) {
                    statusElement.textContent = 'Connected to server successfully';
                    statusElement.className = 'server-status server-connected';
                } else {
                    throw new Error('Server response not OK');
                }
            } catch (error) {
                statusElement.textContent = 'Cannot connect to server. Please try again later.';
                statusElement.className = 'server-status server-disconnected';
            }
        }

        function setupEventListeners() {
            // Member search with debounce
            document.getElementById('memberSearch').addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                
                if (query.length < 2) {
                    hideSearchResults();
                    return;
                }
                
                document.getElementById('searchLoading').classList.remove('hidden');
                
                searchTimeout = setTimeout(async () => {
                    await searchMembers(query);
                }, 300);
            });

            // Form inputs to enable button
            const formInputs = document.querySelectorAll('#transactionForm input, #transactionForm select, #transactionForm textarea');
            formInputs.forEach(input => {
                input.addEventListener('input', checkFormCompletion);
            });

            // Click outside to close search results
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#memberSearch') && !e.target.closest('#searchResults')) {
                    hideSearchResults();
                }
            });
        }

        async function searchMembers(query) {
            try {
                const response = await fetch(`${SERVER_URL}/api/members/search?query=${encodeURIComponent(query)}`);
                const resultsDiv = document.getElementById('searchResults');
                document.getElementById('searchLoading').classList.add('hidden');
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success && result.data && result.data.length > 0) {
                        resultsDiv.innerHTML = '';
                        result.data.forEach(member => {
                            const div = document.createElement('div');
                            div.className = 'member-result';
                            
                            const memberId = member.memberId || member.member_id || 'N/A';
                            const name = member.name || 'Unknown';
                            const email = member.email || 'No email';
                            
                            let membershipTypes = 'No membership';
                            if (member.memberships && Array.isArray(member.memberships)) {
                                membershipTypes = member.memberships.map(m => m.type).join(', ');
                            } else if (member.type) {
                                membershipTypes = member.type;
                            }
                            
                            div.innerHTML = `
                                <strong>${name}</strong> (${memberId})<br>
                                <small>${email} â€¢ ${membershipTypes}</small>
                            `;
                            div.onclick = () => selectMember(member);
                            resultsDiv.appendChild(div);
                        });
                        resultsDiv.classList.remove('hidden');
                    } else {
                        resultsDiv.innerHTML = '<div class="member-result">No members found</div>';
                        resultsDiv.classList.remove('hidden');
                    }
                } else {
                    throw new Error('Search failed');
                }
            } catch (error) {
                console.error('Search error:', error);
                showError('Failed to search members');
                hideSearchResults();
            }
        }

        function hideSearchResults() {
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('searchLoading').classList.add('hidden');
        }

        function selectMember(member) {
            selectedMember = member;
            
            const memberId = member.memberId || member.member_id || member._id || 'N/A';
            const name = member.name || 'Unknown';
            const email = member.email || 'No email';
            
            let membershipTypes = 'No membership';
            if (member.memberships && Array.isArray(member.memberships)) {
                membershipTypes = member.memberships.map(m => m.type).join(', ');
            }
            
            if (memberId === 'N/A') {
                showError('Selected member does not have a valid ID.');
                return;
            }
            
            document.getElementById('memberName').textContent = name;
            document.getElementById('memberId').textContent = memberId;
            document.getElementById('memberEmail').textContent = email;
            document.getElementById('memberType').textContent = membershipTypes;
            document.getElementById('selectedMember').classList.remove('hidden');
            
            hideSearchResults();
            document.getElementById('memberSearch').value = '';
            
            document.getElementById('transactionForm').classList.remove('hidden');
            checkFormCompletion();
            
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.add('active');
            document.getElementById('step3').classList.remove('active');
        }

        function clearMemberSelection() {
            selectedMember = null;
            document.getElementById('selectedMember').classList.add('hidden');
            document.getElementById('transactionForm').classList.add('hidden');
            document.getElementById('addTransactionButton').disabled = true;
            
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.remove('active');
        }

        function checkFormCompletion() {
            const amount = document.getElementById('amount').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            if (selectedMember && amount > 0 && paymentMethod) {
                document.getElementById('addTransactionButton').disabled = false;
                document.getElementById('step3').classList.add('active');
            } else {
                document.getElementById('addTransactionButton').disabled = true;
            }
        }

        async function addTransaction() {
            if (!selectedMember) {
                showError('Please select a member');
                return;
            }
            
            const memberId = selectedMember.memberId || selectedMember.member_id || selectedMember._id;
            if (!memberId) {
                showError('Invalid member ID');
                return;
            }
            
            const amount = parseFloat(document.getElementById('amount').value);
            const paymentMethod = document.getElementById('paymentMethod').value;
            const description = document.getElementById('description').value.trim();
            
            try {
                document.getElementById('addTransactionButton').disabled = true;
                document.getElementById('addTransactionButton').textContent = 'Adding...';
                
                const response = await fetch(`${SERVER_URL}/api/transactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        member_id: memberId,
                        amount,
                        payment_method: paymentMethod,
                        description: description || undefined
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showTransactionResult('success', `Transaction added successfully for ${selectedMember.name}. ID: ${result.data.transaction_id}`);
                } else {
                    showTransactionResult('error', result.error || 'Failed to add transaction');
                }
            } catch (error) {
                console.error('Transaction error:', error);
                showTransactionResult('error', 'Failed to add transaction: ' + error.message);
            } finally {
                document.getElementById('addTransactionButton').disabled = false;
                document.getElementById('addTransactionButton').textContent = 'Add Transaction';
            }
        }

        function showTransactionResult(type, message) {
            const resultDiv = document.getElementById('resultMessage');
            resultDiv.className = type;
            resultDiv.textContent = message;
            
            document.getElementById('confirmationAction').classList.add('hidden');
            document.getElementById('transactionResult').classList.remove('hidden');
        }

        function resetForm() {
            selectedMember = null;
            
            document.getElementById('selectedMember').classList.add('hidden');
            document.getElementById('transactionForm').classList.add('hidden');
            document.getElementById('amount').value = '';
            document.getElementById('paymentMethod').value = '';
            document.getElementById('description').value = '';
            document.getElementById('transactionResult').classList.add('hidden');
            document.getElementById('confirmationAction').classList.remove('hidden');
            document.getElementById('addTransactionButton').disabled = true;
            document.getElementById('memberSearch').value = '';
            
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.remove('active');
            
            hideMessages();
        }

        function showError(message) {
            const element = document.getElementById('errorMessage');
            element.textContent = message;
            element.classList.remove('hidden');
            setTimeout(() => { element.classList.add('hidden'); }, 5000);
        }

        function hideMessages() {
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }
    </script>
</body>
</html>