<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Transaction - GOALS Gym</title>
    <link rel="stylesheet" href="./admin-css/admin-mainpage.css">
    <link rel="stylesheet" href="./admin-css/add-transaction.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>GOALS Gym Admin</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="./add-classes.html"><span>Add Classes</span></a>
                <a href="./add-member.html"><span>Add Member</span></a>
                <a href="./manage-members.html"><span>Manage Member</span></a>
                <a href="./add-trainer.html"><span>Add Trainer</span></a>
                <a href="./manage-class-enrollment.html"><span>Manage Enrollment</span></a>
                <a href="./add-transaction.html"><span>Add Transaction</span></a>
                <a href="./view-classes-and-feedback.html"><span>View Classes</span></a>
                <a href="./trainer-schedule-management.html"><span>Trainer Schedule Management</span></a>
            </nav>
        </aside>

        <!-- Header -->
        <header class="header">
            <button class="menu-toggle" id="menuToggle">☰</button>
            <h1>Add Transaction</h1>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <div id="serverStatus" class="server-status">Checking server connection...</div>
                
                <div id="successMessage" class="success hidden"></div>
                <div id="errorMessage" class="error hidden"></div>
                
                <div class="step-indicator">
                    <div class="step active" id="step1">
                        <div class="step-number">1</div>
                        <div class="step-title">Select Member</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-number">2</div>
                        <div class="step-title">Enter Details</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-number">3</div>
                        <div class="step-title">Confirm</div>
                    </div>
                </div>
                
                <!-- Member Selection Section -->
                <div class="card section">
                    <h2>Step 1: Select Member</h2>
                    <div class="form-group">
                        <label for="memberSearch">Search for Member:</label>
                        <input type="text" id="memberSearch" placeholder="Type member name or ID...">
                        <div id="searchResults" class="search-results hidden"></div>
                        <div id="searchLoading" class="loading hidden">Searching...</div>
                    </div>
                    
                    <div id="selectedMember" class="member-info hidden">
                        <h3>Selected Member</h3>
                        <p><strong>Name:</strong> <span id="memberName"></span></p>
                        <p><strong>ID:</strong> <span id="memberId"></span></p>
                        <p><strong>Email:</strong> <span id="memberEmail"></span></p>
                        <p><strong>Membership:</strong> <span id="memberType"></span></p>
                        <button onclick="clearMemberSelection()">Change Member</button>
                    </div>
                </div>
                
                <!-- Transaction Details Section -->
                <div class="card section">
                    <h2>Step 2: Enter Transaction Details</h2>
                    <form id="transactionForm" class="hidden">
                        <div class="form-group">
                            <label for="amount">Amount Paid:</label>
                            <input type="number" id="amount" min="0" step="0.01" placeholder="Enter amount">
                        </div>
                        <div class="form-group">
                            <label for="paymentMethod">Payment Method:</label>
                            <select id="paymentMethod">
                                <option value="">Select method</option>
                                <option value="cash">Cash</option>
                                <option value="e-wallet">E-Wallet</option>
                                <option value="bank">Bank Transfer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="paymentDate">Payment Date:</label>
                            <input type="date" id="paymentDate">
                        </div>
                        <div class="form-group">
                            <label for="description">Description/Notes:</label>
                            <textarea id="description" placeholder="Optional notes about the transaction"></textarea>
                        </div>
                    </form>
                </div>
                
                <!-- Confirmation Section -->
                <div class="card section">
                    <h2>Step 3: Confirm Transaction</h2>
                    <div id="confirmationAction">
                        <p>Please select a member and enter details first.</p>
                        <button id="addTransactionButton" disabled onclick="addTransaction()">Add Transaction</button>
                    </div>
                    
                    <div id="transactionResult" class="hidden">
                        <h3>Transaction Result</h3>
                        <div id="resultMessage"></div>
                        <button onclick="resetForm()">Add Another Transaction</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const SERVER_URL = 'https://flex-it-goalsgym-it-project-2.onrender.com';
        let selectedMember = null;
        let searchTimeout = null;

        document.addEventListener('DOMContentLoaded', async function() {
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.querySelector('.sidebar');
            const logoutBtn = document.getElementById('logoutBtn');
            const authUser = JSON.parse(localStorage.getItem('authUser'));

            // Check valid session (1 hour expiration)
            if (!authUser || (Date.now() - authUser.timestamp > 3600000)) {
                localStorage.removeItem('authUser');
                window.location.href = '../admin-login.html';
                return;
            }

            // Toggle sidebar on smaller screens
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
            });

            // Logout handler
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('authUser');
                window.location.href = '../admin-login.html';
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                    sidebar.classList.remove('collapsed');
                }
            });

            // Prevent body scroll when sidebar is open on mobile
            sidebar.addEventListener('transitionend', () => {
                if (window.innerWidth <= 768 && sidebar.classList.contains('collapsed')) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = 'auto';
                }
            });

            await checkServerConnection();
            setupEventListeners();
        });

        async function checkServerConnection() {
            const statusElement = document.getElementById('serverStatus');
            try {
                const response = await fetch(`${SERVER_URL}/health`);
                if (response.ok) {
                    statusElement.textContent = 'Connected to server successfully';
                    statusElement.className = 'server-status server-connected';
                } else {
                    throw new Error('Server response not OK');
                }
            } catch (error) {
                statusElement.textContent = 'Cannot connect to server. Please try again later.';
                statusElement.className = 'server-status server-disconnected';
            }
        }

        function setupEventListeners() {
            // Member search with debounce
            document.getElementById('memberSearch').addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                
                if (query.length < 2) {
                    hideSearchResults();
                    return;
                }
                
                document.getElementById('searchLoading').classList.remove('hidden');
                
                searchTimeout = setTimeout(async () => {
                    await searchMembers(query);
                }, 300);
            });

            // Form inputs to enable button
            const formInputs = document.querySelectorAll('#transactionForm input, #transactionForm select, #transactionForm textarea');
            formInputs.forEach(input => {
                input.addEventListener('input', checkFormCompletion);
            });

            // Click outside to close search results
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#memberSearch') && !e.target.closest('#searchResults')) {
                    hideSearchResults();
                }
            });
        }

        async function searchMembers(query) {
            try {
                const response = await fetch(`${SERVER_URL}/api/members/search?query=${encodeURIComponent(query)}`);
                const resultsDiv = document.getElementById('searchResults');
                document.getElementById('searchLoading').classList.add('hidden');
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success && result.data && result.data.length > 0) {
                        resultsDiv.innerHTML = '';
                        result.data.forEach(member => {
                            const div = document.createElement('div');
                            div.className = 'member-result';
                            
                            const memberId = member.memberId || member.member_id || 'N/A';
                            const name = member.name || 'Unknown';
                            const email = member.email || 'No email';
                            
                            let membershipTypes = 'No membership';
                            if (member.memberships && Array.isArray(member.memberships)) {
                                membershipTypes = member.memberships.map(m => m.type).join(', ');
                            } else if (member.type) {
                                membershipTypes = member.type;
                            }
                            
                            div.innerHTML = `
                                <strong>${name}</strong> (${memberId})<br>
                                <small>${email} • ${membershipTypes}</small>
                            `;
                            div.onclick = () => selectMember(member);
                            resultsDiv.appendChild(div);
                        });
                        resultsDiv.classList.remove('hidden');
                    } else {
                        resultsDiv.innerHTML = '<div class="member-result">No members found</div>';
                        resultsDiv.classList.remove('hidden');
                    }
                } else {
                    throw new Error('Search failed');
                }
            } catch (error) {
                console.error('Search error:', error);
                showError('Failed to search members');
                hideSearchResults();
            }
        }

        function hideSearchResults() {
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('searchLoading').classList.add('hidden');
        }

        function selectMember(member) {
            selectedMember = member;
            
            const memberId = member.memberId || member.member_id || member._id || 'N/A';
            const name = member.name || 'Unknown';
            const email = member.email || 'No email';
            
            let membershipTypes = 'No membership';
            if (member.memberships && Array.isArray(member.memberships)) {
                membershipTypes = member.memberships.map(m => m.type).join(', ');
            }
            
            if (memberId === 'N/A') {
                showError('Selected member does not have a valid ID.');
                return;
            }
            
            document.getElementById('memberName').textContent = name;
            document.getElementById('memberId').textContent = memberId;
            document.getElementById('memberEmail').textContent = email;
            document.getElementById('memberType').textContent = membershipTypes;
            document.getElementById('selectedMember').classList.remove('hidden');
            
            hideSearchResults();
            document.getElementById('memberSearch').value = '';
            
            document.getElementById('transactionForm').classList.remove('hidden');
            checkFormCompletion();
            
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.add('active');
            document.getElementById('step3').classList.remove('active');
        }

        function clearMemberSelection() {
            selectedMember = null;
            document.getElementById('selectedMember').classList.add('hidden');
            document.getElementById('transactionForm').classList.add('hidden');
            document.getElementById('addTransactionButton').disabled = true;
            
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.remove('active');
        }

        function checkFormCompletion() {
            const amount = document.getElementById('amount').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const paymentDate = document.getElementById('paymentDate').value;
            
            if (selectedMember && amount > 0 && paymentMethod && paymentDate) {
                document.getElementById('addTransactionButton').disabled = false;
                document.getElementById('step3').classList.add('active');
            } else {
                document.getElementById('addTransactionButton').disabled = true;
            }
        }

        async function addTransaction() {
            if (!selectedMember) {
                showError('Please select a member');
                return;
            }
            
            const memberId = selectedMember.memberId || selectedMember.member_id || selectedMember._id;
            if (!memberId) {
                showError('Invalid member ID');
                return;
            }
            
            const amount = parseFloat(document.getElementById('amount').value);
            const paymentMethod = document.getElementById('paymentMethod').value;
            const paymentDate = document.getElementById('paymentDate').value;
            const description = document.getElementById('description').value.trim();
            
            try {
                document.getElementById('addTransactionButton').disabled = true;
                document.getElementById('addTransactionButton').textContent = 'Adding...';
                
                const response = await fetch(`${SERVER_URL}/api/transactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        member_id: memberId,
                        amount,
                        payment_method: paymentMethod,
                        payment_date: paymentDate,
                        description: description || undefined
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showTransactionResult('success', `Transaction added successfully for ${selectedMember.name}. ID: ${result.data.transaction_id}`);
                } else {
                    showTransactionResult('error', result.error || 'Failed to add transaction');
                }
            } catch (error) {
                console.error('Transaction error:', error);
                showTransactionResult('error', 'Failed to add transaction: ' + error.message);
            } finally {
                document.getElementById('addTransactionButton').disabled = false;
                document.getElementById('addTransactionButton').textContent = 'Add Transaction';
            }
        }

        function showTransactionResult(type, message) {
            const resultDiv = document.getElementById('resultMessage');
            resultDiv.className = type;
            resultDiv.textContent = message;
            
            document.getElementById('confirmationAction').classList.add('hidden');
            document.getElementById('transactionResult').classList.remove('hidden');
        }

        function resetForm() {
            selectedMember = null;
            
            document.getElementById('selectedMember').classList.add('hidden');
            document.getElementById('transactionForm').classList.add('hidden');
            document.getElementById('amount').value = '';
            document.getElementById('paymentMethod').value = '';
            document.getElementById('paymentDate').value = '';
            document.getElementById('description').value = '';
            document.getElementById('transactionResult').classList.add('hidden');
            document.getElementById('confirmationAction').classList.remove('hidden');
            document.getElementById('addTransactionButton').disabled = true;
            document.getElementById('memberSearch').value = '';
            
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.remove('active');
            
            hideMessages();
        }

        function showError(message) {
            const element = document.getElementById('errorMessage');
            element.textContent = message;
            element.classList.remove('hidden');
            setTimeout(() => { element.classList.add('hidden'); }, 5000);
        }

        function hideMessages() {
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }
    </script>
</body>
</html>
