<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Class - GOALS Gym</title>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.9/index.global.min.js'></script>
    <link rel="stylesheet" href="./admin-css/admin-mainpage.css">
    <link rel="stylesheet" href="./admin-css/add-classes.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>GOALS Gym Admin</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="./admin-mainpage.html"><span>Dashboard</span></a>
                <a href="./add-classes.html" class="active"><span>Add Classes</span></a>
                <a href="./add-member.html"><span>Add Member</span></a>
                <a href="./manage-members.html"><span>Manage Member</span></a>
                <a href="./add-trainer.html"><span>Add Trainer</span></a>
                <a href="./manage-trainer.html"><span>Manage Trainer</span></a>
                <a href="./manage-class-enrollment.html"><span>Manage Enrollment</span></a>
                <a href="./add-transaction.html"><span>Add Transaction</span></a>
                <a href="./view-classes-and-feedback.html"><span>View Classes</span></a>
                <a href="./trainer-schedule-management.html"><span>Trainer Schedule Management</span></a>
                <a href="./attendance-checker.html"><span>Attendance System</span></a>
            </nav>
        </aside>

        <!-- Header -->
        <header class="header">
            <button class="menu-toggle" id="menuToggle">â˜°</button>
            <h1>Add Class</h1>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <div id="serverStatus" class="server-status">Checking server connection...</div>
                <div id="successMessage" class="success-message"></div>
                <div id="formSection" class="section active">
                    <h2>Add New Class</h2>
                    <form id="classForm">
                        <div class="form-group">
                            <label for="class_name">Class Name:</label>
                            <input type="text" id="class_name" name="class_name" required>
                        </div>
                        <div class="form-group">
                            <label for="description">Description:</label>
                            <textarea id="description" name="description" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="trainer_id">Trainer:</label>
                            <select id="trainer_id" name="trainer_id" required>
                                <option value="">Loading trainers...</option>
                            </select>
                            <div id="trainerError" class="error" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label for="capacity">Capacity:</label>
                            <input type="number" id="capacity" name="capacity" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="schedule_type">Schedule Type:</label>
                            <select id="schedule_type" name="schedule_type" required>
                                <option value="">Select schedule type</option>
                                <option value="one-time">One-time Class</option>
                                <option value="weekly">Weekly Recurring</option>
                                <option value="monthly">Monthly (4 weeks)</option>
                            </select>
                        </div>
                        <div id="oneTimeSchedule" class="section">
                            <div class="form-group">
                                <label for="class_date">Class Date:</label>
                                <input type="date" id="class_date" name="class_date">
                            </div>
                            <div class="form-group">
                                <label for="one_start_time">Start Time:</label>
                                <input type="time" id="one_start_time" name="one_start_time" min="06:00" max="22:00">
                            </div>
                            <div class="form-group">
                                <label for="one_end_time">End Time:</label>
                                <input type="time" id="one_end_time" name="one_end_time" min="06:00" max="22:00">
                            </div>
                        </div>
                        <div id="recurringSchedule" class="section">
                            <div class="form-group">
                                <label>Select Days of Week:</label>
                                <div class="checkbox-group">
                                    <label><input type="checkbox" name="days" value="Monday"> Monday</label>
                                    <label><input type="checkbox" name="days" value="Tuesday"> Tuesday</label>
                                    <label><input type="checkbox" name="days" value="Wednesday"> Wednesday</label>
                                    <label><input type="checkbox" name="days" value="Thursday"> Thursday</label>
                                    <label><input type="checkbox" name="days" value="Friday"> Friday</label>
                                    <label><input type="checkbox" name="days" value="Saturday"> Saturday</label>
                                    <label><input type="checkbox" name="days" value="Sunday"> Sunday</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="start_time">Start Time:</label>
                                <input type="time" id="start_time" name="start_time" min="06:00" max="22:00">
                            </div>
                            <div class="form-group">
                                <label for="end_time">End Time:</label>
                                <input type="time" id="end_time" name="end_time" min="06:00" max="22:00">
                            </div>
                            <div id="weeklyOptions" class="section">
                                <div class="form-group">
                                    <label for="start_date">Start Date:</label>
                                    <input type="date" id="start_date" name="start_date">
                                </div>
                                <div class="form-group">
                                    <label for="end_date">End Date (optional):</label>
                                    <input type="date" id="end_date" name="end_date">
                                </div>
                            </div>
                            <div id="monthlyOptions" class="section">
                                <div class="form-group">
                                    <label for="month_start">Month Start Date:</label>
                                    <input type="date" id="month_start" name="month_start">
                                </div>
                                <div class="form-group">
                                    <label for="week_of_month">Week of Month:</label>
                                    <select id="week_of_month" name="week_of_month">
                                        <option value="all">All weeks</option>
                                        <option value="1">First week only</option>
                                        <option value="2">Second week only</option>
                                        <option value="3">Third week only</option>
                                        <option value="4">Fourth week only</option>
                                        <option value="1,3">First and Third weeks</option>
                                        <option value="2,4">Second and Fourth weeks</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Schedule Preview:</label>
                            <div id="schedulePreview">Please select schedule type and complete the information above</div>
                            <input type="hidden" id="schedule" name="schedule" required>
                        </div>
                        <div class="nav-buttons">
                            <button type="submit">Add Class</button>
                            <button type="button" onclick="showScheduleView()">View Schedule Calendar</button>
                        </div>
                    </form>
                </div>
                <div id="scheduleViewSection" class="section">
                    <h2>Class Schedule Calendar</h2>
                    <div id="calendar"></div>
                    <div class="nav-buttons">
                        <button type="button" onclick="showFormView()">Back to Add Class</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
<script>
    const SERVER_URL = 'http://localhost:8080';
    let calendar;
    let allClasses = [];

    document.addEventListener('DOMContentLoaded', async function() {
        await checkServerConnection();
        fetchTrainers();
        setupEventListeners();
        setMinimumDates();
        setupSidebarAndSession();
    });

    async function checkServerConnection() {
        const statusElement = document.getElementById('serverStatus');
        try {
            const response = await fetch(`${SERVER_URL}/health`);
            if (response.ok) {
                statusElement.textContent = 'Connected to server successfully';
                statusElement.className = 'server-status server-connected';
            } else {
                throw new Error('Server response not OK');
            }
        } catch (error) {
            statusElement.textContent = 'Cannot connect to server. Please try again later.';
            statusElement.className = 'server-status server-disconnected';
            console.error('Server connection error:', error);
        }
    }

    function setupSidebarAndSession() {
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.querySelector('.sidebar');
        const logoutBtn = document.getElementById('logoutBtn');
        const authUser = JSON.parse(localStorage.getItem('authUser'));

        menuToggle.addEventListener('click', () => sidebar.classList.toggle('collapsed'));

        if (!authUser || (Date.now() - authUser.timestamp > 3600000)) {
            localStorage.removeItem('authUser');
            window.location.href = '../admin-login.html';
            return;
        }

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('authUser');
            window.location.href = '../admin-login.html';
        });
    }

    function setupEventListeners() {
        document.getElementById('schedule_type').addEventListener('change', toggleScheduleSection);
        document.getElementById('class_date').addEventListener('change', updateSchedulePreview);
        document.getElementById('one_start_time').addEventListener('change', updateSchedulePreview);
        document.getElementById('one_end_time').addEventListener('change', updateSchedulePreview);
        document.querySelectorAll('input[name="days"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateSchedulePreview);
        });
        document.getElementById('start_time').addEventListener('change', updateSchedulePreview);
        document.getElementById('end_time').addEventListener('change', updateSchedulePreview);
        document.getElementById('start_date').addEventListener('change', updateSchedulePreview);
        document.getElementById('end_date').addEventListener('change', updateSchedulePreview);
        document.getElementById('month_start').addEventListener('change', updateSchedulePreview);
        document.getElementById('week_of_month').addEventListener('change', updateSchedulePreview);
        document.getElementById('classForm').addEventListener('submit', handleFormSubmit);
    }

    function setMinimumDates() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('class_date').setAttribute('min', today);
        document.getElementById('start_date').setAttribute('min', today);
        document.getElementById('end_date').setAttribute('min', today);
        document.getElementById('month_start').setAttribute('min', today);
    }

    // THIS IS THE CRITICAL FUNCTION THAT WAS MISSING
    async function fetchTrainers() {
        const trainerSelect = document.getElementById('trainer_id');
        const errorDiv = document.getElementById('trainerError');
        
        trainerSelect.innerHTML = '<option value="">Loading trainers...</option>';
        if (errorDiv) errorDiv.style.display = 'none';
        
        try {
            const response = await fetch(`${SERVER_URL}/api/trainers`, {
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    trainerSelect.innerHTML = '<option value="">Select a trainer</option>';
                    
                    result.data.forEach(trainer => {
                        const option = document.createElement('option');
                        option.value = trainer.trainer_id;
                        option.textContent = `${trainer.name} (${trainer.specialization})`;
                        trainerSelect.appendChild(option);
                    });
                    
                    if (errorDiv) errorDiv.style.display = 'none';
                } else {
                    trainerSelect.innerHTML = '<option value="">No trainers available</option>';
                    if (errorDiv) {
                        errorDiv.textContent = 'No trainers found in the system';
                        errorDiv.style.display = 'block';
                    }
                }
            } else {
                trainerSelect.innerHTML = '<option value="">Error loading trainers</option>';
                if (errorDiv) {
                    errorDiv.textContent = `Server error: ${response.status} ${response.statusText}`;
                    errorDiv.style.display = 'block';
                }
            }
        } catch (error) {
            console.error('Error fetching trainers:', error);
            trainerSelect.innerHTML = '<option value="">Error loading trainers</option>';
            if (errorDiv) {
                errorDiv.textContent = `Network error: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        }
    }

    function toggleScheduleSection() {
        const scheduleType = document.getElementById('schedule_type').value;
        const oneTimeSchedule = document.getElementById('oneTimeSchedule');
        const recurringSchedule = document.getElementById('recurringSchedule');
        const weeklyOptions = document.getElementById('weeklyOptions');
        const monthlyOptions = document.getElementById('monthlyOptions');
        
        document.querySelectorAll('.section').forEach(section => {
            if (section.id !== 'formSection' && section.id !== 'scheduleViewSection') {
                section.style.display = 'none';
            }
        });
        
        if (scheduleType === 'one-time') {
            oneTimeSchedule.style.display = 'block';
        } else if (scheduleType === 'weekly') {
            recurringSchedule.style.display = 'block';
            weeklyOptions.style.display = 'block';
        } else if (scheduleType === 'monthly') {
            recurringSchedule.style.display = 'block';
            monthlyOptions.style.display = 'block';
        }
        
        updateSchedulePreview();
    }

    function updateSchedulePreview() {
        const scheduleType = document.getElementById('schedule_type').value;
        const scheduleInput = document.getElementById('schedule');
        const schedulePreview = document.getElementById('schedulePreview');
        
        if (!scheduleType) {
            schedulePreview.textContent = 'Please select schedule type and complete the information above';
            scheduleInput.value = '';
            return;
        }
        
        const formatTime = (time24) => {
            if (!time24) return '';
            const [hours, minutes] = time24.split(':');
            const hour12 = hours % 12 || 12;
            const ampm = hours < 12 ? 'AM' : 'PM';
            return `${hour12}:${minutes} ${ampm}`;
        };
        
        let scheduleText = '';
        
        if (scheduleType === 'one-time') {
            const date = document.getElementById('class_date').value;
            const startTime = document.getElementById('one_start_time').value;
            const endTime = document.getElementById('one_end_time').value;
            
            if (date && startTime && endTime) {
                if (startTime >= endTime) {
                    schedulePreview.textContent = 'End time must be after start time';
                    scheduleInput.value = '';
                    return;
                }
                
                const formattedDate = new Date(date).toLocaleDateString('en-US', { 
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                });
                scheduleText = `One-time: ${formattedDate}, ${formatTime(startTime)} - ${formatTime(endTime)}`;
            }
        } else if (scheduleType === 'weekly' || scheduleType === 'monthly') {
            const selectedDays = Array.from(document.querySelectorAll('input[name="days"]:checked')).map(cb => cb.value);
            const startTime = document.getElementById('start_time').value;
            const endTime = document.getElementById('end_time').value;
            
            if (selectedDays.length > 0 && startTime && endTime) {
                if (startTime >= endTime) {
                    schedulePreview.textContent = 'End time must be after start time';
                    scheduleInput.value = '';
                    return;
                }
                
                const daysText = selectedDays.join(', ');
                
                if (scheduleType === 'weekly') {
                    const startDate = document.getElementById('start_date').value;
                    const endDate = document.getElementById('end_date').value;
                    let dateRange = startDate ? ` (Starting ${new Date(startDate).toLocaleDateString()})` : '';
                    if (startDate && endDate) {
                        dateRange = ` (${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()})`;
                    }
                    scheduleText = `Weekly: ${daysText}, ${formatTime(startTime)} - ${formatTime(endTime)}${dateRange}`;
                } else {
                    const monthStart = document.getElementById('month_start').value;
                    scheduleText = `Monthly (4 weeks): ${daysText}, ${formatTime(startTime)} - ${formatTime(endTime)}`;
                }
            }
        }
        
        if (scheduleText) {
            schedulePreview.textContent = scheduleText;
            scheduleInput.value = scheduleText;
        } else {
            schedulePreview.textContent = 'Please complete all required information';
            scheduleInput.value = '';
        }
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const classData = {
            class_name: formData.get('class_name').trim(),
            description: formData.get('description').trim(),
            schedule: formData.get('schedule').trim(),
            trainer_id: formData.get('trainer_id'),
            capacity: parseInt(formData.get('capacity'))
        };

        if (!classData.trainer_id) {
            alert('Please select a trainer');
            return;
        }

        if (!classData.schedule) {
            alert('Please complete the schedule information');
            return;
        }

        try {
            const response = await fetch(`${SERVER_URL}/api/classes`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                },
                body: JSON.stringify(classData)
            });

            const responseData = await response.json();
            
            if (response.ok) {
                showSuccess('Class successfully added!');
                document.getElementById('classForm').reset();
                updateSchedulePreview();
                fetchTrainers();
                if (calendar) loadClassesIntoCalendar();
            } else {
                throw new Error(responseData.error || 'Submission failed');
            }
        } catch (error) {
            console.error('Error:', error);
            alert(error.message);
        }
    }

    function showSuccess(message) {
        const successElement = document.getElementById('successMessage');
        successElement.textContent = message;
        successElement.style.display = 'block';
        setTimeout(() => successElement.style.display = 'none', 5000);
    }

    function showScheduleView() {
        document.getElementById('formSection').classList.remove('active');
        document.getElementById('scheduleViewSection').classList.add('active');
        initCalendar();
    }

    function showFormView() {
        document.getElementById('scheduleViewSection').classList.remove('active');
        document.getElementById('formSection').classList.add('active');
    }

    function initCalendar() {
        if (calendar) {
            calendar.render();
            loadClassesIntoCalendar();
            return;
        }
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            height: 500,
            slotMinTime: '06:00:00',
            slotMaxTime: '22:00:00',
            events: []
        });
        calendar.render();
        loadClassesIntoCalendar();
    }

    async function loadClassesIntoCalendar() {
        if (!calendar) return;
        try {
            const response = await fetch(`${SERVER_URL}/api/classes`);
            if (response.ok) {
                const result = await response.json();
                if (result.success && result.data) {
                    calendar.removeAllEvents();
                    // Add your calendar event parsing logic here
                }
            }
        } catch (error) {
            console.error('Error loading classes:', error);
        }
    }
</script>
</body>
</html>