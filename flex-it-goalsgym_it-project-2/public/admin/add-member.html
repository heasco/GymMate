<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Member - GOALS Gym</title>
    <link rel="stylesheet" href="./admin-css/admin-mainpage.css">
    <link rel="stylesheet" href="./admin-css/add-member.css">
    <script src="https://kit.fontawesome.com/1d0b8c9b1d.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>GOALS Gym Admin</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="./admin-mainpage.html"><span>Dashboard</span></a>
                <a href="./add-classes.html"><span>Add Classes</span></a>
                <a href="./add-member.html" class="active"><span>Add Member</span></a>
                <a href="./manage-members.html"><span>Manage Member</span></a>
                <a href="./add-trainer.html"><span>Add Trainer</span></a>
                <a href="./manage-trainer.html"><span>Manage Trainer</span></a>
                <a href="./manage-class-enrollment.html"><span>Manage Enrollment</span></a>
                <a href="./add-transaction.html"><span>Add Transaction</span></a>
                <a href="./view-classes-and-feedback.html"><span>View Classes</span></a>
                <a href="./trainer-schedule-management.html"><span>Trainer Schedule Management</span></a>
            </nav>
        </aside>

        <!-- Header -->
        <header class="header">
            <button class="menu-toggle" id="menuToggle">â˜°</button>
            <h1>Add Member</h1>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <h2>Add New Member</h2>
            <form id="memberForm" class="member-form">
                <div class="form-group">
                    <label for="memberName">Full Name *</label>
                    <input type="text" id="memberName" name="memberName" required>
                </div>

                <div class="form-group">
                    <label>Membership Type(s) *</label>
                    <div class="checkbox-group">
                        <label class="checkbox">
                            <input type="checkbox" id="monthlyCheckbox" name="membershipTypes" value="monthly">
                            Monthly Gym Membership
                        </label>
                        <label class="checkbox">
                            <input type="checkbox" id="combativeCheckbox" name="membershipTypes" value="combative">
                            Combative Sports Membership
                        </label>
                    </div>
                </div>

                <div class="form-group membership-details" id="monthlyDetails">
                    <label for="monthlyDuration">Duration (months):</label>
                    <input type="number" id="monthlyDuration" name="monthlyDuration" min="1" value="1">
                </div>

                <div class="form-group membership-details" id="combativeDetails">
                    <label for="combativeSessions">Number of Sessions:</label>
                    <input type="number" id="combativeSessions" name="combativeSessions" min="1" value="12">
                </div>

                <div class="form-group">
                    <label for="joinDate">Join Date *</label>
                    <input type="date" id="joinDate" name="joinDate" required>
                </div>

                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" name="phone">
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email">
                </div>

                <div class="form-group">
                    <label>Facial Recognition Enrollment</label>
                    <div class="fp-controls">
                        <input type="hidden" id="faceEnrolled" name="faceEnrolled">
                        <button type="button" class="face-capture-btn" id="openFacePaneBtn">
                            <i class="fas fa-user-check"></i>
                            Capture Face
                        </button>
                        <span id="faceStatus" class="fp-status-message"></span>
                    </div>
                </div>

                <button type="submit" class="submit-btn">Add Member</button>
            </form>

            <div id="message" class="message hidden"></div>
        </main>
    </div>

    <!-- Face Capture Modal -->
    <div id="facePane" class="face-pane">
        <div class="face-modal">
            <h3>Facial Enrollment</h3>
            <div class="face-capture-area">
                <video id="camera" autoplay></video>
                <canvas id="snapshot"></canvas>
                <div class="face-center-box"></div>
            </div>
            <div class="face-controls">
                <button type="button" class="btn-primary" id="captureFaceBtn">Capture Photo</button>
                <button type="button" class="btn-success" id="confirmFaceBtn" disabled>Confirm & Save</button>
                <button type="button" class="btn-secondary" id="closeFacePaneBtn">Close</button>
            </div>
            <div id="faceResultMsg" class="face-result-msg"></div>
        </div>
    </div>

    <script>
        const SERVER_URL = 'http://localhost:8080';
        let faceImageBlob = null;
        let faceSuccessfullyCaptured = false;

        document.addEventListener('DOMContentLoaded', () => {
            setupSidebarAndSession();
            initializeForm();
        });

        // Simple logout function - same as admin-mainpage
        function setupSidebarAndSession() {
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.querySelector('.sidebar');
            const logoutBtn = document.getElementById('logoutBtn');
            const authUser = JSON.parse(localStorage.getItem('authUser'));

            menuToggle.addEventListener('click', () => sidebar.classList.toggle('collapsed'));

            if (!authUser || (Date.now() - authUser.timestamp > 3600000)) {
                localStorage.removeItem('authUser');
                window.location.href = '../admin-login.html';
                return;
            }

            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('authUser');
                window.location.href = '../admin-login.html';
            });

            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                    sidebar.classList.remove('collapsed');
                }
            });
        }

        function initializeForm() {
            const memberForm = document.getElementById('memberForm');
            
            // Set default join date
            document.getElementById('joinDate').valueAsDate = new Date();

            // Membership type toggles
            document.getElementById('monthlyCheckbox').addEventListener('change', function() {
                document.getElementById('monthlyDetails').style.display = this.checked ? "block" : "none";
            });

            document.getElementById('combativeCheckbox').addEventListener('change', function() {
                document.getElementById('combativeDetails').style.display = this.checked ? "block" : "none";
            });

            // Form submission
            memberForm.addEventListener('submit', handleFormSubmit);

            // Face capture functionality
            setupFaceCapture();
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.textContent;
            
            btn.disabled = true;
            btn.textContent = 'Adding...';

            const memberships = [];
            if (document.getElementById('monthlyCheckbox').checked) {
                memberships.push({ 
                    type: 'monthly', 
                    duration: parseInt(document.getElementById('monthlyDuration').value) 
                });
            }
            if (document.getElementById('combativeCheckbox').checked) {
                memberships.push({ 
                    type: 'combative', 
                    duration: parseInt(document.getElementById('combativeSessions').value) 
                });
            }

            if (memberships.length === 0) {
                showMessage("Please select at least one membership type", "error");
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }

            const formData = new FormData();
            formData.append('name', document.getElementById('memberName').value.trim());
            formData.append('joinDate', document.getElementById('joinDate').value);
            formData.append('phone', document.getElementById('phone').value.trim() || '');
            formData.append('email', document.getElementById('email').value.trim() || '');
            formData.append('faceEnrolled', faceSuccessfullyCaptured ? 'yes' : 'no');
            formData.append('memberships', JSON.stringify(memberships));
            
            if (faceImageBlob) {
                formData.append('faceImage', faceImageBlob, 'face.jpg');
            }

            try {
                const response = await fetch(`${SERVER_URL}/api/members`, {
                    method: 'POST',
                    body: formData
                });
                
                const responseData = await response.json();
                
                if (!response.ok) {
                    throw new Error(responseData.error || 'Submission failed');
                }

                showMessage("Member added successfully!", "success");
                memberForm.reset();
                resetFaceCapture();
                document.getElementById('joinDate').valueAsDate = new Date();
                
            } catch (error) {
                showMessage(error.message || 'Error submitting form!', "error");
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function setupFaceCapture() {
            const openFacePaneBtn = document.getElementById('openFacePaneBtn');
            const facePane = document.getElementById('facePane');
            const camera = document.getElementById('camera');
            const snapshot = document.getElementById('snapshot');
            const captureFaceBtn = document.getElementById('captureFaceBtn');
            const confirmFaceBtn = document.getElementById('confirmFaceBtn');
            const closeFacePaneBtn = document.getElementById('closeFacePaneBtn');
            const faceResultMsg = document.getElementById('faceResultMsg');
            const faceStatus = document.getElementById('faceStatus');

            openFacePaneBtn.addEventListener('click', () => {
                facePane.style.display = "flex";
                resetFaceCaptureUI();
                faceResultMsg.textContent = "Allow camera access and center your face in the yellow box.";
                
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(stream => { camera.srcObject = stream; })
                    .catch(err => { 
                        faceResultMsg.textContent = "Camera error: " + err; 
                    });
            });

            captureFaceBtn.addEventListener('click', () => {
                if (!camera.srcObject) {
                    faceResultMsg.textContent = "No camera stream!";
                    return;
                }

                const context = snapshot.getContext('2d');
                context.drawImage(camera, 0, 0, snapshot.width, snapshot.height);
                
                camera.srcObject.getTracks().forEach(track => track.stop());
                camera.style.display = "none";
                snapshot.style.display = "block";
                
                snapshot.toBlob(function(blob) {
                    faceImageBlob = blob;
                    faceResultMsg.textContent = "Face photo captured. Click Confirm to enroll.";
                    confirmFaceBtn.disabled = false;
                }, 'image/jpeg', 0.92);
            });

            confirmFaceBtn.addEventListener('click', () => {
                if (!faceImageBlob) {
                    faceResultMsg.textContent = "No face image captured!";
                    return;
                }

                faceSuccessfullyCaptured = true;
                faceStatus.textContent = "Face ready to save!";
                faceStatus.className = "fp-status-message success";
                facePane.style.display = "none";
            });

            closeFacePaneBtn.addEventListener('click', () => {
                if (camera.srcObject) {
                    camera.srcObject.getTracks().forEach(track => track.stop());
                }
                facePane.style.display = "none";
                resetFaceCaptureUI();
            });
        }

        function resetFaceCapture() {
            faceImageBlob = null;
            faceSuccessfullyCaptured = false;
            document.getElementById('faceStatus').textContent = "";
            document.getElementById('faceStatus').className = "fp-status-message";
        }

        function resetFaceCaptureUI() {
            const camera = document.getElementById('camera');
            const snapshot = document.getElementById('snapshot');
            const confirmFaceBtn = document.getElementById('confirmFaceBtn');
            
            camera.style.display = "block";
            snapshot.style.display = "none";
            confirmFaceBtn.disabled = true;
            faceImageBlob = null;
            faceSuccessfullyCaptured = false;
        }

        function showMessage(message, type) {
            const messageEl = document.getElementById("message");
            messageEl.textContent = message;
            messageEl.className = `message ${type}`;
            messageEl.classList.remove("hidden");
            
            setTimeout(() => { 
                messageEl.classList.add("hidden"); 
            }, 5000);
        }
    </script>
</body>
</html>