<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trainer Schedule Management - GOALS Gym</title>
    <link rel="stylesheet" href="./admin-css/admin-mainpage.css">
    <link rel="stylesheet" href="./admin-css/trainer-schedule-management.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>GOALS Gym Admin</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="./admin-mainpage.html"><span>Dashboard</span></a>
                <a href="./add-classes.html"><span>Add Classes</span></a>
                <a href="./add-member.html"><span>Add Member</span></a>
                <a href="./manage-members.html"><span>Manage Member</span></a>
                <a href="./add-trainer.html"><span>Add Trainer</span></a>
                <a href="./manage-trainer.html"><span>Manage Trainer</span></a>
                <a href="./manage-class-enrollment.html"><span>Manage Enrollment</span></a>
                <a href="./add-transaction.html"><span>Add Transaction</span></a>
                <a href="./view-classes-and-feedback.html"><span>View Classes</span></a>
                <a href="./trainer-schedule-management.html" class="active"><span>Trainer Schedule Management</span></a>
            </nav>
        </aside>

        <!-- Header -->
        <header class="header">
            <button class="menu-toggle" id="menuToggle">â˜°</button>
            <h1>Trainer Schedule Management</h1>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <h2>View & Edit Classes</h2>
                <div id="serverStatus" class="server-status">Checking server connection...</div>
                <div id="successMessage" class="success-message"></div>
                <div id="errorMessage" class="error-message"></div>

                <div class="section">
                    <h3>Classes List</h3>
                    
                    <div class="form-group">
                        <label for="classSearch">Search Classes:</label>
                        <input type="text" id="classSearch" placeholder="Search by name, schedule, or trainer...">
                    </div>

                    <div class="form-group">
                        <label for="scheduleType">Schedule Type:</label>
                        <select id="scheduleType">
                            <option value="">All</option>
                            <option value="one-time">One-time</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>

                    <div class="form-group" id="filterDateGrp">
                        <label for="filterClassDate">Select Date for One-time:</label>
                        <input type="date" id="filterClassDate">
                    </div>

                    <div class="form-group" id="filterDowGrp">
                        <label>Days of Week:</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" class="filterDow" value="Monday"> Monday</label>
                            <label><input type="checkbox" class="filterDow" value="Tuesday"> Tuesday</label>
                            <label><input type="checkbox" class="filterDow" value="Wednesday"> Wednesday</label>
                            <label><input type="checkbox" class="filterDow" value="Thursday"> Thursday</label>
                            <label><input type="checkbox" class="filterDow" value="Friday"> Friday</label>
                            <label><input type="checkbox" class="filterDow" value="Saturday"> Saturday</label>
                            <label><input type="checkbox" class="filterDow" value="Sunday"> Sunday</label>
                        </div>
                    </div>

                    <div id="classesLoading" class="loading">Loading classes...</div>
                    <div id="classesList"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Success Modal -->
    <div id="updateSuccessPane" class="modal-pane">
        <div class="modal-content">
            <h2>Update Successful!</h2>
            <p id="updateEmailMsg">Trainer notified through email and class updates have been saved.</p>
            <button id="modalOkBtn" class="modal-ok-btn">OK, Great</button>
        </div>
    </div>

    <script>
        const SERVER_URL = 'http://localhost:8080';
        let trainersLookup = {};
        let classesData = [];
        let trainersOptionsHTML = '';

        document.addEventListener('DOMContentLoaded', async function() {
            setupSidebarAndSession();
            await checkServerConnection();
            await loadTrainers();
            await loadClasses();
            setupEventListeners();
        });

        // Simple logout function - same as admin-mainpage
        function setupSidebarAndSession() {
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.querySelector('.sidebar');
            const logoutBtn = document.getElementById('logoutBtn');
            const authUser = JSON.parse(localStorage.getItem('authUser'));

            menuToggle.addEventListener('click', () => sidebar.classList.toggle('collapsed'));

            if (!authUser || (Date.now() - authUser.timestamp > 3600000)) {
                localStorage.removeItem('authUser');
                window.location.href = '../admin-login.html';
                return;
            }

            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('authUser');
                window.location.href = '../admin-login.html';
            });

            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                    sidebar.classList.remove('collapsed');
                }
            });
        }

        function setupEventListeners() {
            document.getElementById('classSearch').addEventListener('input', filterAll);
            document.getElementById('scheduleType').addEventListener('change', function() {
                updateScheduleFilterUI();
                filterAll();
            });
            document.getElementById('filterClassDate').addEventListener('input', filterAll);
            document.querySelectorAll('.filterDow').forEach(cb => {
                cb.addEventListener('change', filterAll);
            });
            document.getElementById('modalOkBtn').addEventListener('click', function() {
                document.getElementById('updateSuccessPane').style.display = 'none';
            });
        }

        function updateScheduleFilterUI() {
            const type = document.getElementById('scheduleType').value;
            document.getElementById('filterDateGrp').style.display = type === "one-time" ? "block" : "none";
            document.getElementById('filterDowGrp').style.display = (type === "weekly" || type === "monthly") ? "block" : "none";
        }

        async function checkServerConnection() {
            const statusElement = document.getElementById('serverStatus');
            try {
                const response = await fetch(`${SERVER_URL}/health`);
                if (response.ok) {
                    statusElement.textContent = 'Connected to server successfully';
                    statusElement.className = 'server-status server-connected';
                } else {
                    throw new Error('Server response not OK');
                }
            } catch (error) {
                statusElement.textContent = 'Cannot connect to server. Please try again later.';
                statusElement.className = 'server-status server-disconnected';
            }
        }

        async function loadTrainers() {
            try {
                const response = await fetch(`${SERVER_URL}/api/trainers`);
                const result = await response.json();
                if (result.success && Array.isArray(result.data)) {
                    trainersLookup = {};
                    trainersOptionsHTML = result.data.map(tr => 
                        `<option value="${tr.trainer_id}">${tr.name}</option>`
                    ).join('');
                    result.data.forEach(tr => {
                        trainersLookup[tr.trainer_id] = { 
                            name: tr.name || "Unknown", 
                            specialization: tr.specialization || "" 
                        };
                    });
                }
            } catch (error) {
                console.error('Error loading trainers:', error);
                showMessage('Failed to load trainers', 'error');
            }
        }

        async function loadClasses() {
            const classesList = document.getElementById('classesList');
            const loading = document.getElementById('classesLoading');
            
            try {
                const response = await fetch(`${SERVER_URL}/api/classes`);
                const result = await response.json();
                
                if (result.success && Array.isArray(result.data)) {
                    classesData = result.data;
                    renderClasses(classesData);
                } else {
                    classesList.innerHTML = '<p class="no-data">No classes available</p>';
                }
            } catch (error) {
                console.error('Error loading classes:', error);
                classesList.innerHTML = '<p class="error">Error loading classes</p>';
                showMessage('Failed to load classes', 'error');
            } finally {
                loading.style.display = 'none';
            }
        }

        function filterAll() {
            const loading = document.getElementById('classesLoading');
            loading.style.display = 'none';
            
            const search = document.getElementById('classSearch').value.trim().toLowerCase();
            const scheduleType = document.getElementById('scheduleType').value;
            const date = document.getElementById('filterClassDate').value;
            const days = Array.from(document.querySelectorAll('.filterDow:checked')).map(cb => cb.value);

            let filtered = classesData.filter(cls => {
                let match = true;
                const trainer = trainersLookup[cls.trainer_id] || { name: '' };
                
                // Search filter
                if (search) {
                    match = (
                        (cls.class_name && cls.class_name.toLowerCase().includes(search)) ||
                        (cls.schedule && cls.schedule.toLowerCase().includes(search)) ||
                        (trainer.name && trainer.name.toLowerCase().includes(search))
                    );
                }
                
                // Schedule type filter
                if (scheduleType === "one-time" && !/^One-time/i.test(cls.schedule || "")) match = false;
                if (scheduleType === "weekly" && !/^Weekly/i.test(cls.schedule || "")) match = false;
                if (scheduleType === "monthly" && !/^Monthly/i.test(cls.schedule || "")) match = false;
                
                // Date filter for one-time classes
                if (scheduleType === "one-time" && date) {
                    const m = cls.schedule && cls.schedule.match(/^One-time\s+(\d{4}-\d{2}-\d{2})/);
                    if (!m || m[1] !== date) match = false;
                }
                
                // Days of week filter for weekly/monthly classes
                if ((scheduleType === "weekly" || scheduleType === "monthly") && days.length > 0) {
                    const m = cls.schedule && cls.schedule.match(/(?:Weekly|Monthly)\s+([A-Za-z,\s]+),/i);
                    if (!m) match = false;
                    else {
                        const schedDays = m[1].split(',').map(d => d.trim());
                        if (!days.every(day => schedDays.includes(day))) match = false;
                    }
                }
                
                return match;
            });
            
            renderClasses(filtered);
        }

        function renderClasses(classes) {
            const classesList = document.getElementById('classesList');
            classesList.innerHTML = '';
            
            if (!classes.length) {
                classesList.innerHTML = '<p class="no-data">No classes found</p>';
                return;
            }

            const weekDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            classes.forEach(cls => {
                const trainer = trainersLookup[cls.trainer_id] || { name: 'Unknown', specialization: 'N/A' };
                const cid = cls.class_id || cls._id;
                
                const details = document.createElement('details');
                details.innerHTML = `
                    <summary>
                        <strong>${cls.class_name}</strong> | Schedule: ${cls.schedule} | Trainer: ${trainer.name} | Enrollment: ${cls.current_enrollment || 0}/${cls.capacity}
                    </summary>
                    <div class="class-details">
                        <div class="trainer-info">
                            <h4>Trainer Details</h4>
                            <p><strong>Name:</strong> ${trainer.name}</p>
                            <p><strong>Specialization:</strong> ${trainer.specialization}</p>
                        </div>
                        <div class="edit-btn-row">
                            <button class="edit-btn" data-cid="${cid}">Edit Schedule</button>
                        </div>
                        <div class="edit-form"></div>
                    </div>
                `;
                classesList.appendChild(details);
            });

            // Add edit event listeners
            classesList.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const cid = btn.getAttribute('data-cid');
                    const editFormDiv = btn.closest('.class-details').querySelector('.edit-form');
                    editFormDiv.style.display = "block";
                    
                    const classObj = classesData.find(c => (c.class_id === cid || c._id === cid));
                    let trainerOptions = Object.entries(trainersLookup)
                        .map(([id, t]) => `<option value="${id}" ${id === classObj.trainer_id ? "selected" : ""}>${t.name}</option>`)
                        .join('');
                    
                    let schedType = "", schedDate = "", schedStart = "", schedEnd = "", weeklyDayArr = [];
                    
                    // Parse schedule
                    if (/^One-time/.test(classObj.schedule)) {
                        schedType = "one-time";
                        const m = classObj.schedule.match(/^One-time\s+(\d{4}-\d{2}-\d{2}),\s*(\d{1,2}:\d{2}\s*[AP]M)\s*-\s*(\d{1,2}:\d{2}\s*[AP]M)/);
                        if (m) { 
                            schedDate = m[1]; 
                            schedStart = to24h(m[2]); 
                            schedEnd = to24h(m[3]); 
                        }
                    }
                    
                    if (/^Weekly/.test(classObj.schedule)) {
                        schedType = "weekly";
                        const m = classObj.schedule.match(/^Weekly\s+([A-Za-z,\s]+),\s*(\d{1,2}:\d{2}\s*[AP]M)\s*-\s*(\d{1,2}:\d{2}\s*[AP]M)/i);
                        if (m) {
                            weeklyDayArr = m[1].split(',').map(v => v.trim());
                            schedStart = to24h(m[2]); 
                            schedEnd = to24h(m[3]);
                        }
                    }
                    
                    const weekChecks = weekDays.map(day =>
                        `<label><input type="checkbox" name="weekly_days" value="${day}" ${weeklyDayArr.includes(day) ? 'checked' : ''}> ${day}</label>`
                    ).join('');
                    
                    editFormDiv.innerHTML = `
                        <form class="actual-edit-form">
                            <div class="form-group">
                                <label>Trainer:</label>
                                <select name="trainer_id">${trainerOptions}</select>
                            </div>
                            
                            <div class="form-group">
                                <label>Schedule Type:</label>
                                <select name="scheduleType">
                                    <option value="">Select</option>
                                    <option value="one-time" ${schedType === "one-time" ? "selected" : ""}>One-time</option>
                                    <option value="weekly" ${schedType === "weekly" ? "selected" : ""}>Weekly</option>
                                </select>
                            </div>
                            
                            <div class="edit-one-time" style="display:${schedType === "one-time" ? "block" : "none"}">
                                <div class="form-group">
                                    <label>Date:</label>
                                    <input type="date" name="one_date" value="${schedDate}">
                                </div>
                                <div class="form-group">
                                    <label>Start Time:</label>
                                    <input type="time" name="one_start" value="${schedStart}">
                                </div>
                                <div class="form-group">
                                    <label>End Time:</label>
                                    <input type="time" name="one_end" value="${schedEnd}">
                                </div>
                            </div>
                            
                            <div class="edit-weekly" style="display:${schedType === "weekly" ? "block" : "none"}">
                                <div class="form-group">
                                    <label>Days of Week:</label>
                                    <div class="checkbox-group">${weekChecks}</div>
                                </div>
                                <div class="form-group">
                                    <label>Start Time:</label>
                                    <input type="time" name="weekly_start" value="${schedStart}">
                                </div>
                                <div class="form-group">
                                    <label>End Time:</label>
                                    <input type="time" name="weekly_end" value="${schedEnd}">
                                </div>
                            </div>
                            
                            <div class="edit-actions">
                                <button type="submit" class="action-button">Update Schedule</button>
                                <button type="button" class="cancel-edit">Cancel</button>
                            </div>
                            <div class="edit-status"></div>
                        </form>
                    `;
                    
                    const form = editFormDiv.querySelector('.actual-edit-form');
                    
                    // Show/hide schedule type sections
                    const showCorrect = () => {
                        form.querySelector('.edit-one-time').style.display = form.scheduleType.value === "one-time" ? "block" : "none";
                        form.querySelector('.edit-weekly').style.display = form.scheduleType.value === "weekly" ? "block" : "none";
                    };
                    
                    form.scheduleType.addEventListener('change', showCorrect);
                    
                    // Cancel button
                    form.querySelector('.cancel-edit').addEventListener('click', () => {
                        editFormDiv.style.display = 'none';
                    });
                    
                    // Form submission
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        form.querySelector(".edit-status").textContent = "Updating...";
                        
                        const trainer_id = form.trainer_id.value;
                        const scheduleType = form.scheduleType.value;
                        let schedule = classObj.schedule;
                        
                        if (scheduleType === "one-time") {
                            schedule = "One-time " + form.one_date.value + ", " +
                                timeFormat(form.one_start.value) + " - " + timeFormat(form.one_end.value);
                        } else if (scheduleType === "weekly") {
                            const dayVals = Array.from(form.querySelectorAll('input[name="weekly_days"]:checked'))
                                .map(d => d.value).join(', ');
                            schedule = "Weekly " + dayVals + ", " +
                                timeFormat(form.weekly_start.value) + " - " + timeFormat(form.weekly_end.value);
                        }
                        
                        try {
                            const response = await fetch(`${SERVER_URL}/api/classes/${cid}`, {
                                method: "PUT",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ trainer_id, schedule })
                            });
                            
                            const result = await response.json();
                            
                            if (result.success) {
                                document.getElementById("updateEmailMsg").textContent =
                                    (result.emailNotice && result.emailNotice.length)
                                        ? result.emailNotice.join(" ") + " Changes have been saved."
                                        : "Trainer notified through email and class updates have been saved.";
                                document.getElementById("updateSuccessPane").style.display = "flex";
                                
                                await loadClasses(); // Refresh class list
                                editFormDiv.style.display = 'none';
                                showMessage('Schedule updated successfully', 'success');
                            } else {
                                form.querySelector(".edit-status").textContent = result.error || "Update failed";
                                showMessage(result.error || 'Update failed', 'error');
                            }
                        } catch (error) {
                            console.error('Error updating class:', error);
                            form.querySelector(".edit-status").textContent = "Network error";
                            showMessage('Network error: ' + error.message, 'error');
                        }
                    });
                });
            });
        }

        // Utility functions
        function to24h(s) {
            if (!s) return "";
            let [hm, ampm] = s.split(/ /);
            if (!ampm) return hm;
            let [h, m] = hm.split(':');
            h = +h;
            if (ampm.toUpperCase().startsWith('P') && h < 12) h += 12;
            if (ampm.toUpperCase().startsWith('A') && h == 12) h = 0;
            return `${(h + '').padStart(2, '0')}:${m}`;
        }

        function timeFormat(str) {
            if (!str) return "";
            let [h, m] = str.split(':');
            h = +h;
            return (h % 12 || 12) + ":" + m + " " + (h >= 12 ? "PM" : "AM");
        }

        function showMessage(message, type) {
            const messageEl = type === 'success' ? 
                document.getElementById('successMessage') : 
                document.getElementById('errorMessage');
            
            messageEl.textContent = message;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        // Initialize filter UI
        updateScheduleFilterUI();
    </script>
</body>
</html>