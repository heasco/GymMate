<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trainer Dashboard - GOALS Gym</title>
    <link rel="stylesheet" href="../admin/admin-css/admin-mainpage.css">
    <link rel="stylesheet" href="./trainer-css/trainer-mainpage.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>GOALS Gym Trainer</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="trainer-mainpage.html"  class="active"><span>Dashboard</span></a>
                <a href="view-and-change-schedule.html"><span>My Classes & Schedule</span></a>
                <a href="trainer-profile-management.html"><span>Profile</span></a>
                <a href="view-classes-feedback.html"><span>Feedback</span></a>
            </nav>
        </aside>

        <!-- Header -->
        <header class="header">
            <button class="menu-toggle" id="menuToggle">☰</button>
            <h1>Trainer Dashboard</h1>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Greeting Section -->
            <div class="trainer-greeting">
                <h2>Welcome, <span id="trainerName">Trainer</span>!</h2>
                <div class="specialization" id="specialization"></div>
            </div>

            <!-- Dashboard Metrics -->
            <div class="dashboard-metrics" id="dashboardMetrics">
                <div style="display:flex;flex-wrap:wrap;gap:2.5em 1.5em;">
                    <div><strong>Weekly Attendance Total:</strong> <span class="attendance-badge high-badge">Loading...</span></div>
                    <div><strong>Most Attended Session:</strong> <span class="attendance-badge">Loading...</span></div>
                </div>
            </div>

            <!-- Classes and Attendance Section -->
            <div class="section">
                <h3>Your Classes and Attendance</h3>
                <div id="scheduleLoading" class="loading">Loading schedule...</div>
                <div id="trainerSchedule"></div>
            </div>
        </main>
    </div>

    <script>
        const API_URL = 'http://localhost:8080';

        // Get current week range
        function getCurrentWeekRange() {
            const now = new Date();
            const start = new Date(now);
            const end = new Date(now);
            const day = now.getDay() || 7;
            start.setDate(now.getDate() - day + 1);
            end.setDate(start.getDate() + 6);
            start.setHours(0, 0, 0, 0);
            end.setHours(23, 59, 59, 999);
            return { start, end };
        }

        // Calculate attendance streak
        function calcAttendanceStreak(dates) {
            if (dates.length === 0) return 0;
            let streak = 1, max = 1;
            dates.sort();
            for (let i = 1; i < dates.length; i++) {
                const d0 = new Date(dates[i - 1]);
                const d1 = new Date(dates[i]);
                if ((d1 - d0) === 86400000) {
                    streak++;
                    if (streak > max) max = streak;
                } else {
                    streak = 1;
                }
            }
            return max;
        }

        document.addEventListener('DOMContentLoaded', async function () {
            // ✅ SIDEBAR & AUTH SETUP
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.querySelector('.sidebar');
            const logoutBtn = document.getElementById('logoutBtn');
            const authUser = JSON.parse(localStorage.getItem('authUser'));

            // Check authentication
            if (!authUser || !authUser.user || authUser.role !== "trainer" || (Date.now() - authUser.timestamp > 3600000)) {
                localStorage.removeItem('authUser');
                window.location.href = '../trainer-login.html';
                return;
            }

            menuToggle.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('authUser');
                window.location.href = '../trainer-login.html';
            });

            // Display trainer info
            document.getElementById('trainerName').textContent = authUser.user.name;
            if (authUser.user.specialization) {
                document.getElementById('specialization').textContent = `Specialization: ${authUser.user.specialization}`;
            }

            const scheduleDiv = document.getElementById('trainerSchedule');
            const loading = document.getElementById('scheduleLoading');
            const metricsDiv = document.getElementById('dashboardMetrics');

            try {
                // Get trainer ID
                const trainerId = authUser.user.trainer_id || authUser.user.trainerid || authUser.user.id;

                // ✅ FETCH CLASSES FOR THIS TRAINER
                const resp = await fetch(`${API_URL}/api/classes`);
                if (!resp.ok) throw new Error(`Failed to fetch classes: ${resp.status}`);
                
                const data = await resp.json();
                const allFromApi = data.data || [];

                // Filter classes by trainer_id
                const classes = allFromApi.filter(c => {
                    const cid = c.trainer_id || c.trainerid || null;
                    return cid === trainerId;
                });

                loading.style.display = 'none';

                if (classes.length === 0) {
                    scheduleDiv.innerHTML = '<div class="no-classes">No assigned classes or schedule found.</div>';
                    metricsDiv.innerHTML = `<div style="display:flex;flex-wrap:wrap;gap:2.5em 1.5em;">
                        <div><strong>Weekly Attendance Total:</strong> <span class="attendance-badge high-badge">0</span></div>
                        <div><strong>Most Attended Session:</strong> <span class="attendance-badge">N/A</span></div>
                    </div>`;
                    return;
                }

                const { start: weekStart, end: weekEnd } = getCurrentWeekRange();
                let totalWeeklyAttendance = 0;
                let bestSession = null;
                let bestCount = 0;

                // ✅ FETCH ENROLLMENT DATA FOR EACH CLASS
                const classInfo = await Promise.all(classes.map(async c => {
                    const cid = c.class_id || c.classid || c._id;
                    let enrollments = [];

                    try {
                        const enrollResp = await fetch(`${API_URL}/api/classes/${cid}/enrollments`);
                        if (enrollResp.ok) {
                            const enroll = await enrollResp.json();
                            enrollments = enroll.data || [];
                        }
                    } catch (err) {
                        console.error('Error fetching enrollments:', err);
                    }

                    // Calculate attendance by date
                    const attendanceByDate = {};
                    let weeklyAttendance = 0;

                    enrollments.forEach(e => {
                        const status = (e.attendance_status || '').toLowerCase();
                        if (status !== 'attended') return;

                        const sessionDate = e.session_date;
                        const dateStr = sessionDate ? (new Date(sessionDate)).toISOString().slice(0, 10) : 'unknown';

                        if (!attendanceByDate[dateStr]) attendanceByDate[dateStr] = 0;
                        attendanceByDate[dateStr]++;

                        const dt = new Date(dateStr);
                        if (dt >= weekStart && dt <= weekEnd) weeklyAttendance++;
                    });

                    // Update totals
                    Object.entries(attendanceByDate).forEach(([dt, count]) => {
                        totalWeeklyAttendance += (new Date(dt) >= weekStart && new Date(dt) <= weekEnd) ? count : 0;
                        if (count > bestCount) {
                            bestCount = count;
                            bestSession = { class: c, date: dt, count };
                        }
                    });

                    const enrolled = enrollments.length || 0;
                    const capacity = c.capacity || '-';
                    const participationRate = enrolled ? Math.round(weeklyAttendance / enrolled * 100) : 0;
                    const datesAttended = Object.keys(attendanceByDate);
                    const streak = calcAttendanceStreak(datesAttended);
                    const lowAttendance = enrolled && c.capacity && ((enrolled / c.capacity) < 0.5);

                    return {
                        name: c.class_name || c.classname || 'Unnamed',
                        schedule: c.schedule || '',
                        capacity,
                        enrolled,
                        weeklyAttendance,
                        participationRate,
                        mostAttended: Object.entries(attendanceByDate).sort((a, b) => b[1] - a[1])[0] || null,
                        streak,
                        attendanceByDate,
                        lowAttendance
                    };
                }));

                // ✅ UPDATE DASHBOARD METRICS
                let dashHTML = `<div style="display:flex;flex-wrap:wrap;gap:2.5em 1.5em;">`;
                dashHTML += `<div><strong>Weekly Attendance Total:</strong> <span class="attendance-badge high-badge">${totalWeeklyAttendance}</span></div>`;
                dashHTML += `<div><strong>Most Attended Session:</strong> <span class="attendance-badge">${bestSession ? (bestSession.class.class_name || bestSession.class.classname) + " (" + bestSession.date + ") – " + bestSession.count + " attended" : "N/A"}</span></div>`;
                dashHTML += `</div>`;
                metricsDiv.innerHTML = dashHTML;

                // ✅ BUILD ATTENDANCE TABLE
                let html = `<table class="dashboard-table"><thead><tr>
                    <th>Class Name</th>
                    <th>Schedule</th>
                    <th>Capacity</th>
                    <th>Enrolled</th>
                    <th>Attendance<br>This Week</th>
                    <th>Participation<br>Rate (%)</th>
                    <th>Attendance<br>Streak</th>
                    <th>Attended By Date</th>
                </tr></thead><tbody>`;

                for (const c of classInfo) {
                    html += `<tr${c.lowAttendance ? ' style="background:#fdf6b2;color:#78350f;border-left:5px solid #eab308"' : ''}>
                        <td>${c.name}</td>
                        <td>${c.schedule}</td>
                        <td>${c.capacity}</td>
                        <td><b>${c.enrolled}</b> ${c.lowAttendance ? '<span class="attendance-badge low-badge">Low</span>' : ''}</td>
                        <td><span class="attendance-badge high-badge">${c.weeklyAttendance}</span></td>
                        <td><span class="attendance-badge">${c.participationRate}%</span></td>
                        <td><span class="attendance-badge streak-badge">${c.streak}</span></td>
                        <td>`;

                    html += Object.entries(c.attendanceByDate)
                        .sort((a, b) => b[0].localeCompare(a[0]))
                        .map(([date, count]) => `${date}: <b>${count}</b>`).join("<br>") || '<span style="color:#999">No attended sessions</span>';

                    html += `</td></tr>`;
                }

                html += "</tbody></table>";
                scheduleDiv.innerHTML = html;

            } catch (err) {
                console.error('Error loading dashboard:', err);
                loading.style.display = 'none';
                scheduleDiv.innerHTML = '<div class="error">Failed to load schedule. Check console for details.</div>';
            }
        });
    </script>
</body>
</html>
