<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Trainer Profile - GOALS Gym</title>
    <link rel="stylesheet" href="../admin/admin-css/admin-mainpage.css">
    <link rel="stylesheet" href="./trainer-css/trainer-profile-management.css">
</head>
<body>
<div class="admin-container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>GOALS Gym Trainer</h2>
        </div>
        <nav class="sidebar-nav">
        <a href="trainer-mainpage.html">Dashboard</a>
        <a href="view-and-change-schedule.html">My Classes & Schedule</a>
        <a href="trainer-profile-management.html" class="active">Profile</a>
        <a href="view-classes-feedback.html">Feedback</a>
        <a href="trainer-availability.html">Availability</a>
        </nav>
    </aside>
    <header class="header">
        <button class="menu-toggle" id="menuToggle">â˜°</button>
        <h1>Edit Profile</h1>
        <button class="logout-btn" id="logoutBtn">Logout</button>
    </header>
    <main class="main-content">
        <div class="container">
            <div class="profile-edit-card">
                <h2>Update Profile</h2>
                <form id="profileForm" autocomplete="off">
                    <div class="form-group">
                        <label for="username">Username (for login)</label>
                        <input type="text" id="username" name="username" required minlength="3">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email">
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone (+63XXXXXXXXXX)</label>
                        <input type="text" id="phone" name="phone" pattern="^\+63\d{10}$">
                    </div>
                    <div class="form-group">
                        <label for="currentPassword">Current Password</label>
                        <input type="password" id="currentPassword" required autocomplete="current-password">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input type="password" id="newPassword" name="newPassword" minlength="4">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" minlength="4">
                    </div>
                    <div class="form-buttons">
                        <button type="submit">Update Profile</button>
                    </div>
                    <div id="profileStatus" class="profile-status" style="display:none"></div>
                </form>
            </div>
        </div>
    </main>
</div>
<script>
const API_URL = 'http://localhost:8080';

document.addEventListener('DOMContentLoaded', async function() {
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.querySelector('.sidebar');
    const logoutBtn = document.getElementById('logoutBtn');
    const authUser = JSON.parse(localStorage.getItem('authUser'));

    if (!authUser || !authUser.user || authUser.role !== "trainer" || (Date.now() - authUser.timestamp > 3600000)) {
        localStorage.removeItem('authUser');
        window.location.href = '../trainer-login.html';
        return;
    }
    menuToggle.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
    logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('authUser');
        window.location.href = '../trainer-login.html';
    });

    // Populate current values
    document.getElementById('username').value = authUser.user.username || "";
    document.getElementById('email').value = authUser.user.email || "";
    document.getElementById('phone').value = authUser.user.phone || "";

    document.getElementById('profileForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        const statusDiv = document.getElementById('profileStatus');
        statusDiv.style.display = "none";

        const username = document.getElementById('username').value.trim();
        const email = document.getElementById('email').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const currentPassword = document.getElementById('currentPassword').value.trim();
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword && newPassword !== confirmPassword) {
            statusDiv.textContent = "New password and confirmation do not match.";
            statusDiv.className = "profile-status error";
            statusDiv.style.display = "block";
            return;
        }
        if (!currentPassword) {
            statusDiv.textContent = "Please enter your current password to update your profile.";
            statusDiv.className = "profile-status error";
            statusDiv.style.display = "block";
            return;
        }

        const payload = {
            trainer_id: authUser.user.trainerid || authUser.user.trainer_id || authUser.user.id,
            username,
            phone,
            email,
            currentPassword
        };
        if (newPassword) payload.newPassword = newPassword;

        try {
            const resp = await fetch(`${API_URL}/api/trainers/update-profile`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${localStorage.getItem('authToken') || ""}`
                },
                body: JSON.stringify(payload)
            });
            const data = await resp.json();
            if (!resp.ok || !data.success) {
                throw new Error(data.error || data.message || 'Failed to update profile.');
            }
            // Update local storage user info
            authUser.user.username = username;
            authUser.user.email = email;
            authUser.user.phone = phone;
            localStorage.setItem('authUser', JSON.stringify(authUser));
            statusDiv.textContent = "Profile updated successfully!";
            statusDiv.className = "profile-status success";
            statusDiv.style.display = "block";
            this.reset();
        } catch (err) {
            statusDiv.textContent = err.message;
            statusDiv.className = "profile-status error";
            statusDiv.style.display = "block";
        }
    });
});
</script>
</body>
</html>
