<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Trainer Profile - GOALS Gym</title>
    <link rel="stylesheet" href="../admin/admin-css/admin-mainpage.css">
    <link rel="stylesheet" href="./trainer-css/trainer-profile-management.css">
</head>
<body>
    <div class="admin-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>GOALS Gym Trainer</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="trainer-mainpage.html"><span>Dashboard</span></a>
                <a href="view-and-change-schedule.html"><span>My Classes & Schedule</span></a>
                <a href="trainer-profile-management.html" class="active"><span>Profile</span></a>
                <a href="view-classes-feedback.html"><span>Feedback</span></a>
            </nav>
        </aside>
        
        <header class="header">
            <button class="menu-toggle" id="menuToggle">â˜°</button>
            <h1>Edit Profile</h1>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </header>
        
        <main class="main-content">
            <div class="container">
                <div class="profile-edit-card">
                    <h2>Update Profile</h2>
                    <form id="profileForm" autocomplete="off">
                        <div class="form-group">
                            <label for="username">Username (for login)</label>
                            <input type="text" id="username" name="username" required minlength="3" placeholder="Loading...">
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email" placeholder="Loading...">
                            <small style="color: #666; font-size: 12px;">Optional - used for notifications</small>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone (+63XXXXXXXXXX)</label>
                            <input type="text" id="phone" name="phone" pattern="^\+63\d{10}$" placeholder="+63XXXXXXXXXX">
                            <small style="color: #666; font-size: 12px;">Optional - Philippine format</small>
                        </div>
                        
                        <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                        
                        <h3 style="color: #d32f2f; margin-bottom: 15px;">Change Password (Optional)</h3>
                        
                        <!-- âœ… CURRENT PASSWORD FIELD (FIRST) -->
                        <div class="form-group">
                            <label for="currentPassword">Current Password</label>
                            <input type="password" id="currentPassword" name="currentPassword" autocomplete="current-password" placeholder="Enter current password to change">
                            <small style="color: #666; font-size: 12px;">Required only if changing password</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <input type="password" id="newPassword" name="newPassword" minlength="6" autocomplete="new-password" placeholder="Enter new password">
                            <small style="color: #666; font-size: 12px;">Minimum 6 characters</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirmPassword">Confirm New Password</label>
                            <input type="password" id="confirmPassword" name="confirmPassword" minlength="6" autocomplete="new-password" placeholder="Re-enter new password">
                        </div>
                        
                        <div class="form-buttons">
                            <button type="submit" class="action-button">Update Profile</button>
                            <button type="button" class="cancel-button" onclick="resetForm()">Reset</button>
                        </div>
                        <div id="profileStatus" class="profile-status"></div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_URL = 'http://localhost:8080';
        let trainerId = null;
        let originalData = {};

        document.addEventListener('DOMContentLoaded', async function() {
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.querySelector('.sidebar');
            const logoutBtn = document.getElementById('logoutBtn');
            const authUser = JSON.parse(localStorage.getItem('authUser'));

            // âœ… AUTHENTICATION CHECK
            if (!authUser || !authUser.user || authUser.role !== "trainer" || (Date.now() - authUser.timestamp > 3600000)) {
                localStorage.removeItem('authUser');
                window.location.href = '../trainer-login.html';
                return;
            }
            
            menuToggle.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
            
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('authUser');
                window.location.href = '../trainer-login.html';
            });
            
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                    sidebar.classList.remove('collapsed');
                }
            });

            // âœ… GET TRAINER ID from localStorage with multiple fallbacks
            trainerId = authUser.user.trainer_id || authUser.user.trainerid || authUser.user.trainerId || authUser.user.id || authUser.user._id;
            
            if (!trainerId) {
                showMessage('Error: Unable to identify trainer', 'error');
                console.error('Auth user object:', authUser);
                return;
            }

            console.log('âœ… Trainer ID:', trainerId);

            // âœ… LOAD PROFILE DATA
            await loadProfile();

            // âœ… FORM SUBMISSION
            document.getElementById('profileForm').addEventListener('submit', handleSubmit);
        });

        // âœ… LOAD TRAINER PROFILE
        async function loadProfile() {
            try {
                console.log('ðŸ” Fetching trainer profile for ID:', trainerId);
                const response = await fetch(`${API_URL}/api/trainers/${trainerId}`);
                
                if (!response.ok) {
                    throw new Error(`Failed to load profile: ${response.status}`);
                }

                const data = await response.json();
                console.log('ðŸ“¦ API Response:', data);

                const trainer = data.data;

                if (!trainer) {
                    throw new Error('Trainer data not found');
                }

                // Store original data
                originalData = {
                    username: trainer.username || '',
                    email: trainer.email || '',
                    phone: trainer.phone || ''
                };

                // âœ… POPULATE FORM with current values
                document.getElementById('username').value = originalData.username;
                document.getElementById('email').value = originalData.email;
                document.getElementById('phone').value = originalData.phone;

                // Remove placeholder text
                document.getElementById('username').placeholder = 'Enter username';
                document.getElementById('email').placeholder = 'your.email@example.com';

                console.log('âœ… Profile loaded successfully:', originalData);

            } catch (err) {
                console.error('âŒ Error loading profile:', err);
                showMessage(`Failed to load profile: ${err.message}`, 'error');
            }
        }

        // âœ… HANDLE FORM SUBMISSION
        async function handleSubmit(event) {
            event.preventDefault();

            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // âœ… VALIDATE PASSWORD CHANGE (if any password field is filled)
            if (currentPassword || newPassword || confirmPassword) {
                // Check if all password fields are filled
                if (!currentPassword) {
                    showMessage("Current password is required to change password.", 'error');
                    return;
                }
                if (!newPassword) {
                    showMessage("New password is required.", 'error');
                    return;
                }
                if (!confirmPassword) {
                    showMessage("Please confirm your new password.", 'error');
                    return;
                }
                
                // Check if new passwords match
                if (newPassword !== confirmPassword) {
                    showMessage("New password and confirmation do not match.", 'error');
                    return;
                }
                
                // Check minimum length
                if (newPassword.length < 6) {
                    showMessage("New password must be at least 6 characters long.", 'error');
                    return;
                }
            }

            // âœ… CHECK IF ANY CHANGES WERE MADE
            const hasBasicChanges = username !== originalData.username || 
                                   email !== originalData.email || 
                                   phone !== originalData.phone;

            if (!hasBasicChanges && !newPassword) {
                showMessage('No changes to save', 'error');
                return;
            }

            try {
                showMessage('Updating profile...', 'info');

                // âœ… BUILD PAYLOAD
                const payload = {
                    trainer_id: trainerId,
                    username: username,
                    email: email,
                    phone: phone
                };

                if (currentPassword && newPassword) {
                    payload.currentPassword = currentPassword;
                    payload.newPassword = newPassword;
                }

                console.log('ðŸ“¤ Sending update:', payload);

                // âœ… CALL UPDATE-PROFILE ROUTE
                const response = await fetch(`${API_URL}/api/trainers/update-profile`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                console.log('ðŸ“¥ Update response:', result);

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to update profile');
                }

                // âœ… SUCCESS
                showMessage('âœ“ Profile updated successfully!', 'success');
                
                // Update localStorage with new values
                const authUser = JSON.parse(localStorage.getItem('authUser'));
                authUser.user.username = username;
                authUser.user.email = email;
                authUser.user.phone = phone;
                localStorage.setItem('authUser', JSON.stringify(authUser));
                
                // Clear ALL password fields
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                // Reload profile after 1 second
                setTimeout(() => {
                    loadProfile();
                }, 1000);

            } catch (err) {
                console.error('âŒ Error updating profile:', err);
                showMessage(`Error: ${err.message}`, 'error');
            }
        }

        // âœ… RESET FORM
        function resetForm() {
            document.getElementById('username').value = originalData.username;
            document.getElementById('email').value = originalData.email;
            document.getElementById('phone').value = originalData.phone;
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            showMessage('Form reset to original values', 'success');
        }

        // âœ… SHOW MESSAGE
        function showMessage(message, type) {
            const statusDiv = document.getElementById('profileStatus');
            statusDiv.textContent = message;
            statusDiv.className = `profile-status ${type}`;
            statusDiv.style.display = 'block';

            // Auto-hide after 5 seconds (except for info messages)
            setTimeout(() => {
                if (type !== 'info') {
                    statusDiv.style.display = 'none';
                }
            }, 5000);
        }
    </script>
</body>
</html>
