<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trainer Availability - GOALS Gym</title>
    <link rel="stylesheet" href="../admin/admin-css/admin-mainpage.css">
    <link rel="stylesheet" href="./trainer-css/trainer-availability.css">
</head>
<body>
    <div class="admin-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>GOALS Gym Trainer</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="trainer-mainpage.html"><span>Dashboard</span></a>
                <a href="view-and-change-schedule.html"><span>My Classes & Schedule</span></a>
                <a href="trainer-profile-management.html"><span>Profile</span></a>
                <a href="view-classes-feedback.html"><span>Feedback</span></a>
                <a href="trainer-availability.html" class="active"><span>Availability</span></a>
            </nav>
        </aside>

        <header class="header">
            <button class="menu-toggle" id="menuToggle">☰</button>
            <h1>Trainer Availability & Leave Management</h1>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </header>

        <main class="main-content">
            <div class="container">
                <section class="leave-section">
                    <h2>Mark Unavailability / Leave Days</h2>
                    <form id="leaveForm">
                        <div class="form-group">
                            <label for="leaveDate">Select Date:</label>
                            <input type="date" id="leaveDate" name="leaveDate" required>
                        </div>
                        <div class="form-group">
                            <label for="leaveReason">Reason (optional):</label>
                            <input type="text" id="leaveReason" name="leaveReason" placeholder="E.g. Sick, Personal, Vacation">
                        </div>
                        <button type="submit" class="action-button">Mark as Unavailable</button>
                        <div id="leaveStatus" class="form-status"></div>
                    </form>
                    <div class="leave-history">
                        <h3>Upcoming Unavailable Days</h3>
                        <ul id="leaveList"></ul>
                    </div>
                </section>

                <section class="current-availability">
                    <h2>Set Your Weekly Availability</h2>
                    <div class="schedule-instructions">
                        <p>Click once on a time slot to mark as <strong>Available</strong> (Green)</p>
                        <p>Click twice on a time slot to mark as <strong>Not Available</strong> (Red)</p>
                        <button id="clearSchedule" class="action-button secondary">Clear All Availability</button>
                    </div>
                    <div class="weekly-schedule">
                        <h3>Weekly Availability Schedule</h3>
                        <div class="schedule-table-container">
                            <table class="weekly-schedule-table">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Monday</th>
                                        <th>Tuesday</th>
                                        <th>Wednesday</th>
                                        <th>Thursday</th>
                                        <th>Friday</th>
                                        <th>Saturday</th>
                                        <th>Sunday</th>
                                    </tr>
                                </thead>
                                <tbody id="scheduleBody">
                                    <!-- Schedule will be generated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="availability-summary">
                        <h4>Availability Summary</h4>
                        <div id="summaryStats"></div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.querySelector('.sidebar');
            const logoutBtn = document.getElementById('logoutBtn');
            const authUser = JSON.parse(localStorage.getItem('authUser'));
            
            if (!authUser || !authUser.user || authUser.role !== "trainer" || (Date.now() - authUser.timestamp > 3600000)) {
                localStorage.removeItem('authUser');
                window.location.href = '../trainer-login.html';
                return;
            }
            
            menuToggle.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
            
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('authUser');
                window.location.href = '../trainer-login.html';
            });
            
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                    sidebar.classList.remove('collapsed');
                }
            });

            // Initialize schedule data
            let scheduleData = JSON.parse(localStorage.getItem('trainerSchedule')) || {};
            let leaveDays = JSON.parse(localStorage.getItem('trainerLeaveDays')) || [];

            // Generate empty schedule
            generateSchedule();
            loadLeaveHistory();
            updateSummary();

            // Clear schedule button
            document.getElementById('clearSchedule').addEventListener('click', function() {
                if (confirm('Are you sure you want to clear all availability?')) {
                    scheduleData = {};
                    localStorage.setItem('trainerSchedule', JSON.stringify(scheduleData));
                    generateSchedule();
                    updateSummary();
                }
            });

            // Leave form submission
            document.getElementById('leaveForm').addEventListener('submit', function(e) {
                e.preventDefault();
                markLeave();
            });

            function generateSchedule() {
                const scheduleBody = document.getElementById('scheduleBody');
                scheduleBody.innerHTML = '';
                
                const timeSlots = [
                    '6:00 AM', '7:00 AM', '8:00 AM', '9:00 AM', '10:00 AM', '11:00 AM',
                    '12:00 PM', '1:00 PM', '2:00 PM', '3:00 PM', '4:00 PM', '5:00 PM',
                    '6:00 PM', '7:00 PM', '8:00 PM', '9:00 PM'
                ];

                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

                timeSlots.forEach(time => {
                    const row = document.createElement('tr');
                    const timeCell = document.createElement('td');
                    timeCell.className = 'time-slot';
                    timeCell.textContent = time;
                    row.appendChild(timeCell);

                    days.forEach(day => {
                        const cell = document.createElement('td');
                        cell.className = 'schedule-slot';
                        cell.setAttribute('data-day', day);
                        cell.setAttribute('data-time', time);
                        
                        // Set initial state from saved data
                        const slotKey = `${day}_${time}`;
                        if (scheduleData[slotKey] === 'available') {
                            cell.className = 'schedule-slot available-slot';
                            cell.textContent = 'Available';
                        } else if (scheduleData[slotKey] === 'unavailable') {
                            cell.className = 'schedule-slot unavailable-slot';
                            cell.textContent = 'Not Available';
                        } else {
                            cell.className = 'schedule-slot empty-slot';
                            cell.textContent = 'Click to set';
                        }

                        // Add click handler
                        cell.addEventListener('click', function() {
                            handleSlotClick(this);
                        });
                        
                        row.appendChild(cell);
                    });

                    scheduleBody.appendChild(row);
                });
            }

            function handleSlotClick(cell) {
                const day = cell.getAttribute('data-day');
                const time = cell.getAttribute('data-time');
                const slotKey = `${day}_${time}`;
                
                // Toggle states: empty -> available -> unavailable -> empty
                if (cell.classList.contains('empty-slot')) {
                    // First click: set to available
                    cell.className = 'schedule-slot available-slot';
                    cell.textContent = 'Available';
                    scheduleData[slotKey] = 'available';
                } else if (cell.classList.contains('available-slot')) {
                    // Second click: set to unavailable
                    cell.className = 'schedule-slot unavailable-slot';
                    cell.textContent = 'Not Available';
                    scheduleData[slotKey] = 'unavailable';
                } else if (cell.classList.contains('unavailable-slot')) {
                    // Third click: set back to empty
                    cell.className = 'schedule-slot empty-slot';
                    cell.textContent = 'Click to set';
                    delete scheduleData[slotKey];
                }
                
                // Save to localStorage
                localStorage.setItem('trainerSchedule', JSON.stringify(scheduleData));
                updateSummary();
            }

            function markLeave() {
                const date = document.getElementById('leaveDate').value;
                const reason = document.getElementById('leaveReason').value;
                const status = document.getElementById('leaveStatus');
                
                if (date) {
                    if (!leaveDays.some(leave => leave.date === date)) {
                        leaveDays.push({ date, reason: reason || 'No reason provided' });
                        localStorage.setItem('trainerLeaveDays', JSON.stringify(leaveDays));
                        
                        status.textContent = "Successfully marked as unavailable!";
                        status.className = "form-status success";
                        document.getElementById('leaveForm').reset();
                        
                        loadLeaveHistory();
                    } else {
                        status.textContent = "This date is already marked as unavailable!";
                        status.className = "form-status error";
                    }
                }
            }

            function loadLeaveHistory() {
                const leaveList = document.getElementById('leaveList');
                leaveList.innerHTML = '';
                
                if (leaveDays.length === 0) {
                    leaveList.innerHTML = '<li>No upcoming unavailable days.</li>';
                    return;
                }
                
                leaveDays.forEach(leave => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        ${leave.date} (${leave.reason})
                        <button class="remove-leave" data-date="${leave.date}">×</button>
                    `;
                    leaveList.appendChild(li);
                });

                // Add remove event listeners
                document.querySelectorAll('.remove-leave').forEach(button => {
                    button.addEventListener('click', function() {
                        const dateToRemove = this.getAttribute('data-date');
                        leaveDays = leaveDays.filter(leave => leave.date !== dateToRemove);
                        localStorage.setItem('trainerLeaveDays', JSON.stringify(leaveDays));
                        loadLeaveHistory();
                    });
                });
            }

            function updateSummary() {
                const summaryStats = document.getElementById('summaryStats');
                const totalSlots = 7 * 16; // 7 days * 16 time slots
                const availableSlots = Object.values(scheduleData).filter(status => status === 'available').length;
                const unavailableSlots = Object.values(scheduleData).filter(status => status === 'unavailable').length;
                const emptySlots = totalSlots - availableSlots - unavailableSlots;
                
                summaryStats.innerHTML = `
                    <div class="stat-item">
                        <span class="stat-label">Available Slots:</span>
                        <span class="stat-value available">${availableSlots}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Unavailable Slots:</span>
                        <span class="stat-value unavailable">${unavailableSlots}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Not Set:</span>
                        <span class="stat-value empty">${emptySlots}</span>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>