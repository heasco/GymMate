<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Manage Profile - GOALS Gym</title>
<link rel="stylesheet" href="/style.css"/>
<style>
  :root{
    --nav-bg:#12335a;
    --nav-accent:#0b2a45;
    --card-head:#0e3b63;
    --muted:#9aa6b2;
    --accent:#f6b33a;
  }
  html,body {height:100%; margin:0; font-family: "Segoe UI", Roboto, system-ui, Arial; background:#f2f4f7; color:#222;}
  .app {display:flex; min-height:100vh; gap:18px;}
  .sidebar {
    width:240px;
    background:linear-gradient(180deg,var(--nav-bg),var(--nav-accent));
    color:#fff; padding:18px 12px;
    box-shadow: 2px 0 6px rgba(0,0,0,0.08);
  }
  .brand {display:flex; align-items:center; gap:10px; margin-bottom:18px;}
  .brand .logo {
    width:44px; height:44px; background:#fff2; border-radius:6px; display:flex;
    align-items:center; justify-content:center; font-weight:700; color:#fff; font-size:18px;
  }
  .brand h2 { font-size:18px; margin:0; letter-spacing:0.2px; }
  .nav { margin-top:12px; display:flex; flex-direction:column; gap:8px; }
  .nav a {
    color:rgba(255,255,255,0.95); text-decoration:none; padding:10px 12px; border-radius:6px; display:block; font-size:14px;
  }
  .nav a:hover { background:rgba(255,255,255,0.06);}
  .main { flex:1; padding:20px 28px;}
  .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;}
  .topbar h1 { margin:0; font-size:20px; color:#0e2740;}
  .card { background:#fff; border-radius:8px; box-shadow:0 1px 0 rgba(0,0,0,0.04); margin-bottom:18px; overflow:hidden; }
  .card .card-head { background:var(--card-head); color:#fff; padding:12px 16px; font-weight:700;}
  .card .card-body { padding:22px 18px 28px 18px; color:#223; }
  .field-group {margin-bottom:18px;}
  .field-group label { display:block; font-size:.97rem; color:#355; margin-bottom:2px;}
  .field-group input[type="text"], .field-group input[type="email"] {
    padding:8px; border-radius:6px; border:1px solid #cdd7df; width:100%; font-size:15px;
  }
  .btn { padding:8px 14px; border-radius:6px; border:1px solid #cdd7df; background:#fff; cursor:pointer; font-size:15px;}
  .btn-primary { background:var(--card-head); color:#fff; border-color:var(--card-head);}
  .btn:active{transform:translateY(1px)}
  .msg {margin-top:8px;}
  .msg.ok { color: #218838;}
  .msg.err { color: crimson;}
  @media (max-width:880px){
    .sidebar{display:none}
    .main{padding:14px}
  }
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar" aria-label="Left navigation">
    <div class="brand">
      <div class="logo">G</div>
      <div>
        <h2>GOALS Gym</h2>
        <div style="font-size:12px;opacity:0.9;">Member portal</div>
      </div>
    </div>
    <nav class="nav" role="navigation">
      <a href="./member-dashboard.html">Dashboard</a>
      <a href="./member-classes.html">Schedule</a>
      <a href="./manage-member-enrollment.html">Enroll</a>
      <a href="./manage-profile.html" style="background:rgba(255,255,255,0.06);">Profile</a>
      <a href="#" id="sidebarLogout">Logout</a>
    </nav>
  </aside>
  <main class="main">
    <div class="topbar">
      <h1>Manage Profile</h1>
    </div>
    <div class="card">
      <div class="card-head">Edit My Contact Details</div>
      <form id="profileForm" class="card-body" autocomplete="off">
        <div class="field-group">
          <label for="profileEmail">Email address</label>
          <input type="email" id="profileEmail" name="email" required autocomplete="email"/>
        </div>
        <div class="field-group">
          <label for="profilePhone">Phone</label>
          <input type="text" id="profilePhone" name="phone" required autocomplete="tel"/>
        </div>
        <button type="submit" class="btn btn-primary">Save changes</button>
        <div id="profileMsg" class="msg" style="display:none;"></div>
      </form>
    </div>
  </main>
</div>
<script>
const API_URL = 'http://localhost:8080';
const $ = id => document.getElementById(id);
function getAuth(){ try { return JSON.parse(localStorage.getItem('authUser') || 'null'); } catch(e){ return null; } }
function memberIdFromAuth(){ const a=getAuth(); if (!a||!a.user) return null; const u=a.user; return u.memberId||u.member_id||u._id||u.id||null; }
function logout(){ localStorage.removeItem('authUser'); window.location.href = './member-login.html'; }

document.addEventListener('DOMContentLoaded', () => {
  if ($('sidebarLogout')) $('sidebarLogout').addEventListener('click', e => { e.preventDefault(); logout(); });

  // Load current member info
  loadProfile();

  // Listen for update submit
  $('profileForm').addEventListener('submit', async function(ev){
    ev.preventDefault();
    updateProfile();
  });
});

async function loadProfile() {
  const memberId = memberIdFromAuth();
  if (!memberId) return logout();

  $('profileMsg').style.display = "none";
  try {
    const res = await fetch(`${API_URL}/api/members/${encodeURIComponent(memberId)}`);
    if (!res.ok) throw new Error("Failed to load member profile");
    const member = (await res.json()).data;
    $('profileEmail').value = member.email || '';
    $('profilePhone').value = member.phone || '';
  } catch (e) {
    $('profileMsg').className = "msg err";
    $('profileMsg').style.display = "";
    $('profileMsg').textContent = "Failed to load profile. Try re-logging in.";
  }
}

async function updateProfile() {
  const memberId = memberIdFromAuth();
  if (!memberId) return logout();

  const email = $('profileEmail').value.trim();
  const phone = $('profilePhone').value.trim();

  $('profileMsg').style.display = "none";
  try {
    const res = await fetch(`${API_URL}/api/members/${encodeURIComponent(memberId)}/profile`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, phone })
    });
    const js = await res.json();
    if (!res.ok) throw new Error(js.error || js.message || 'Update failed');

    // update localStorage with new data
    const auth = getAuth(); 
    if (auth && js.data) { auth.user = js.data; localStorage.setItem('authUser', JSON.stringify(auth)); }

    $('profileMsg').className = "msg ok"; 
    $('profileMsg').textContent = "Changes saved!"; 
    $('profileMsg').style.display = "";
  } catch (e) {
    $('profileMsg').className = "msg err";
    $('profileMsg').textContent = "Error: " + (e.message || 'Update failed');
    $('profileMsg').style.display = "";
  }
}
</script>
</body>
</html>
