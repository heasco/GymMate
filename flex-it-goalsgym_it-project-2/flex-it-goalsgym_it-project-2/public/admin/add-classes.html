<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Class - GOALS Gym</title>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.9/index.global.min.js'></script>
    <link rel="stylesheet" href="./admin-css/admin-mainpage.css">
    <link rel="stylesheet" href="./admin-css/add-classes.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>GOALS Gym Admin</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="./admin-mainpage.html"><span>Dashboard</span></a>
                <a href="./add-classes.html" class="active"><span>Add Classes</span></a>
                <a href="./add-member.html"><span>Add Member</span></a>
                <a href="./manage-members.html"><span>Manage Member</span></a>
                <a href="./add-trainer.html"><span>Add Trainer</span></a>
                <a href="./manage-trainer.html"><span>Manage Trainer</span></a>
                <a href="./manage-class-enrollment.html"><span>Manage Enrollment</span></a>
                <a href="./add-transaction.html"><span>Add Transaction</span></a>
                <a href="./view-classes-and-feedback.html"><span>View Classes</span></a>
                <a href="./trainer-schedule-management.html"><span>Trainer Schedule Management</span></a>
            </nav>
        </aside>

        <!-- Header -->
        <header class="header">
            <button class="menu-toggle" id="menuToggle">☰</button>
            <h1>Add Class</h1>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <div id="serverStatus" class="server-status">Checking server connection...</div>
                <div id="successMessage" class="success-message"></div>
                <div id="formSection" class="section active">
                    <h2>Add New Class</h2>
                    <form id="classForm">
                        <div class="form-group">
                            <label for="class_name">Class Name:</label>
                            <input type="text" id="class_name" name="class_name" required>
                        </div>
                        <div class="form-group">
                            <label for="description">Description:</label>
                            <textarea id="description" name="description" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="trainer_id">Trainer:</label>
                            <select id="trainer_id" name="trainer_id" required>
                                <option value="">Loading trainers...</option>
                            </select>
                            <div id="trainerError" class="error" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label for="capacity">Capacity:</label>
                            <input type="number" id="capacity" name="capacity" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="schedule_type">Schedule Type:</label>
                            <select id="schedule_type" name="schedule_type" required>
                                <option value="">Select schedule type</option>
                                <option value="one-time">One-time Class</option>
                                <option value="weekly">Weekly Recurring</option>
                                <option value="monthly">Monthly (4 weeks)</option>
                            </select>
                        </div>
                        <div id="oneTimeSchedule" class="section">
                            <div class="form-group">
                                <label for="class_date">Class Date:</label>
                                <input type="date" id="class_date" name="class_date">
                            </div>
                            <div class="form-group">
                                <label for="one_start_time">Start Time:</label>
                                <input type="time" id="one_start_time" name="one_start_time" min="06:00" max="22:00">
                            </div>
                            <div class="form-group">
                                <label for="one_end_time">End Time:</label>
                                <input type="time" id="one_end_time" name="one_end_time" min="06:00" max="22:00">
                            </div>
                        </div>
                        <div id="recurringSchedule" class="section">
                            <div class="form-group">
                                <label>Select Days of Week:</label>
                                <div class="checkbox-group">
                                    <label><input type="checkbox" name="days" value="Monday"> Monday</label>
                                    <label><input type="checkbox" name="days" value="Tuesday"> Tuesday</label>
                                    <label><input type="checkbox" name="days" value="Wednesday"> Wednesday</label>
                                    <label><input type="checkbox" name="days" value="Thursday"> Thursday</label>
                                    <label><input type="checkbox" name="days" value="Friday"> Friday</label>
                                    <label><input type="checkbox" name="days" value="Saturday"> Saturday</label>
                                    <label><input type="checkbox" name="days" value="Sunday"> Sunday</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="start_time">Start Time:</label>
                                <input type="time" id="start_time" name="start_time" min="06:00" max="22:00">
                            </div>
                            <div class="form-group">
                                <label for="end_time">End Time:</label>
                                <input type="time" id="end_time" name="end_time" min="06:00" max="22:00">
                            </div>
                            <div id="weeklyOptions" class="section">
                                <div class="form-group">
                                    <label for="start_date">Start Date:</label>
                                    <input type="date" id="start_date" name="start_date">
                                </div>
                                <div class="form-group">
                                    <label for="end_date">End Date (optional):</label>
                                    <input type="date" id="end_date" name="end_date">
                                </div>
                            </div>
                            <div id="monthlyOptions" class="section">
                                <div class="form-group">
                                    <label for="month_start">Month Start Date:</label>
                                    <input type="date" id="month_start" name="month_start">
                                </div>
                                <div class="form-group">
                                    <label for="week_of_month">Week of Month:</label>
                                    <select id="week_of_month" name="week_of_month">
                                        <option value="all">All weeks</option>
                                        <option value="1">First week only</option>
                                        <option value="2">Second week only</option>
                                        <option value="3">Third week only</option>
                                        <option value="4">Fourth week only</option>
                                        <option value="1,3">First and Third weeks</option>
                                        <option value="2,4">Second and Fourth weeks</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Schedule Preview:</label>
                            <div id="schedulePreview">Please select schedule type and complete the information above</div>
                            <input type="hidden" id="schedule" name="schedule" required>
                        </div>
                        <div class="nav-buttons">
                            <button type="submit">Add Class</button>
                            <button type="button" onclick="showScheduleView()">View Schedule Calendar</button>
                        </div>
                    </form>
                </div>
                <div id="scheduleViewSection" class="section">
                    <h2>Class Schedule Calendar</h2>
                    <div id="calendar"></div>
                    <div class="nav-buttons">
                        <button type="button" onclick="showFormView()">Back to Add Class</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
       <script>
        // Server configuration
        const SERVER_URL = 'http://localhost:8080';
        let calendar;
        let allClasses = [];

        // Check server connection on load
        document.addEventListener('DOMContentLoaded', async function() {
            await checkServerConnection();
            fetchTrainers();
            setupEventListeners();
            setMinimumDates();
        });

        // Check server connection
        async function checkServerConnection() {
            const statusElement = document.getElementById('serverStatus');
            try {
                const response = await fetch(`${SERVER_URL}/health`);
                if (response.ok) {
                    statusElement.textContent = 'Connected to server successfully';
                    statusElement.className = 'server-status server-connected';
                } else {
                    throw new Error('Server response not OK');
                }
            } catch (error) {
                statusElement.textContent = 'Cannot connect to server. Please try again later.';
                statusElement.className = 'server-status server-disconnected';
                console.error('Server connection error:', error);
            }
        }

        // Setup all event listeners
        function setupEventListeners() {
            // Schedule type change
            document.getElementById('schedule_type').addEventListener('change', toggleScheduleSection);
            
            // One-time schedule listeners
            document.getElementById('class_date').addEventListener('change', updateSchedulePreview);
            document.getElementById('one_start_time').addEventListener('change', updateSchedulePreview);
            document.getElementById('one_end_time').addEventListener('change', updateSchedulePreview);
            
            // Recurring schedule listeners
            document.querySelectorAll('input[name="days"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateSchedulePreview);
            });
            document.getElementById('start_time').addEventListener('change', updateSchedulePreview);
            document.getElementById('end_time').addEventListener('change', updateSchedulePreview);
            document.getElementById('start_date').addEventListener('change', updateSchedulePreview);
            document.getElementById('end_date').addEventListener('change', updateSchedulePreview);
            document.getElementById('month_start').addEventListener('change', updateSchedulePreview);
            document.getElementById('week_of_month').addEventListener('change', updateSchedulePreview);
            
            // Form submission
            document.getElementById('classForm').addEventListener('submit', handleFormSubmit);
        }

        // Set minimum dates to today
        function setMinimumDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('class_date').setAttribute('min', today);
            document.getElementById('start_date').setAttribute('min', today);
            document.getElementById('end_date').setAttribute('min', today);
            document.getElementById('month_start').setAttribute('min', today);
        }

        // Show/hide schedule sections based on type
        function toggleScheduleSection() {
            const scheduleType = document.getElementById('schedule_type').value;
            const oneTimeSchedule = document.getElementById('oneTimeSchedule');
            const recurringSchedule = document.getElementById('recurringSchedule');
            const weeklyOptions = document.getElementById('weeklyOptions');
            const monthlyOptions = document.getElementById('monthlyOptions');
            
            // Hide all sections first
            document.querySelectorAll('.section').forEach(section => {
                if (section.id !== 'formSection' && section.id !== 'scheduleViewSection') {
                    section.style.display = 'none';
                }
            });
            
            // Show relevant section
            if (scheduleType === 'one-time') {
                oneTimeSchedule.style.display = 'block';
            } else if (scheduleType === 'weekly') {
                recurringSchedule.style.display = 'block';
                weeklyOptions.style.display = 'block';
            } else if (scheduleType === 'monthly') {
                recurringSchedule.style.display = 'block';
                monthlyOptions.style.display = 'block';
            }
            
            updateSchedulePreview();
        }

        // Update schedule preview and hidden input
        function updateSchedulePreview() {
            const scheduleType = document.getElementById('schedule_type').value;
            const scheduleInput = document.getElementById('schedule');
            const schedulePreview = document.getElementById('schedulePreview');
            
            if (!scheduleType) {
                schedulePreview.textContent = 'Please select schedule type and complete the information above';
                scheduleInput.value = '';
                return;
            }
            
            // Format time helper function
            const formatTime = (time24) => {
                if (!time24) return '';
                const [hours, minutes] = time24.split(':');
                const hour12 = hours % 12 || 12;
                const ampm = hours < 12 ? 'AM' : 'PM';
                return `${hour12}:${minutes} ${ampm}`;
            };
            
            let scheduleText = '';
            
            if (scheduleType === 'one-time') {
                const date = document.getElementById('class_date').value;
                const startTime = document.getElementById('one_start_time').value;
                const endTime = document.getElementById('one_end_time').value;
                
                if (date && startTime && endTime) {
                    if (startTime >= endTime) {
                        schedulePreview.textContent = 'End time must be after start time';
                        scheduleInput.value = '';
                        return;
                    }
                    
                    const formattedDate = new Date(date).toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    const formattedStart = formatTime(startTime);
                    const formattedEnd = formatTime(endTime);
                    
                    scheduleText = `One-time: ${formattedDate}, ${formattedStart} - ${formattedEnd}`;
                }
            } else if (scheduleType === 'weekly' || scheduleType === 'monthly') {
                const selectedDays = Array.from(document.querySelectorAll('input[name="days"]:checked')).map(cb => cb.value);
                const startTime = document.getElementById('start_time').value;
                const endTime = document.getElementById('end_time').value;
                
                if (selectedDays.length > 0 && startTime && endTime) {
                    if (startTime >= endTime) {
                        schedulePreview.textContent = 'End time must be after start time';
                        scheduleInput.value = '';
                        return;
                    }
                    
                    const formattedStart = formatTime(startTime);
                    const formattedEnd = formatTime(endTime);
                    const daysText = selectedDays.join(', ');
                    
                    if (scheduleType === 'weekly') {
                        const startDate = document.getElementById('start_date').value;
                        const endDate = document.getElementById('end_date').value;
                        let dateRange = '';
                        
                        if (startDate) {
                            dateRange = ` (Starting ${new Date(startDate).toLocaleDateString()})`;
                            if (endDate) {
                                dateRange = ` (${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()})`;
                            }
                        }
                        
                        scheduleText = `Weekly: ${daysText}, ${formattedStart} - ${formattedEnd}${dateRange}`;
                    } else if (scheduleType === 'monthly') {
                        const monthStart = document.getElementById('month_start').value;
                        const weekOfMonth = document.getElementById('week_of_month').value;
                        let monthText = '';
                        
                        if (monthStart) {
                            const startDate = new Date(monthStart);
                            const endDate = new Date(startDate);
                            endDate.setDate(endDate.getDate() + 27); // 4 weeks
                            monthText = ` (${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()})`;
                        }
                        
                        let weekText = '';
                        if (weekOfMonth && weekOfMonth !== 'all') {
                            const weekMap = {
                                '1': 'First week only',
                                '2': 'Second week only', 
                                '3': 'Third week only',
                                '4': 'Fourth week only',
                                '1,3': 'First and Third weeks',
                                '2,4': 'Second and Fourth weeks'
                            };
                            weekText = ` - ${weekMap[weekOfMonth]}`;
                        }
                        
                        scheduleText = `Monthly (4 weeks): ${daysText}, ${formattedStart} - ${formattedEnd}${monthText}${weekText}`;
                    }
                }
            }
            
            if (scheduleText) {
                schedulePreview.textContent = scheduleText;
                scheduleInput.value = scheduleText;
            } else {
                schedulePreview.textContent = 'Please complete all required information';
                scheduleInput.value = '';
            }
        }

        // Function to fetch trainers and populate dropdown
        async function fetchTrainers() {
            const trainerSelect = document.getElementById('trainer_id');
            const errorDiv = document.getElementById('trainerError');
            
            trainerSelect.innerHTML = '<option value="">Loading trainers...</option>';
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch(`${SERVER_URL}/api/trainers`, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success && result.data && result.data.length > 0) {
                        trainerSelect.innerHTML = '<option value="">Select a trainer</option>';
                        
                        result.data.forEach(trainer => {
                            const option = document.createElement('option');
                            option.value = trainer.trainer_id;
                            option.textContent = `${trainer.name} (${trainer.specialization})`;
                            trainerSelect.appendChild(option);
                        });
                        
                        errorDiv.style.display = 'none';
                    } else {
                        trainerSelect.innerHTML = '<option value="">No trainers available</option>';
                        errorDiv.textContent = 'No trainers found in the system';
                        errorDiv.style.display = 'block';
                    }
                } else {
                    trainerSelect.innerHTML = '<option value="">Error loading trainers</option>';
                    errorDiv.textContent = `Server error: ${response.status} ${response.statusText}`;
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching trainers:', error);
                trainerSelect.innerHTML = '<option value="">Error loading trainers</option>';
                errorDiv.textContent = `Network error: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        }

        // Handle form submission
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const class_name = formData.get('class_name').trim();
            const description = formData.get('description').trim();
            const schedule = formData.get('schedule').trim();
            const trainer_id = formData.get('trainer_id');
            const capacity = parseInt(formData.get('capacity'));

            if (!trainer_id) {
                alert('Please select a trainer');
                return;
            }

            if (!schedule) {
                alert('Please complete the schedule information (day and times)');
                return;
            }

            const classData = {
                class_name: class_name,
                description: description,
                schedule: schedule,
                trainer_id: trainer_id,
                capacity: capacity
            };

            try {
                const response = await fetch(`${SERVER_URL}/api/classes`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                    },
                    body: JSON.stringify(classData)
                });

                const responseData = await response.json();
                
                if (response.ok) {
                    showSuccess('Class successfully added!');
                    document.getElementById('classForm').reset();
                    updateSchedulePreview(); // Reset schedule preview
                    fetchTrainers(); // Reload trainer dropdown
                    
                    // If calendar is loaded, refresh it
                    if (calendar) {
                        loadClassesIntoCalendar();
                    }
                } else {
                    console.error('Backend validation error:', responseData);
                    let errorMsg = 'Submission failed';
                    if (responseData.details) {
                        errorMsg += ':\n' + Object.entries(responseData.details)
                            .map(([field, error]) => `• ${field}: ${error}`)
                            .join('\n');
                    }
                    throw new Error(errorMsg);
                }
            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        }

        // Show success message
        function showSuccess(message) {
            const successElement = document.getElementById('successMessage');
            successElement.textContent = message;
            successElement.style.display = 'block';
            
            // Hide after 5 seconds
            setTimeout(() => {
                successElement.style.display = 'none';
            }, 5000);
        }

        // Toggle between form and schedule view
        function showScheduleView() {
            document.getElementById('formSection').classList.remove('active');
            document.getElementById('scheduleViewSection').classList.add('active');
            initCalendar();
        }

        function showFormView() {
            document.getElementById('scheduleViewSection').classList.remove('active');
            document.getElementById('formSection').classList.add('active');
        }

        // Initialize FullCalendar for schedule viewing
        function initCalendar() {
            if (calendar) {
                calendar.render();
                loadClassesIntoCalendar();
                return;
            }
            
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                height: 500,
                slotMinTime: '06:00:00',
                slotMaxTime: '22:00:00',
                slotDuration: '00:30:00',
                events: [],
                eventClick: function(info) {
                    alert(`Class: ${info.event.title}\nTrainer: ${info.event.extendedProps.trainer}\nCapacity: ${info.event.extendedProps.capacity}\nDescription: ${info.event.extendedProps.description || 'No description'}`);
                }
            });
            
            calendar.render();
            loadClassesIntoCalendar();
        }

        // Load all classes into calendar
        async function loadClassesIntoCalendar() {
            if (!calendar) return;
            
            try {
                const response = await fetch(`${SERVER_URL}/api/classes`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        allClasses = result.data;
                        calendar.removeAllEvents();
                        
                        // Convert classes to calendar events
                        const events = [];
                        
                        allClasses.forEach(classItem => {
                            const scheduleEvents = parseScheduleToEvents(classItem);
                            events.push(...scheduleEvents);
                        });
                        
                        calendar.addEventSource(events);
                    }
                }
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        // Parse schedule string to calendar events
        function parseScheduleToEvents(classItem) {
            const events = [];
            const schedule = classItem.schedule;
            const today = new Date();
            const twoMonthsFromNow = new Date();
            twoMonthsFromNow.setMonth(today.getMonth() + 2);
            
            if (schedule.startsWith('One-time:')) {
                // Parse one-time event
                const match = schedule.match(/One-time: (.+?), (\d{1,2}:\d{2} [AP]M) - (\d{1,2}:\d{2} [AP]M)/);
                if (match) {
                    const dateStr = match[1];
                    const startTime = match[2];
                    const endTime = match[3];
                    
                    const eventDate = new Date(dateStr);
                    const startDateTime = combineDateAndTime(eventDate, startTime);
                    const endDateTime = combineDateAndTime(eventDate, endTime);
                    
                    events.push({
                        title: classItem.class_name,
                        start: startDateTime,
                        end: endDateTime,
                        backgroundColor: getRandomColor(),
                        extendedProps: {
                            trainer: classItem.trainer_name || 'Unknown',
                            capacity: classItem.capacity,
                            description: classItem.description
                        }
                    });
                }
            } else if (schedule.startsWith('Weekly:') || schedule.startsWith('Monthly')) {
                // Parse recurring events
                const timeMatch = schedule.match(/(\d{1,2}:\d{2} [AP]M) - (\d{1,2}:\d{2} [AP]M)/);
                if (timeMatch) {
                    const startTime = timeMatch[1];
                    const endTime = timeMatch[2];
                    
                    // Extract days
                    let daysMatch;
                    if (schedule.startsWith('Weekly:')) {
                        daysMatch = schedule.match(/Weekly: (.+?), \d{1,2}:\d{2} [AP]M/);
                    } else {
                        daysMatch = schedule.match(/Monthly \(.*?\): (.+?), \d{1,2}:\d{2} [AP]M/);
                    }
                    
                    if (daysMatch) {
                        const daysStr = daysMatch[1];
                        const days = daysStr.split(', ').map(d => d.trim());
                        
                        // Generate recurring events for the next 2 months
                        const currentDate = new Date(today);
                        while (currentDate <= twoMonthsFromNow) {
                            const dayName = currentDate.toLocaleDateString('en-US', { weekday: 'long' });
                            
                            if (days.includes(dayName)) {
                                const startDateTime = combineDateAndTime(new Date(currentDate), startTime);
                                const endDateTime = combineDateAndTime(new Date(currentDate), endTime);
                                
                                events.push({
                                    title: classItem.class_name,
                                    start: startDateTime,
                                    end: endDateTime,
                                    backgroundColor: getRandomColor(),
                                    extendedProps: {
                                        trainer: classItem.trainer_name || 'Unknown',
                                        capacity: classItem.capacity,
                                        description: classItem.description
                                    }
                                });
                            }
                            
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                    }
                }
            }
            
            return events;
        }

        // Helper function to combine date and time
        function combineDateAndTime(date, timeStr) {
            const [time, period] = timeStr.split(' ');
            const [hours, minutes] = time.split(':');
            let hour24 = parseInt(hours);
            
            if (period === 'PM' && hour24 !== 12) {
                hour24 += 12;
            } else if (period === 'AM' && hour24 === 12) {
                hour24 = 0;
            }
            
            const result = new Date(date);
            result.setHours(hour24, parseInt(minutes), 0, 0);
            return result;
        }

        // Generate random colors for different classes
        function getRandomColor() {
            const colors = ['#3788d8', '#4CAF50', '#ff9800', '#e91e63', '#9c27b0', '#00bcd4', '#795548'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
    </script>
</body>
</html>
