<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View & Edit Classes - GOALS Gym</title>
    <link rel="stylesheet" href="./admin-css/admin-mainpage.css">
    <link rel="stylesheet" href="./admin-css/trainer-schedule-management.css">
</head>
<body>
    <div class="admin-container">
        <aside class="sidebar">
            <div class="sidebar-header"><h2>GOALS Gym Admin</h2></div>
            <nav class="sidebar-nav">
                <a href="./admin-mainpage.html"><span>Dashboard</span></a>
                <a href="./add-classes.html"><span>Add Classes</span></a>
                <a href="./add-member.html"><span>Add Member</span></a>
                <a href="./manage-members.html"><span>Manage Member</span></a>
                <a href="./add-trainer.html"><span>Add Trainer</span></a>
                <a href="./manage-trainer.html"><span>Manage Trainer</span></a>
                <a href="./manage-class-enrollment.html"><span>Manage Enrollment</span></a>
                <a href="./add-transaction.html"><span>Add Transaction</span></a>
                <a href="./view-classes-and-feedback.html"><span>View Classes</span></a>
                <a href="./trainer-schedule-management.html"  class="active"><span>Trainer Schedule Management</span></a>
            </nav>
        </aside>
        <header class="header">
            <button class="menu-toggle" id="menuToggle">â˜°</button>
            <h1>View & Edit Classes</h1>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </header>
        <main class="main-content">
            <div class="container">
                <h1>View Classes</h1>
                <div id="serverStatus" class="server-status">Checking server connection...</div>
                <div id="errorMessage" class="error hidden"></div>
                <div class="card section">
                    <h2>Classes List</h2>
                    <div class="form-group">
                        <label for="classSearch">Search Classes:</label>
                        <input type="text" id="classSearch" placeholder="Search by name, schedule, or trainer...">
                    </div>
                    <div class="form-group">
                        <label for="scheduleType">Schedule Type:</label>
                        <select id="scheduleType">
                            <option value="">All</option>
                            <option value="one-time">One-time</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="form-group" id="filterDateGrp" style="display:none;">
                        <label for="filterClassDate">Select Date for One-time:</label>
                        <input type="date" id="filterClassDate">
                    </div>
                    <div class="form-group" id="filterDowGrp" style="display:none;">
                        <label>Days of Week:</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" class="filterDow" value="Monday">Monday</label>
                            <label><input type="checkbox" class="filterDow" value="Tuesday">Tuesday</label>
                            <label><input type="checkbox" class="filterDow" value="Wednesday">Wednesday</label>
                            <label><input type="checkbox" class="filterDow" value="Thursday">Thursday</label>
                            <label><input type="checkbox" class="filterDow" value="Friday">Friday</label>
                            <label><input type="checkbox" class="filterDow" value="Saturday">Saturday</label>
                            <label><input type="checkbox" class="filterDow" value="Sunday">Sunday</label>
                        </div>
                    </div>
                    <div id="classesLoading" class="loading">Loading classes...</div>
                    <div id="classesList"></div>
                </div>
            </div>
        </main>
    </div>
    <div id="updateSuccessPane" class="modal-pane" style="display:none;">
  <div class="modal-content">
    <h2>Update Successful!</h2>
    <p id="updateEmailMsg">Trainer notified through email and class updates have been saved.</p>
    <button id="modalOkBtn" class="modal-ok-btn">OK, Great</button>
  </div>
</div>
<script>
const SERVER_URL = 'http://localhost:8080';
let trainersLookup = {};
let classesData = [];
let trainersOptionsHTML = '';

document.addEventListener('DOMContentLoaded', async function() {
    await checkServerConnection();
    await loadTrainers();
    await loadClasses();
    document.getElementById('classSearch').addEventListener('input', filterAll);
    document.getElementById('scheduleType').addEventListener('change', function() {
        updateScheduleFilterUI();
        filterAll();
    });
    document.getElementById('filterClassDate').addEventListener('input', filterAll);
    document.querySelectorAll('.filterDow').forEach(cb => {
        cb.addEventListener('change', filterAll);
    });
});

function updateScheduleFilterUI() {
    const type = document.getElementById('scheduleType').value;
    document.getElementById('filterDateGrp').style.display = type==="one-time" ? "block" : "none";
    document.getElementById('filterDowGrp').style.display = (type==="weekly" || type==="monthly") ? "block" : "none";
}

async function checkServerConnection() {
    const statusElement = document.getElementById('serverStatus');
    try {
        const response = await fetch(`${SERVER_URL}/health`);
        if (response.ok) {
            statusElement.textContent = 'Connected to server successfully';
            statusElement.className = 'server-status server-connected';
        } else throw new Error();
    } catch {
        statusElement.textContent = 'Cannot connect to server. Please try again later.';
        statusElement.className = 'server-status server-disconnected';
    }
}

async function loadTrainers() {
    try {
        const response = await fetch(`${SERVER_URL}/api/trainers`);
        const result = await response.json();
        if (result.success && Array.isArray(result.data)) {
            trainersLookup = {};
            trainersOptionsHTML = result.data.map(tr=>`<option value="${tr.trainer_id}">${tr.name}</option>`).join('');
            result.data.forEach(tr => {
                trainersLookup[tr.trainer_id] = { name: tr.name || "Unknown", specialization: tr.specialization || "" };
            });
        }
    } catch {}
}

async function loadClasses() {
    const classesList = document.getElementById('classesList');
    const loading = document.getElementById('classesLoading');
    try {
        const response = await fetch(`${SERVER_URL}/api/classes`);
        const result = await response.json();
        if (result.success && Array.isArray(result.data)) {
            classesData = result.data;
            renderClasses(classesData);
        } else {
            classesList.innerHTML = '<p>No classes available</p>';
        }
    } catch {
        classesList.innerHTML = '<p>Error loading classes</p>';
    } finally {
        loading.style.display = 'none';
    }
}

function filterAll() {
    const loading = document.getElementById('classesLoading');
    loading.style.display = 'none';
    const search = document.getElementById('classSearch').value.trim().toLowerCase();
    const scheduleType = document.getElementById('scheduleType').value;
    const date = document.getElementById('filterClassDate').value;
    const days = Array.from(document.querySelectorAll('.filterDow:checked')).map(cb => cb.value);

    let filtered = classesData.filter(cls=>{
        let match = true;
        const trainer = trainersLookup[cls.trainer_id] || { name: '' };
        if (search) match &&= (
            (cls.class_name && cls.class_name.toLowerCase().includes(search)) ||
            (cls.schedule && cls.schedule.toLowerCase().includes(search)) ||
            (trainer.name && trainer.name.toLowerCase().includes(search))
        );
        if (scheduleType === "one-time" && !/^One-time/i.test(cls.schedule || "")) match = false;
        if (scheduleType === "weekly" && !/^Weekly/i.test(cls.schedule || "")) match = false;
        if (scheduleType === "monthly" && !/^Monthly/i.test(cls.schedule || "")) match = false;
        if (scheduleType === "one-time" && date) {
            const m = cls.schedule && cls.schedule.match(/^One-time\s+(\d{4}-\d{2}-\d{2})/);
            if (!m || m[1] !== date) match = false;
        }
        if ((scheduleType === "weekly" || scheduleType === "monthly") && days.length > 0) {
            const m = cls.schedule && cls.schedule.match(/(?:Weekly|Monthly)\s+([A-Za-z,\s]+),/i);
            if (!m) match = false;
            else {
                const schedDays = m[1].split(',').map(d => d.trim());
                if(!days.every(day => schedDays.includes(day))) match = false;
            }
        }
        return match;
    });
    renderClasses(filtered);
}

function renderClasses(classes) {
    document.getElementById('classesLoading').style.display = 'none';
    const classesList = document.getElementById('classesList');
    classesList.innerHTML = '';
    if (!classes.length) {
        classesList.innerHTML = '<p>No classes found</p>';
        return;
    }
    const weekDays = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
    classes.forEach(cls => {
        const trainer = trainersLookup[cls.trainer_id] || { name: 'Unknown', specialization: 'N/A' };
        const cid = cls.class_id || cls._id;
        const details = document.createElement('details');
        details.innerHTML = `
            <summary>
                <strong>${cls.class_name}</strong> | <span>Schedule:</span> ${cls.schedule} | <span>Trainer:</span> ${trainer.name} | <span>Enrollment:</span> ${cls.current_enrollment}/${cls.capacity}
            </summary>
            <div class="class-details">
                <div class="trainer-info">
                    <h3>Trainer Details</h3>
                    <p><strong>Name:</strong> ${trainer.name}</p>
                    <p><strong>Specialization:</strong> ${trainer.specialization}</p>
                </div>
                <div class="edit-btn-row">
                    <button class="edit-btn" data-cid="${cid}">Edit</button>
                </div>
                <div class="edit-form" style="display:none"></div>
            </div>
        `;
        classesList.appendChild(details);
    });
    // --- Edit events ---
    classesList.querySelectorAll('.edit-btn').forEach(btn => {
        btn.onclick = async function() {
            const cid = btn.getAttribute('data-cid');
            const editFormDiv = btn.closest('.class-details').querySelector('.edit-form');
            editFormDiv.style.display = "block";
            const classObj = classesData.find(c => (c.class_id === cid || c._id === cid));
            let trainerOptions = Object.entries(trainersLookup)
                .map(([id, t])=>`<option value="${id}" ${id === classObj.trainer_id ? "selected" : ""}>${t.name}</option>`).join('');
            let schedType = "", schedDate="", schedStart="", schedEnd="", weeklyDayArr=[];
            if(/^One-time/.test(classObj.schedule)){
                schedType = "one-time";
                const m = classObj.schedule.match(/^One-time\s+(\d{4}-\d{2}-\d{2}),\s*(\d{1,2}:\d{2}\s*[AP]M)\s*-\s*(\d{1,2}:\d{2}\s*[AP]M)/);
                if(m){ schedDate=m[1]; schedStart=to24h(m[2]); schedEnd=to24h(m[3]); }
            }
            if(/^Weekly/.test(classObj.schedule)){
                schedType = "weekly";
                const m = classObj.schedule.match(/^Weekly\s+([A-Za-z,\s]+),\s*(\d{1,2}:\d{2}\s*[AP]M)\s*-\s*(\d{1,2}:\d{2}\s*[AP]M)/i);
                if(m){
                    weeklyDayArr = m[1].split(',').map(v=>v.trim());
                    schedStart=to24h(m[2]); schedEnd=to24h(m[3]);
                }
            }
            const weekChecks = weekDays.map(day=>
                `<label style="margin-right:13px;"><input type="checkbox" name="weekly_days" value="${day}"${weeklyDayArr.includes(day)?' checked':''}>${day}</label>`
            ).join('');
            editFormDiv.innerHTML = `
                <form class="actual-edit-form">
                    <label>Trainer:</label>
                    <select name="trainer_id">${trainerOptions}</select><br>
                    <label>Schedule Type:</label>
                    <select name="scheduleType">
                        <option value="">Select</option>
                        <option value="one-time"${schedType==="one-time"?" selected":""}>One-time</option>
                        <option value="weekly"${schedType==="weekly"?" selected":""}>Weekly</option>
                    </select>
                    <div class="edit-one-time" style="display:${schedType==="one-time"?"block":"none"}">
                        <label>Date: <input type="date" name="one_date" value="${schedDate}"></label>
                        <label>Start: <input type="time" name="one_start" value="${schedStart}"></label>
                        <label>End: <input type="time" name="one_end" value="${schedEnd}"></label>
                    </div>
                    <div class="edit-weekly" style="display:${schedType==="weekly"?"block":"none"}">
                        <div style="margin-bottom:10px;">${weekChecks}</div>
                        <label>Start: <input type="time" name="weekly_start" value="${schedStart}"></label>
                        <label>End: <input type="time" name="weekly_end" value="${schedEnd}"></label>
                    </div>
                    <div class="edit-actions">
                        <button type="submit">Update</button>
                        <button type="button" class="cancel-edit">Cancel</button>
                    </div>
                    <div class="edit-status"></div>
                </form>
            `;
            const form = editFormDiv.querySelector('.actual-edit-form');
            const showCorrect = ()=>{
                form.querySelector('.edit-one-time').style.display = form.scheduleType.value==="one-time" ? "block" : "none";
                form.querySelector('.edit-weekly').style.display = form.scheduleType.value==="weekly" ? "block" : "none";
            };
            form.scheduleType.addEventListener('change',showCorrect);
            form.querySelector('.cancel-edit').onclick = ()=>editFormDiv.style.display='none';
form.onsubmit = async e => {
  e.preventDefault();
  form.querySelector(".edit-status").textContent = "Updating...";
  let trainer_id = form.trainer_id.value;
  let scheduleType = form.scheduleType.value;
  let schedule = classObj.schedule;
  if (scheduleType === "one-time") {
    schedule = "One-time " + form.one_date.value + ", " +
      timeFormat(form.one_start.value) + " - " + timeFormat(form.one_end.value);
  } else if (scheduleType === "weekly") {
    const dayVals = Array.from(form.querySelectorAll('input[name="weekly_days"]:checked')).map(d => d.value).join(', ');
    schedule = "Weekly " + dayVals + ", " +
      timeFormat(form.weekly_start.value) + " - " + timeFormat(form.weekly_end.value);
  }
  const resp = await fetch(`${SERVER_URL}/api/classes/${cid}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ trainer_id, schedule })
  });
  const result = await resp.json();

  if (result.success) {
    // Show the modal pane
    document.getElementById("updateEmailMsg").textContent =
      (result.emailNotice && result.emailNotice.length)
        ? result.emailNotice.join(" ") + " Changes have been saved."
        : "Trainer notified through email and class updates have been saved.";
    document.getElementById("updateSuccessPane").style.display = "flex";
    await loadClasses(); // Refresh class list

    // Hide edit form & reset form UI
    editFormDiv.style.display = 'none';

    // OK button closes pane
    document.getElementById("modalOkBtn").onclick = function() {
      document.getElementById("updateSuccessPane").style.display = "none";
    };
  } else {
    form.querySelector(".edit-status").textContent = result.error || "Failed";
  }
};



        };
    });
}

function to24h(s) {
    if(!s)return "";
    let [hm,ampm]=s.split(/ /);if(!ampm)return hm;
    let [h,m]=hm.split(':');h=+h;if(ampm.toUpperCase().startsWith('P')&&h<12)h+=12;if(ampm.toUpperCase().startsWith('A')&&h==12)h=0;
    return `${(h+'').padStart(2,'0')}:${m}`;
}
function timeFormat(str) {
    if(!str)return "";
    let [h,m]=str.split(':');h=+h;
    return (h%12||12)+":"+m+" "+(h>=12?"PM":"AM");
}
</script>
</body>
</html>
