<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trainer - View Class Feedbacks - GOALS Gym</title>
    <link rel="stylesheet" href="../admin/admin-css/admin-mainpage.css">
    <link rel="stylesheet" href="./trainer-css/view-classes-feedback.css">
</head>
<body>
<div class="admin-container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>GOALS Gym Trainer</h2>
        </div>
        <nav class="sidebar-nav">
     <a href="trainer-mainpage.html">Dashboard</a>
        <a href="view-and-change-schedule.html">My Classes & Schedule</a>
        <a href="trainer-profile-management.html">Profile</a>
        <a href="view-classes-feedback.html" class="active">Feedback</a>
        <a href="trainer-availability.html">Availability</a>
        </nav>
    </aside>
    <header class="header">
        <button class="menu-toggle" id="menuToggle">â˜°</button>
        <h1>Class Feedbacks</h1>
        <button class="logout-btn" id="logoutBtn">Logout</button>
    </header>
    <main class="main-content">
        <div class="container">
            <div class="trainer-greeting">
                <h2>Welcome, <span id="trainerName">Trainer</span>!</h2>
            </div>
            <div class="filter-buttons">
                <button id="showAllBtn" class="active">All Classes</button>
                <button id="showMineBtn">All My Classes</button>
            </div>
            <div id="feedbackLoading" class="loading">Loading classes and feedback...</div>
            <div id="classesList"></div>
            <div class="feedback-rating-filter" style="margin:10px 0 22px 0;">
    <label for="ratingFilter" style="font-weight:bold;margin-right:8px;">Filter by Rating:</label>
    <select id="ratingFilter">
        <option value="">All Ratings</option>
        <option value="5">5 stars</option>
        <option value="4">4 stars</option>
        <option value="3">3 stars</option>
        <option value="2">2 stars</option>
        <option value="1">1 star</option>
    </select>
</div>

        </div>
    </main>
</div>
<script>
const SERVER_URL = 'http://localhost:8080';

let allClasses = [], trainerClasses = [];
let trainerId = null;
let currentFeedbackRatingFilter = "";

function updateTrainerName() {
    const authUser = JSON.parse(localStorage.getItem('authUser'));
    if (authUser && authUser.user && authUser.user.name)
        document.getElementById('trainerName').textContent = authUser.user.name;
}

// Renders classes/cards with feedbacks, filtering feedbacks by chosen rating
function renderClasses(classes) {
    const classesList = document.getElementById('classesList');
    if (!classes || classes.length === 0) {
        classesList.innerHTML = `<div class="no-classes">No classes found.</div>`;
        return;
    }
    let html = '';
    for (const cls of classes) {
        // Only render feedbacks matching filter if set
        let feedbacks = cls.feedbacks || [];
        if (currentFeedbackRatingFilter)
            feedbacks = feedbacks.filter(fb => String(fb.rating) === currentFeedbackRatingFilter);

        html += `<section class="class-card">
            <header>
                <h3>${cls.class_name}</h3>
                <div class="schedule">${cls.schedule || ""}</div>
                <div class="summary">Capacity: ${cls.capacity || '-'} | Enrolled: ${cls.current_enrollment || '-'}</div>
                <div class="trainer-label"><strong>Trainer:</strong> ${cls.trainer_name || cls.trainer_id || 'Unknown'}</div>
            </header>
            <div class="class-feedback-list">
                ${
                  feedbacks.length > 0
                  ? `<h4>Feedbacks (${feedbacks.length}):</h4>
                        <ul class="feedback-list">` +
                        feedbacks.map(fb =>
                        `<li>
                            <div><strong>Rating:</strong> ${fb.rating} / 5 &mdash; <strong>Comment:</strong> ${fb.comment || "(No comment)"}</div>
                            <div class="meta">
                                <span><strong>Date:</strong> ${new Date(fb.date_submitted).toLocaleString()}</span>
                            </div>
                        </li>`).join('')
                    + `</ul>`
                  : `<div class="no-feedbacks">No feedbacks${currentFeedbackRatingFilter ? " with this rating" : ""} yet for this class.</div>`
                }
            </div>
        </section>`;
    }
    classesList.innerHTML = html;
}

// Fetch classes and new feedbacks by class from `feedbacks.js` route
async function fetchClassesAndFeedbacks() {
    document.getElementById('feedbackLoading').style.display = "block";
    document.getElementById('classesList').innerHTML = "";
    const authUser = JSON.parse(localStorage.getItem('authUser'));
    trainerId = authUser.user.trainerid || authUser.user.trainer_id || authUser.user.id;

    const resp = await fetch(`${SERVER_URL}/api/classes`);
    let classes = [];
    if (resp.ok) {
        const data = await resp.json();
        classes = data.data || [];
    }

    // Use `/api/feedbacks/class/:class_id` for feedbacks
    await Promise.all(classes.map(async cls => {
        cls.isMine = (cls.trainer_id === trainerId);
        // This is the key change:
        const feedbackResp = await fetch(`${SERVER_URL}/api/feedbacks/class/${cls.class_id || cls._id}`);
        if (feedbackResp.ok) {
            const feedbackData = await feedbackResp.json();
            cls.feedbacks = feedbackData.data || [];
        } else {
            cls.feedbacks = [];
        }
    }));

    allClasses = classes;
    trainerClasses = classes.filter(cls => cls.isMine);
    document.getElementById('feedbackLoading').style.display = "none";
    renderClasses(allClasses);
}

document.addEventListener('DOMContentLoaded', () => {
    // Sidebar and logout logic
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.querySelector('.sidebar');
    const logoutBtn = document.getElementById('logoutBtn');
    const authUser = JSON.parse(localStorage.getItem('authUser'));
    if (!authUser || !authUser.user || authUser.role !== "trainer" || (Date.now() - authUser.timestamp > 3600000)) {
        localStorage.removeItem('authUser');
        window.location.href = '../trainer-login.html';
        return;
    }
    menuToggle.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
    logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('authUser');
        window.location.href = '../trainer-login.html';
    });
    updateTrainerName();

    document.getElementById('showAllBtn').addEventListener('click', function() {
        this.classList.add("active");
        document.getElementById('showMineBtn').classList.remove("active");
        renderClasses(allClasses);
    });
    document.getElementById('showMineBtn').addEventListener('click', function() {
        this.classList.add("active");
        document.getElementById('showAllBtn').classList.remove("active");
        renderClasses(trainerClasses);
    });

    // Feedback rating filter
    document.getElementById('ratingFilter').addEventListener('change', function() {
        currentFeedbackRatingFilter = this.value;
        // Figure out which currently selected set to display
        if (document.getElementById('showMineBtn').classList.contains('active'))
            renderClasses(trainerClasses);
        else
            renderClasses(allClasses);
    });

    fetchClassesAndFeedbacks();
});
</script>

</script>
</body>
</html>
