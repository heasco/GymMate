<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trainer Availability - GOALS Gym</title>
  <link rel="stylesheet" href="./trainer-css/trainer-availability.css">
</head>
<body>
  <div class="admin-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>GOALS Gym Trainer</h2>
      </div>
      <nav class="sidebar-nav">
        <a href="trainer-mainpage.html">Dashboard</a>
        <a href="view-and-change-schedule.html">My Classes & Schedule</a>
        <a href="trainer-profile-management.html">Profile</a>
        <a href="view-classes-feedback.html">Feedback</a>
        <a href="trainer-availability.html" class="active">Availability</a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header class="header">
        <button class="menu-toggle" id="menuToggle">â˜°</button>
        <h1>Trainer Availability & Leave Management</h1>
        <button class="logout-btn" id="logoutBtn">Logout</button>
      </header>

      <div class="container">
        <section class="availability-form-section">
          <h2>Set Weekly Availability</h2>
          <form id="availabilityForm">
            <div class="form-group">
              <label>Select Days & Time Blocks:</label>
              <div class="weekdays-blocks">
                <!-- Days and time blocks (morning/afternoon/evening) -->
                <div class="weekday-block" data-day="monday">
                  <span>Monday</span>
                  <label><input type="checkbox" name="monday[]" value="morning">Morning</label>
                  <label><input type="checkbox" name="monday[]" value="afternoon">Afternoon</label>
                  <label><input type="checkbox" name="monday[]" value="evening">Evening</label>
                </div>
                <div class="weekday-block" data-day="tuesday">
                  <span>Tuesday</span>
                  <label><input type="checkbox" name="tuesday[]" value="morning">Morning</label>
                  <label><input type="checkbox" name="tuesday[]" value="afternoon">Afternoon</label>
                  <label><input type="checkbox" name="tuesday[]" value="evening">Evening</label>
                </div>
                <div class="weekday-block" data-day="wednesday">
                  <span>Wednesday</span>
                  <label><input type="checkbox" name="wednesday[]" value="morning">Morning</label>
                  <label><input type="checkbox" name="wednesday[]" value="afternoon">Afternoon</label>
                  <label><input type="checkbox" name="wednesday[]" value="evening">Evening</label>
                </div>
                <div class="weekday-block" data-day="thursday">
                  <span>Thursday</span>
                  <label><input type="checkbox" name="thursday[]" value="morning">Morning</label>
                  <label><input type="checkbox" name="thursday[]" value="afternoon">Afternoon</label>
                  <label><input type="checkbox" name="thursday[]" value="evening">Evening</label>
                </div>
                <div class="weekday-block" data-day="friday">
                  <span>Friday</span>
                  <label><input type="checkbox" name="friday[]" value="morning">Morning</label>
                  <label><input type="checkbox" name="friday[]" value="afternoon">Afternoon</label>
                  <label><input type="checkbox" name="friday[]" value="evening">Evening</label>
                </div>
                <div class="weekday-block" data-day="saturday">
                  <span>Saturday</span>
                  <label><input type="checkbox" name="saturday[]" value="morning">Morning</label>
                  <label><input type="checkbox" name="saturday[]" value="afternoon">Afternoon</label>
                  <label><input type="checkbox" name="saturday[]" value="evening">Evening</label>
                </div>
                <div class="weekday-block" data-day="sunday">
                  <span>Sunday</span>
                  <label><input type="checkbox" name="sunday[]" value="morning">Morning</label>
                  <label><input type="checkbox" name="sunday[]" value="afternoon">Afternoon</label>
                  <label><input type="checkbox" name="sunday[]" value="evening">Evening</label>
                </div>
              </div>
            </div>
            <button type="submit">Save Availability</button>
            <div id="availabilityStatus" class="form-status"></div>
          </form>
        </section>

        <section class="leave-section">
          <h2>Mark Unavailability / Leave Days</h2>
          <form id="leaveForm">
            <label for="leaveDate">Select Date:</label>
            <input type="date" id="leaveDate" name="leaveDate" required>
            <label for="leaveReason">Reason (optional):</label>
            <input type="text" id="leaveReason" name="leaveReason" placeholder="E.g. Sick, Personal, Vacation">
            <button type="submit">Mark as Unavailable</button>
            <div id="leaveStatus" class="form-status"></div>
          </form>
          <div class="leave-history">
            <h3>Upcoming Unavailable Days</h3>
            <ul id="leaveList"></ul>
          </div>
        </section>

        <section class="current-availability">
          <h2>Current Availability & Schedule</h2>
          <div id="currentAvailability"></div>
          <div id="currentSchedule"></div>
        </section>
      </div>
    </main>
  </div>

  <script>
  // Use your backend API location here:
  const API_BASE = 'http://localhost:8080';

  document.addEventListener('DOMContentLoaded', async function () {
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.querySelector('.sidebar');
    const logoutBtn = document.getElementById('logoutBtn');
    const authUser = JSON.parse(localStorage.getItem('authUser'));

    // Robust trainerId extraction
    const trainerObj = authUser && authUser.user;
    const trainerId =
      (trainerObj && (trainerObj.trainerid || trainerObj.trainer_id || trainerObj.username || trainerObj.id))
      ? (trainerObj.trainerid || trainerObj.trainer_id || trainerObj.username || trainerObj.id)
      : null;

    if (
      !authUser ||
      !authUser.user ||
      authUser.role !== 'trainer' ||
      Date.now() - authUser.timestamp > 3600000 ||
      !trainerId
    ) {
      localStorage.removeItem('authUser');
      window.location.href = '../trainer-login.html';
      return;
    }

    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('authUser');
      window.location.href = '../trainer-login.html';
    });

    menuToggle.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
    });

    // === HELPER: Set form checkboxes to match availability object ===
    function setAvailabilityForm(availability) {
      document.querySelectorAll('.weekday-block').forEach(block => {
        const day = block.getAttribute('data-day');
        const checkedShifts = availability && availability[day] ? availability[day] : [];
        block.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.checked = checkedShifts.includes(cb.value);
        });
      });
    }

    // ===== AVAILABILITY FORM SUBMIT =====
    document.getElementById('availabilityForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const status = document.getElementById('availabilityStatus');
      status.textContent = '';
      const data = {};
      document.querySelectorAll('.weekday-block').forEach(block => {
        const day = block.getAttribute('data-day');
        data[day] = [];
        block.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
          data[day].push(cb.value);
        });
      });
      try {
        const resp = await fetch(`${API_BASE}/api/trainers/set-availability`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json'},
          body: JSON.stringify({
            availability: data,
            trainerid: trainerId
          })
        });
        const result = await resp.json();
        status.textContent = result.success ? "Availability saved!" : result.error || "Failed to save.";
        status.className = result.success ? "form-status success" : "form-status error";
      } catch (err) {
        status.textContent = "Network error.";
        status.className = "form-status error";
      }
    });

    // ===== LEAVE FORM SUBMIT =====
    document.getElementById('leaveForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const status = document.getElementById('leaveStatus');
      status.textContent = '';
      const date = document.getElementById('leaveDate').value;
      const reason = document.getElementById('leaveReason').value;
      try {
        const resp = await fetch(`${API_BASE}/api/trainers/mark-leave`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json'},
          body: JSON.stringify({
            date,
            reason,
            trainerid: trainerId
          })
        });
        const result = await resp.json();
        status.textContent = result.success ? "Marked as unavailable!" : result.error || "Failed to mark.";
        status.className = result.success ? "form-status success" : "form-status error";
        if(result.success) loadLeaveHistory();
      } catch (err) {
        status.textContent = "Network error.";
        status.className = "form-status error";
      }
    });

    // ===== LOAD LEAVE HISTORY =====
    async function loadLeaveHistory() {
      try {
        const resp = await fetch(`${API_BASE}/api/trainers/get-leave?trainerid=${encodeURIComponent(trainerId)}`);
        const result = await resp.json();
        const leaveList = document.getElementById('leaveList');
        leaveList.innerHTML = '';
        if(result.success && result.leaves.length) {
          result.leaves.forEach(leave => {
            const li = document.createElement('li');
            li.textContent = `${leave.date} (${leave.reason || 'No reason'})`;
            leaveList.appendChild(li);
          });
        } else {
          leaveList.innerHTML = '<li>No upcoming unavailable days.</li>';
        }
      } catch (err) {
        document.getElementById('leaveList').innerHTML = '<li>Error loading leave history.</li>';
      }
    }
    loadLeaveHistory();

    // ===== LOAD CURRENT AVAILABILITY =====
    async function loadCurrentAvailability() {
      try {
        const resp = await fetch(`${API_BASE}/api/trainers/get-availability?trainerid=${encodeURIComponent(trainerId)}`);
        const result = await resp.json();
        const div = document.getElementById('currentAvailability');
        div.innerHTML = '';
        if(result.success) {
          setAvailabilityForm(result.availability); // <-- Automatically set checkboxes
          Object.keys(result.availability).forEach(day => {
            div.innerHTML += `<div><strong>${day.charAt(0).toUpperCase() + day.slice(1)}: </strong>${result.availability[day].join(', ') || 'None'}</div>`;
          });
        } else {
          // If no custom availability, check all by default
          setAvailabilityForm({
            monday: ['morning','afternoon','evening'],
            tuesday: ['morning','afternoon','evening'],
            wednesday: ['morning','afternoon','evening'],
            thursday: ['morning','afternoon','evening'],
            friday: ['morning','afternoon','evening'],
            saturday: ['morning','afternoon','evening'],
            sunday: ['morning','afternoon','evening']
          });
          div.textContent = "No availability set.";
        }
      } catch (err) {
        setAvailabilityForm({
          monday: ['morning','afternoon','evening'],
          tuesday: ['morning','afternoon','evening'],
          wednesday: ['morning','afternoon','evening'],
          thursday: ['morning','afternoon','evening'],
          friday: ['morning','afternoon','evening'],
          saturday: ['morning','afternoon','evening'],
          sunday: ['morning','afternoon','evening']
        });
        document.getElementById('currentAvailability').textContent = "Error loading current availability.";
      }
    }
    loadCurrentAvailability();


// ===== LOAD CURRENT SCHEDULE (only this trainer) =====
async function loadCurrentSchedule() {
  const div = document.getElementById('currentSchedule');
  div.innerHTML = '<h3>My Classes</h3>';

  try {
    const resp = await fetch(`${API_BASE}/api/classes?trainerid=${encodeURIComponent(trainerId)}`);
    if (!resp.ok) {
      div.innerHTML += '<p>Error loading classes.</p>';
      return;
    }

    const result = await resp.json();
    const allFromApi = Array.isArray(result?.data) ? result.data : [];

    // Defensive client-side filter in case the backend ever returns more than requested
    const myClasses = allFromApi.filter(c => {
      const cid = c.trainer_id || c.trainerid || null;
      return cid === trainerId;
    });

    if (myClasses.length === 0) {
      div.innerHTML += '<p>No classes assigned to you.</p>';
      return;
    }

    const items = myClasses.map(c => {
      const name = c.class_name || c.classname || 'Unnamed Class';
      const sched = c.schedule || '';
      return `<li>${name} - ${sched}</li>`;
    }).join('');

    div.innerHTML += `<ul>${items}</ul>`;
  } catch (err) {
    div.innerHTML = '<h3>My Classes</h3><p>Error loading schedule.</p>';
  }
}

    loadCurrentSchedule();
  });
</script>

</body>
</html>
